<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.0.preview.7">
<meta name="author" content="Mark Pollack, Thomas Risberg, Oliver Gierke, Costin Leau, Jon Brisbin, Thomas Darimont, Christoph Strobl">
<title>Spring Data MongoDB - Reference Documentation</title>
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }
audio, canvas, video { display: inline-block; }
audio:not([controls]) { display: none; height: 0; }
[hidden], template { display: none; }
script { display: none !important; }
html { font-family: sans-serif; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%; }
body { margin: 0; }
a { background: transparent; }
a:focus { outline: thin dotted; }
a:active, a:hover { outline: 0; }
h1 { font-size: 2em; margin: 0.67em 0; }
abbr[title] { border-bottom: 1px dotted; }
b, strong { font-weight: bold; }
dfn { font-style: italic; }
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }
mark { background: #ff0; color: #000; }
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }
pre { white-space: pre-wrap; }
q { quotes: "\201C" "\201D" "\2018" "\2019"; }
small { font-size: 80%; }
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }
sup { top: -0.5em; }
sub { bottom: -0.25em; }
img { border: 0; }
svg:not(:root) { overflow: hidden; }
figure { margin: 0; }
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }
legend { border: 0; padding: 0; }
button, input, select, textarea { font-family: inherit; font-size: 100%; margin: 0; }
button, input { line-height: normal; }
button, select { text-transform: none; }
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; cursor: pointer; }
button[disabled], html input[disabled] { cursor: default; }
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; padding: 0; }
input[type="search"] { -webkit-appearance: textfield; -moz-box-sizing: content-box; -webkit-box-sizing: content-box; box-sizing: content-box; }
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }
textarea { overflow: auto; vertical-align: top; }
table { border-collapse: collapse; border-spacing: 0; }
meta.foundation-mq-small { font-family: "only screen and (min-width: 768px)"; width: 768px; }
meta.foundation-mq-medium { font-family: "only screen and (min-width:1280px)"; width: 1280px; }
meta.foundation-mq-large { font-family: "only screen and (min-width:1440px)"; width: 1440px; }
*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }
html, body { font-size: 100%; }
body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }
a:hover { cursor: pointer; }
img, object, embed { max-width: 100%; height: auto; }
object, embed { height: 100%; }
img { -ms-interpolation-mode: bicubic; }
#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }
.left { float: left !important; }
.right { float: right !important; }
.text-left { text-align: left !important; }
.text-right { text-align: right !important; }
.text-center { text-align: center !important; }
.text-justify { text-align: justify !important; }
.hide { display: none; }
.antialiased, body { -webkit-font-smoothing: antialiased; }
img { display: inline-block; vertical-align: middle; }
textarea { height: auto; min-height: 50px; }
select { width: 100%; }
p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }
.subheader, #content #toctitle, .admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .mathblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title, .tableblock > caption { line-height: 1.4; color: #7a2518; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }
a { color: #005498; text-decoration: underline; line-height: inherit; }
a:hover, a:focus { color: #00467f; }
a img { border: none; }
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.6; margin-bottom: 1.25em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: Georgia, "URW Bookman L", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; color: #ba3925; text-rendering: optimizeLegibility; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #e99b8f; line-height: 0; }
h1 { font-size: 2.125em; }
h2 { font-size: 1.6875em; }
h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }
h4 { font-size: 1.125em; }
h5 { font-size: 1.125em; }
h6 { font-size: 1em; }
hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }
em, i { font-style: italic; line-height: inherit; }
strong, b { font-weight: bold; line-height: inherit; }
small { font-size: 60%; line-height: inherit; }
code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: normal; color: #6d180b; }
ul, ol, dl { font-size: 1em; line-height: 1.6; margin-bottom: 1.25em; list-style-position: outside; font-family: inherit; }
ul, ol { margin-left: 1.5em; }
ul.no-bullet, ol.no-bullet { margin-left: 1.5em; }
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }
dl dt { margin-bottom: 0.3125em; font-weight: bold; }
dl dd { margin-bottom: 1.25em; }
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #222222; border-bottom: 1px dotted #dddddd; cursor: help; }
abbr { text-transform: none; }
blockquote { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: inherit; color: #555555; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #555555; }
blockquote, blockquote p { line-height: 1.6; color: #6f6f6f; }
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }
.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }
@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }
.print-only { display: none !important; }
@media print { * { background: transparent !important; color: #000 !important; box-shadow: none !important; text-shadow: none !important; }
  a, a:visited { text-decoration: underline; }
  a[href]:after { content: " (" attr(href) ")"; }
  abbr[title]:after { content: " (" attr(title) ")"; }
  .ir a:after, a[href^="javascript:"]:after, a[href^="#"]:after { content: ""; }
  pre, blockquote { border: 1px solid #999; page-break-inside: avoid; }
  thead { display: table-header-group; }
  tr, img { page-break-inside: avoid; }
  img { max-width: 100% !important; }
  @page { margin: 0.5cm; }
  p, h2, h3, #toctitle, .sidebarblock > .content > .title { orphans: 3; widows: 3; }
  h2, h3, #toctitle, .sidebarblock > .content > .title { page-break-after: avoid; }
  .hide-on-print { display: none !important; }
  .print-only { display: block !important; }
  .hide-for-print { display: none !important; }
  .show-for-print { display: inherit !important; } }
table { background: white; margin-bottom: 1.25em; border: solid 1px #dddddd; }
table thead, table tfoot { background: whitesmoke; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: #222222; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #222222; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.6; }
.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }
*:not(pre) > code { font-size: 0.9375em; padding: 1px 3px 0; white-space: nowrap; background-color: #f2f2f2; border: 1px solid #cccccc; -webkit-border-radius: 4px; border-radius: 4px; text-shadow: none; }
pre, pre > code { line-height: 1.4; color: inherit; font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: normal; }
.keyseq { color: #555555; }
kbd:not(.keyseq) { display: inline-block; color: #222222; font-size: 0.75em; line-height: 1.4; background-color: #F7F7F7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }
.keyseq kbd:first-child { margin-left: 0; }
.keyseq kbd:last-child { margin-right: 0; }
.menuseq, .menu { color: #090909; }
b.button:before, b.button:after { position: relative; top: -1px; font-weight: normal; }
b.button:before { content: "["; padding: 0 3px 0 2px; }
b.button:after { content: "]"; padding: 0 2px 0 3px; }
p a > code:hover { color: #561309; }
#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 0.9375em; padding-right: 0.9375em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }
#header { margin-bottom: 2.5em; }
#header > h1 { color: black; font-weight: normal; border-bottom: 1px solid #dddddd; margin-bottom: -28px; padding-bottom: 32px; }
#header span { color: #6f6f6f; }
#header #revnumber { text-transform: capitalize; }
#header br { display: none; }
#header br + span { padding-left: 3px; }
#header br + span:before { content: "\2013 \0020"; }
#header br + span.author { padding-left: 0; }
#header br + span.author:before { content: ", "; }
#toc { border-bottom: 3px double #ebebeb; padding-bottom: 1.25em; }
#toc > ul { margin-left: 0.25em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
#toc ul { list-style-type: none; }
#toctitle { color: #7a2518; }
@media only screen and (min-width: 768px) { body.toc2 { padding-left: 15em; padding-right: 0; }
  #toc.toc2 { position: fixed; width: 15em; left: 0; top: 0; border-right: 1px solid #ebebeb; border-bottom: 0; z-index: 1000; padding: 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; font-size: 1.2em; }
  #toc.toc2 > ul { font-size: .90em; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 15em; }
  body.toc2.toc-right #toc.toc2 { border-right: 0; border-left: 1px solid #ebebeb; left: auto; right: 0; } }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; padding-right: 0; }
  #toc.toc2 { width: 20em; }
  #toc.toc2 #toctitle { font-size: 1.375em; }
  #toc.toc2 > ul { font-size: 0.95em; }
  #toc.toc2 ul ul { padding-left: 1.25em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; border-width: 0; -webkit-border-radius: 4px; border-radius: 4px; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }
#content #toc a { text-decoration: none; }
#content #toctitle { font-weight: bold; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-size: 1em; padding-left: 0.125em; }
#footer { max-width: 100%; background-color: #222222; padding: 1.25em; }
#footer-text { color: #dddddd; line-height: 1.44; }
.sect1 { padding-bottom: 1.25em; }
.sect1 + .sect1 { border-top: 3px double #ebebeb; }
#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; width: 1em; margin-left: -1em; display: block; text-decoration: none; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: '\00A7'; font-size: .85em; vertical-align: text-top; display: block; margin-top: 0.05em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #ba3925; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #a53221; }
.imageblock, .literalblock, .listingblock, .mathblock, .verseblock, .videoblock { margin-bottom: 1.25em; }
.admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .mathblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-align: left; font-weight: bold; }
.tableblock > caption { text-align: left; font-weight: bold; white-space: nowrap; overflow: visible; max-width: 0; }
table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }
.admonitionblock > table { border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #6f6f6f; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }
.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 4px; border-radius: 4px; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6, .exampleblock > .content p { color: #333333; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6 { line-height: 1; margin-bottom: 0.625em; }
.exampleblock > .content h1.subheader, .exampleblock > .content h2.subheader, .exampleblock > .content h3.subheader, .exampleblock > .content .subheader#toctitle, .sidebarblock.exampleblock > .content > .subheader.title, .exampleblock > .content h4.subheader, .exampleblock > .content h5.subheader, .exampleblock > .content h6.subheader { line-height: 1.4; }
.exampleblock.result > .content { -webkit-box-shadow: 0 1px 8px #d9d9d9; box-shadow: 0 1px 8px #d9d9d9; }
.sidebarblock { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 4px; border-radius: 4px; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6, .sidebarblock p { color: #333333; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6 { line-height: 1; margin-bottom: 0.625em; }
.sidebarblock h1.subheader, .sidebarblock h2.subheader, .sidebarblock h3.subheader, .sidebarblock .subheader#toctitle, .sidebarblock > .content > .subheader.title, .sidebarblock h4.subheader, .sidebarblock h5.subheader, .sidebarblock h6.subheader { line-height: 1.4; }
.sidebarblock > .content > .title { color: #7a2518; margin-top: 0; line-height: 1.6; }
.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }
.literalblock pre:not([class]), .listingblock pre:not([class]) { background: none; }
.literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { border-width: 1px 0; border-style: dotted; border-color: #bfbfbf; -webkit-border-radius: 4px; border-radius: 4px; padding: 0.75em 0.75em 0.5em 0.75em; word-wrap: break-word; }
.literalblock pre.nowrap, .literalblock pre[class].nowrap, .listingblock pre.nowrap, .listingblock pre[class].nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
.literalblock pre > code, .literalblock pre[class] > code, .listingblock pre > code, .listingblock pre[class] > code { display: block; }
@media only screen { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.8em; } }
@media only screen and (min-width: 768px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.9em; } }
@media only screen and (min-width: 1280px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 1em; } }
.listingblock pre.highlight { padding: 0; }
.listingblock pre.highlight > code { padding: 0.75em 0.75em 0.5em 0.75em; }
.listingblock > .content { position: relative; }
.listingblock:hover code[class*=" language-"]:before { text-transform: uppercase; font-size: 0.9em; color: #999; position: absolute; top: 0.375em; right: 0.375em; }
.listingblock:hover code.asciidoc:before { content: "asciidoc"; }
.listingblock:hover code.clojure:before { content: "clojure"; }
.listingblock:hover code.css:before { content: "css"; }
.listingblock:hover code.groovy:before { content: "groovy"; }
.listingblock:hover code.html:before { content: "html"; }
.listingblock:hover code.java:before { content: "java"; }
.listingblock:hover code.javascript:before { content: "javascript"; }
.listingblock:hover code.python:before { content: "python"; }
.listingblock:hover code.ruby:before { content: "ruby"; }
.listingblock:hover code.sass:before { content: "sass"; }
.listingblock:hover code.scss:before { content: "scss"; }
.listingblock:hover code.xml:before { content: "xml"; }
.listingblock:hover code.yaml:before { content: "yaml"; }
.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }
.listingblock.terminal pre .command:not([data-prompt]):before { content: '$'; }
table.pyhltable { border: 0; margin-bottom: 0; }
table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }
table.pyhltable td.code { padding-left: .75em; padding-right: 0; }
.highlight.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }
.highlight.pygments .lineno { display: inline-block; margin-right: .25em; }
table.pyhltable .linenodiv { background-color: transparent !important; padding-right: 0 !important; }
.quoteblock { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
.quoteblock blockquote { margin: 0 0 1.25em 0; padding: 0 0 0.5625em 0; border: 0; }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: -.25em; padding-bottom: 0.5625em; font-size: inherit; color: #555555; }
.quoteblock .attribution br { display: none; }
.quoteblock .attribution cite { display: block; margin-bottom: 0.625em; }
table thead th, table tfoot th { font-weight: bold; }
table.tableblock.grid-all { border-collapse: separate; border-spacing: 1px; -webkit-border-radius: 4px; border-radius: 4px; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; }
table.tableblock.frame-topbot, table.tableblock.frame-none { border-left: 0; border-right: 0; }
table.tableblock.frame-sides, table.tableblock.frame-none { border-top: 0; border-bottom: 0; }
table.tableblock td .paragraph:last-child p > p:last-child, table.tableblock th > p:last-child, table.tableblock td > p:last-child { margin-bottom: 0; }
th.tableblock.halign-left, td.tableblock.halign-left { text-align: left; }
th.tableblock.halign-right, td.tableblock.halign-right { text-align: right; }
th.tableblock.halign-center, td.tableblock.halign-center { text-align: center; }
th.tableblock.valign-top, td.tableblock.valign-top { vertical-align: top; }
th.tableblock.valign-bottom, td.tableblock.valign-bottom { vertical-align: bottom; }
th.tableblock.valign-middle, td.tableblock.valign-middle { vertical-align: middle; }
tbody tr th { display: table-cell; line-height: 1.6; background: whitesmoke; }
tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p { color: #222222; font-weight: bold; }
td > div.verse { white-space: pre; }
ol { margin-left: 1.75em; }
ul li ol { margin-left: 1.5em; }
dl dd { margin-left: 1.125em; }
dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }
ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.625em; }
ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }
ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }
ul.checklist li > p:first-child > i[class^="icon-check"]:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }
ul.checklist li > p:first-child > input[type="checkbox"]:first-child { position: relative; top: 1px; }
ul.inline { margin: 0 auto 0.625em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }
.unstyled dl dt { font-weight: normal; font-style: normal; }
ol.arabic { list-style-type: decimal; }
ol.decimal { list-style-type: decimal-leading-zero; }
ol.loweralpha { list-style-type: lower-alpha; }
ol.upperalpha { list-style-type: upper-alpha; }
ol.lowerroman { list-style-type: lower-roman; }
ol.upperroman { list-style-type: upper-roman; }
ol.lowergreek { list-style-type: lower-greek; }
.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }
td.hdlist1 { padding-right: .8em; font-weight: bold; }
td.hdlist1, td.hdlist2 { vertical-align: top; }
.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }
.colist > table tr > td:first-of-type { padding: 0 .8em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }
.qanda > ol > li > p > em:only-child { color: #00467f; }
.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }
.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }
.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }
a.image { text-decoration: none; }
span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }
#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em; line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }
#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }
.gist .file-data > table { border: none; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }
div.unbreakable { page-break-inside: avoid; }
.big { font-size: larger; }
.small { font-size: smaller; }
.underline { text-decoration: underline; }
.overline { text-decoration: overline; }
.line-through { text-decoration: line-through; }
.aqua { color: #00bfbf; }
.aqua-background { background-color: #00fafa; }
.black { color: black; }
.black-background { background-color: black; }
.blue { color: #0000bf; }
.blue-background { background-color: #0000fa; }
.fuchsia { color: #bf00bf; }
.fuchsia-background { background-color: #fa00fa; }
.gray { color: #606060; }
.gray-background { background-color: #7d7d7d; }
.green { color: #006000; }
.green-background { background-color: #007d00; }
.lime { color: #00bf00; }
.lime-background { background-color: #00fa00; }
.maroon { color: #600000; }
.maroon-background { background-color: #7d0000; }
.navy { color: #000060; }
.navy-background { background-color: #00007d; }
.olive { color: #606000; }
.olive-background { background-color: #7d7d00; }
.purple { color: #600060; }
.purple-background { background-color: #7d007d; }
.red { color: #bf0000; }
.red-background { background-color: #fa0000; }
.silver { color: #909090; }
.silver-background { background-color: #bcbcbc; }
.teal { color: #006060; }
.teal-background { background-color: #007d7d; }
.white { color: #bfbfbf; }
.white-background { background-color: #fafafa; }
.yellow { color: #bfbf00; }
.yellow-background { background-color: #fafa00; }
span.icon > [class^="icon-"], span.icon > [class*=" icon-"] { cursor: default; }
.admonitionblock td.icon [class^="icon-"]:before { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #005498; color: #003f72; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }
.conum { display: inline-block; color: white !important; background-color: #222222; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; width: 20px; height: 20px; font-size: 12px; font-weight: bold; line-height: 20px; font-family: Arial, sans-serif; font-style: normal; position: relative; top: -2px; letter-spacing: -1px; }
.conum * { color: white !important; }
.conum + b { display: none; }
.conum:after { content: attr(data-value); }
.conum:not([data-value]):empty { display: none; }
#toc.toc2 { background: white; }
.literalblock > .content > pre, .listingblock > .content > pre { -webkit-border-radius: 0; border-radius: 0; }
</style>
<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.css">
<script src="http://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.js"></script>
<script>document.addEventListener('DOMContentLoaded', prettyPrint)</script>
</head>
<body class="article">
<div id="header">
<h1>Spring Data MongoDB - Reference Documentation</h1>
<span id="author" class="author">Mark Pollack, Thomas Risberg, Oliver Gierke, Costin Leau, Jon Brisbin, Thomas Darimont, Christoph Strobl</span><br>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#preface">Preface</a></li>
<li><a href="#introduction">Introduction</a></li>
<li>
<ul class="sectlevel2">
<li><a href="#get-started:first-steps:spring">Knowing Spring</a></li>
<li><a href="#get-started:first-steps:nosql">Knowing NoSQL and Document databases</a></li>
</ul>
</li>
<li><a href="#requirements">Requirements</a></li>
<li><a href="#get-started">Additional Help Resources</a></li>
<li>
<ul class="sectlevel2">
<li><a href="#get-started:help">Support</a></li>
<li>
<ul class="sectlevel3">
<li><a href="#get-started:help:community">Community Forum</a></li>
<li><a href="#get-started:help:professional">Professional Support</a></li>
</ul>
</li>
<li><a href="#get-started:up-to-date">Following Development</a></li>
</ul>
</li>
<li><a href="#repositories">Working with Spring Data Repositories</a></li>
<li>
<ul class="sectlevel2">
<li><a href="#repositories.core-concepts">Core concepts</a></li>
<li><a href="#repositories.query-methods">Query methods</a></li>
<li>
<ul class="sectlevel3">
<li><a href="#repositories.definition">Defining repository interfaces</a></li>
<li>
<ul class="sectlevel4">
<li><a href="#repositories.definition-tuning">Fine-tuning repository definition</a></li>
</ul>
</li>
<li><a href="#repositories.query-methods.details">Defining query methods</a></li>
<li>
<ul class="sectlevel4">
<li><a href="#repositories.query-methods.query-lookup-strategies">Query lookup strategies</a></li>
<li><a href="#repositories.query-methods.query-creation">Query creation</a></li>
<li><a href="#repositories.query-methods.query-property-expressions">Property expressions</a></li>
<li><a href="#repositories.special-parameters">Special parameter handling</a></li>
</ul>
</li>
<li><a href="#repositories.create-instances">Creating repository instances</a></li>
<li>
<ul class="sectlevel4">
<li><a href="#repositories.create-instances.spring">XML configuration</a></li>
<li><a href="#repositories.create-instances.java-config">JavaConfig</a></li>
<li><a href="#repositories.create-instances.standalone">Standalone usage</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#repositories.custom-implementations">Custom implementations for Spring Data repositories</a></li>
<li>
<ul class="sectlevel3">
<li><a href="#repositories.single-repository-behaviour">Adding custom behavior to single repositories</a></li>
<li>
<ul class="sectlevel4">
<li><a href="#configuration">Configuration</a></li>
</ul>
</li>
<li><a href="#repositories.custom-behaviour-for-all-repositories">Adding custom behavior to all repositories</a></li>
</ul>
</li>
<li><a href="#core.extensions">Spring Data extensions</a></li>
<li>
<ul class="sectlevel3">
<li><a href="#core.web">Web support</a></li>
<li>
<ul class="sectlevel4">
<li><a href="#core.web.basic">Basic web support</a></li>
<li><a href="#core.web.pageables">Hypermedia support for Pageables</a></li>
</ul>
</li>
<li><a href="#core.repository-populators">Repository populators</a></li>
<li><a href="#web.legacy">Legacy web support</a></li>
<li>
<ul class="sectlevel4">
<li><a href="#web-domain-class-binding">Domain class web binding for Spring MVC</a></li>
<li><a href="#web-pagination">Web pagination</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#reference">Reference Documentation</a></li>
<li><a href="#document_structure">Document Structure</a></li>
<li>
<ul class="sectlevel1">
<li><a href="#mongo.core">MongoDB support</a></li>
<li>
<ul class="sectlevel2">
<li><a href="#mongodb-getting-started">Getting Started</a></li>
<li><a href="#mongo.examples-repo">Examples Repository</a></li>
<li><a href="#mongodb-connectors">Connecting to MongoDB with Spring</a></li>
<li>
<ul class="sectlevel3">
<li><a href="#mongo.mongo-java-config">Registering a Mongo instance using Java based metadata Registering a com.mongodb.Mongo object using Spring&#8217;s MongoFactoryBean and enabling Spring&#8217;s exception translation support</a></li>
<li><a href="#mongo.mongo-xml-config">Registering a Mongo instance using XML based metadata XML schema to configure MongoDB XML schema to configure a com.mongodb.Mongo object with MongoOptions</a></li>
<li><a href="#mongo.mongo-db-factory">The MongoDbFactory interface</a></li>
<li><a href="#mongo.mongo-db-factory-java">Registering a MongoDbFactory instance using Java based metadata</a></li>
<li><a href="#mongo.mongo-db-factory-xml">Registering a MongoDbFactory instance using XML based metadata</a></li>
</ul>
</li>
<li><a href="#mongo.auditing">General auditing configuration Activating auditing using XML configuration Activating auditing using JavaConfig</a></li>
<li><a href="#mongo-template">Introduction to MongoTemplate</a></li>
<li>
<ul class="sectlevel3">
<li><a href="#mongo-template.instantiating">Instantiating MongoTemplate Registering a com.mongodb.Mongo object and enabling Spring&#8217;s exception translation support</a></li>
<li>
<ul class="sectlevel4">
<li><a href="#mongo-template.writeresultchecking">WriteResultChecking Policy</a></li>
<li><a href="#mongo-template.writeconcern">WriteConcern</a></li>
<li><a href="#mongo-template.writeconcernresolver">WriteConcernResolver</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#mongo-template.save-update-remove">Saving, Updating, and Removing Documents</a></li>
<li>
<ul class="sectlevel3">
<li><a href="#mongo-template.id-handling">How the <em>_id</em> field is handled in the mapping layer</a></li>
<li><a href="#mongo-template.type-mapping">Type mapping Type mapping</a></li>
<li>
<ul class="sectlevel4">
<li><a href="#nullnull">Customizing type mapping Defining a TypeAlias for an Entity</a></li>
<li><a href="#nullnullnull">Configuring custom type mapping Configuring a custom MongoTypeMapper via Spring Java Config Configuring a custom MongoTypeMapper via XML</a></li>
</ul>
</li>
<li><a href="#mongo-template.save-insert">Methods for saving and inserting documents Inserting and retrieving documents using the MongoTemplate</a></li>
<li>
<ul class="sectlevel4">
<li><a href="#mongo-template.save-insert.collection">Which collection will my documents be saved into?</a></li>
<li><a href="#mongo-template.save-insert.individual">Inserting or saving individual objects</a></li>
<li><a href="#mongo-template.save-insert.batch">Inserting several objects in a batch</a></li>
</ul>
</li>
<li><a href="#mongodb-template-update">Updating documents in a collection Updating documents using the MongoTemplate</a></li>
<li>
<ul class="sectlevel4">
<li><a href="#mongodb-template-update.methods">Methods for executing updates for documents</a></li>
<li><a href="#mongodb-template-update.update">Methods for the Update class</a></li>
</ul>
</li>
<li><a href="#mongo-template.upserts">Upserting documents in a collection</a></li>
<li><a href="#mongo-template.find-and-upsert">Finding and Upserting documents in a collection</a></li>
<li><a href="#mongo-template.delete">Methods for removing documents</a></li>
</ul>
</li>
<li><a href="#mongo.query">Querying Documents Creating a Query instance from a plain JSON String</a></li>
<li>
<ul class="sectlevel3">
<li><a href="#mongodb-template-query">Querying documents in a collection Querying for documents using the MongoTemplate</a></li>
<li>
<ul class="sectlevel4">
<li><a href="#mongodb-template-query.criteria">Methods for the Criteria class</a></li>
<li><a href="#mongodb-template-query.query">Methods for the Query class</a></li>
</ul>
</li>
<li><a href="#mongo-template.querying">Methods for querying for documents</a></li>
<li><a href="#mongo.geospatial">GeoSpatial Queries</a></li>
<li>
<ul class="sectlevel4">
<li><a href="#mongo.geo-near">Geo near queries</a></li>
</ul>
</li>
<li><a href="#mongo.textsearch">Full Text Queries Full Text Search</a></li>
</ul>
</li>
<li><a href="#mongo.mapreduce">Map-Reduce Operations</a></li>
<li>
<ul class="sectlevel3">
<li><a href="#mongo.mapreduce.example">Example Usage</a></li>
</ul>
</li>
<li><a href="#mongo.group">Group Operations</a></li>
<li>
<ul class="sectlevel3">
<li><a href="#mongo.group.example">Example Usage</a></li>
</ul>
</li>
<li><a href="#mongo.aggregation">Aggregation Framework Support</a></li>
<li>
<ul class="sectlevel3">
<li><a href="#mongo.aggregation.basic-concepts">Basic Concepts</a></li>
<li><a href="#mongo.aggregation.supported-aggregation-operations">Supported Aggregation Operations Aggregation Operations currently supported by Spring Data MongoDB</a></li>
<li><a href="#mongo.aggregation.projection">Projection Expressions Projection expression examples</a></li>
<li>
<ul class="sectlevel4">
<li><a href="#mongo.aggregation.projection.expressions">Spring Expression Support in Projection Expressions Complex calculations with SpEL expressions</a></li>
</ul>
</li>
<li><a href="#mongo.aggregation.examples">Aggregation Framework Examples Aggregation Framework Example 1 Aggregation Framework Example 2 Aggregation Framework Example 3 Aggregation Framework Example 4 Aggregation Framework Example 5 Aggregation Framework Example 6</a></li>
</ul>
</li>
<li><a href="#mongo.custom-converters">Overriding default mapping with custom converters</a></li>
<li>
<ul class="sectlevel3">
<li><a href="#mongo.custom-converters.writer">Saving using a registered Spring Converter</a></li>
<li><a href="#mongo.custom-converters.reader">Reading using a Spring Converter</a></li>
<li><a href="#mongo.custom-converters.xml">Registering Spring Converters with the MongoConverter</a></li>
<li><a href="#mongo.converter-disambiguation">Converter disambiguation</a></li>
</ul>
</li>
<li><a href="#mongo-template.index-and-collections">Index and Collection management</a></li>
<li>
<ul class="sectlevel3">
<li><a href="#mongo-template.index-and-collections.index">Methods for creating an Index Creating an index using the MongoTemplate</a></li>
<li><a href="#mongo-template.index-and-collections.access">Accessing index information</a></li>
<li><a href="#mongo-template.index-and-collections.collection">Methods for working with a Collection Working with collections using the MongoTemplate</a></li>
</ul>
</li>
<li><a href="#mongo-template.commands">Executing Commands</a></li>
<li>
<ul class="sectlevel3">
<li><a href="#mongo-template.commands.execution">Methods for executing commands</a></li>
</ul>
</li>
<li><a href="#mongodb.mapping-usage.events">Lifecycle Events</a></li>
<li><a href="#mongo.exception">Exception Translation</a></li>
<li><a href="#mongo.executioncallback">Execution callbacks</a></li>
<li><a href="#gridfs">GridFS support JavaConfig setup for a GridFsTemplate XML configuration for a GridFsTemplate Using GridFsTemplate to store files Using GridFsTemplate to query for files Using GridFsTemplate to read files</a></li>
</ul>
</li>
<li><a href="#mongo.repositories">MongoDB repositories</a></li>
<li>
<ul class="sectlevel2">
<li><a href="#mongo-repo-intro">Introduction</a></li>
<li><a href="#mongo-repo-usage">Usage Sample Person entity Basic repository interface to persist Person entities General MongoDB repository Spring configuration JavaConfig for repositories Paging access to Person entities</a></li>
<li><a href="#mongodb.repositories.queries">Query methods PersonRepository with query methods</a></li>
<li>
<ul class="sectlevel3">
<li><a href="#mongodb.repositories.queries.delete">Repository delete queries <code>Delete…By</code> Query</a></li>
<li><a href="#mongodb.repositories.queries.geo-spatial">Geo-spatial repository queries Advanced <code>Near</code> queries Using <code>Distance</code> with <code>Metrics</code></a></li>
<li>
<ul class="sectlevel4">
<li><a href="#geo_near_queries">Geo-near queries</a></li>
</ul>
</li>
<li><a href="#mongodb.repositories.queries.json-based">MongoDB JSON based query methods and field restriction</a></li>
<li><a href="#mongodb.repositories.queries.type-safe">Type-safe Query methods</a></li>
</ul>
</li>
<li><a href="#mongodb.repositories.misc">Miscellaneous</a></li>
<li>
<ul class="sectlevel3">
<li><a href="#mongodb.repositories.misc.cdi-integration">CDI Integration</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#mapping-chapter">Mapping</a></li>
<li>
<ul class="sectlevel2">
<li><a href="#mapping-conventions">Convention based Mapping</a></li>
<li>
<ul class="sectlevel3">
<li><a href="#mapping.conventions.id-field">How the <em>_id</em> field is handled in the mapping layer</a></li>
</ul>
</li>
<li><a href="#mapping-configuration">Mapping Configuration</a></li>
<li>
<ul class="sectlevel3">
<li><a href="#configuration_class_to_configure_mongodb_mapping_support">@Configuration class to configure MongoDB mapping support</a></li>
<li><a href="#xml_schema_to_configure_mongodb_mapping_support">XML schema to configure MongoDB mapping support</a></li>
</ul>
</li>
<li><a href="#mapping-usage">Metadata based Mapping</a></li>
<li>
<ul class="sectlevel3">
<li><a href="#example_domain_object">Example domain object</a></li>
<li><a href="#mapping-usage-annotations">Mapping annotation overview</a></li>
<li><a href="#mapping-custom-object-construction">Customized Object Construction</a></li>
<li><a href="#mapping-usage-indexes.compound-index">Compound Indexes</a></li>
<li>
<ul class="sectlevel5">
<li><a href="#example_compound_index_usage">Example Compound Index Usage</a></li>
</ul>
</li>
<li><a href="#mapping-usage-indexes.text-index">Text Indexes</a></li>
<li>
<ul class="sectlevel4">
<li><a href="#example_text_index_usage">Example Text Index Usage</a></li>
</ul>
</li>
<li><a href="#mapping-usage-references">Using DBRefs</a></li>
<li><a href="#mapping-usage-events">Mapping Framework Events</a></li>
<li><a href="#mapping-explicit-converters">Overriding Mapping with explicit Converters</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#mongo.cross.store">Cross Store support</a></li>
<li>
<ul class="sectlevel2">
<li><a href="#mongodb_cross-store-configuration">Cross Store Configuration Example Maven pom.xml with spring-data-mongodb-cross-store dependency Example Maven pom.xml with AspectJ plugin enabled Example application context with MongoDB and cross-store aspect support</a></li>
<li><a href="#mongodb_cross-store-application">Writing the Cross Store Application Example of Entity with @RelatedDocument Example of domain class to be stored as document Example of code using the JPA Entity configured for cross-store persistence Example of JSON document stored in MongoDB</a></li>
</ul>
</li>
<li><a href="#mongo.logging">Logging support</a></li>
<li>
<ul class="sectlevel2">
<li><a href="#mongodb:logging-configuration">MongoDB Log4j Configuration</a></li>
</ul>
</li>
<li><a href="#mongo.jmx">JMX support</a></li>
<li>
<ul class="sectlevel2">
<li><a href="#mongodb:jmx-configuration">MongoDB JMX Configuration</a></li>
<li>
<ul class="sectlevel3">
<li><a href="#xml_schema_to_configure_mongodb">XML schema to configure MongoDB</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#appendix">Appendix</a></li>
<li><a href="#populator.namespace-reference">Appendix A: Namespace reference</a></li>
<li>
<ul class="sectlevel2">
<li><a href="#populator.namespace-dao-config">The <code>&lt;repositories /&gt;</code> element</a></li>
</ul>
</li>
<li><a href="#repository-query-keywords">Appendix B: Repository query keywords</a></li>
<li>
<ul class="sectlevel2">
<li><a href="#supported_query_keywords">Supported query keywords</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="preface">Preface</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Spring Data MongoDB project applies core Spring concepts to the development of solutions using the MongoDB document style data store.  We provide a "template" as a high-level abstraction for storing and querying documents. You will notice similarities to the JDBC support in the Spring Framework.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This document is the reference guide for Spring Data - Document Support. It explains Document module concepts and semantics and the syntax for various stores namespaces.</p>
</div>
<div class="paragraph">
<p>This section provides some basic introduction to Spring and Document database. The rest of the document refers only to Spring Data Document features and assumes the user is familiar with document databases such as MongoDB and CouchDB as well as Spring concepts.</p>
</div>
<div class="sect2">
<h3 id="get-started:first-steps:spring">Knowing Spring</h3>
<div class="paragraph">
<p>Spring Data uses Spring framework&#8217;s <a href="http://docs.spring.io/spring/docs/3.2.x/spring-framework-reference/html/spring-core.html">core</a> functionality, such as the <a href="http://docs.spring.io/spring/docs/3.2.x/spring-framework-reference/html/beans.html">IoC</a> container, <a href="http://docs.spring.io/spring/docs/3.2.x/spring-framework-reference/html/validation.html#core-convert">type conversion system</a>, <a href="http://docs.spring.io/spring/docs/3.2.x/spring-framework-reference/html/expressions.html">expression language</a>, <a href="http://docs.spring.io/spring/docs/3.2.x/spring-framework-reference/html/jmx.html">JMX integration</a>, and portable <a href="http://docs.spring.io/spring/docs/3.2.x/spring-framework-reference/html/dao.html#dao-exceptions">DAO exception hierarchy</a>. While it is not important to know the Spring APIs, understanding the concepts behind them is. At a minimum, the idea behind IoC should be familiar for whatever IoC container you choose to use.</p>
</div>
<div class="paragraph">
<p>The core functionality of the MongoDB and CouchDB support can be used directly, with no need to invoke the IoC services of the Spring Container. This is much like <code>JdbcTemplate</code> which can be used <em>standalone</em> without any other services of the Spring container. To leverage all the features of Spring Data document, such as the repository support, you will need to configure some parts of the library using Spring.</p>
</div>
<div class="paragraph">
<p>To learn more about Spring, you can refer to the comprehensive (and sometimes disarming) documentation that explains in detail the Spring Framework. There are a lot of articles, blog entries and books on the matter - take a look at the Spring framework <a href="http://spring.io/docs">home page </a> for more information.</p>
</div>
</div>
<div class="sect2">
<h3 id="get-started:first-steps:nosql">Knowing NoSQL and Document databases</h3>
<div class="paragraph">
<p>NoSQL stores have taken the storage world by storm. It is a vast domain with a plethora of solutions, terms and patterns (to make things worth even the term itself has multiple <a href="http://www.google.com/search?q=nosoql+acronym">meanings</a>). While some of the principles are common, it is crucial that the user is familiar to some degree with the stores supported by DATADOC. The best way to get acquainted to this solutions is to read their documentation and follow their examples - it usually doesn&#8217;t take more then 5-10 minutes to go through them and if you are coming from an RDMBS-only background many times these exercises can be an eye opener.</p>
</div>
<div class="paragraph">
<p>The jumping off ground for learning about MongoDB is <a href="http://www.mongodb.org/">www.mongodb.org</a>. Here is a list of other useful resources.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <a href="http://docs.mongodb.org/manual/">manual</a> introduces MongoDB and contains links to getting started guides, reference documentation and tutorials.</p>
</li>
<li>
<p>The <a href="http://try.mongodb.org/">online shell</a> provides a convenient way to interact with a MongoDB instance in combination with the online <a href="http://docs.mongodb.org/manual/tutorial/getting-started/">tutorial.</a></p>
</li>
<li>
<p>MongoDB <a href="http://docs.mongodb.org/ecosystem/drivers/java/">Java Language Center</a></p>
</li>
<li>
<p>Several <a href="http://www.mongodb.org/books">books</a> available for purchase</p>
</li>
<li>
<p>Karl Seguin&#8217;s online book: "http://openmymind.net/mongodb.pdf[The Little MongoDB Book]"</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="requirements">Requirements</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Data MongoDB 1.x binaries requires JDK level 6.0 and above, and <a href="http://spring.io/docs">Spring Framework</a> 3.2.x and above.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>In terms of document stores, http://www.mongodb.org/[MongoDB] preferably version 2.4.</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="get-started">Additional Help Resources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Learning a new framework is not always straight forward. In this section, we try to provide what we think is an easy to follow guide for starting with Spring Data Document module. However, if you encounter issues or you are just looking for an advice, feel free to use one of the links below:</p>
</div>
<div class="sect2">
<h3 id="get-started:help">Support</h3>
<div class="paragraph">
<p>There are a few support options available:</p>
</div>
<div class="sect3">
<h4 id="get-started:help:community">Community Forum</h4>
<div class="paragraph">
<p>Spring Data on Stackoverflow <a href="http://stackoverflow.com/questions/tagged/spring-data">Stackoverflow </a> is a tag for all Spring Data (not just Document) users to share information and help each other. Note that registration is needed  for posting.</p>
</div>
</div>
<div class="sect3">
<h4 id="get-started:help:professional">Professional Support</h4>
<div class="paragraph">
<p>Professional, from-the-source support, with guaranteed response time, is available from <a href="http://gopivotal.com/">Pivotal Sofware, Inc.</a>, the company behind Spring Data and Spring.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="get-started:up-to-date">Following Development</h3>
<div class="paragraph">
<p>For information on the Spring Data Mongo source code repository, nightly builds and snapshot artifacts please see the <a href="http://projects.spring.io/spring-data-mongodb/">Spring Data Mongo homepage</a>.</p>
</div>
<div class="paragraph">
<p>You can help make Spring Data best serve the needs of the Spring community by interacting with developers through the Community on <a href="http://stackoverflow.com/questions/tagged/spring-data">Stackoverflow</a>. To follow developer activity look for the mailing list information on the Spring Data Mongo homepage.</p>
</div>
<div class="paragraph">
<p>If you encounter a bug or want to suggest an improvement, please create a ticket on the Spring Data issue <a href="https://jira.spring.io/browse/DATAMONGO">tracker</a>.</p>
</div>
<div class="paragraph">
<p>To stay up to date with the latest news and announcements in the Spring eco system, subscribe to the Spring Community <a href="http://spring.io">Portal</a>.</p>
</div>
<div class="paragraph">
<p>Lastly, you can follow the SpringSource Data <a href="http://spring.io/blog">blog </a>or the project team on Twitter (<a href="http://twitter.com/SpringData">SpringData</a>).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="repositories">Working with Spring Data Repositories</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The goal of Spring Data repository abstraction is to significantly reduce the amount of boilerplate code required to implement data access layers for various persistence stores.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p><em>Spring Data repository documentation and your module</em></p>
</div>
<div class="paragraph">
<p>This chapter explains the core concepts and interfaces of Spring Data repositories. The information in this chapter is pulled from the Spring Data Commons module. It uses the configuration and code samples for the Java Persistence API (JPA) module. Adapt the XML namespace declaration and the types to be extended to the equivalents of the particular module that you are using. <a href="#namespace-reference">[namespace-reference]</a> covers XML configuration which is supported across all Spring Data modules supporting the repository API, <a href="#repository-query-keywords">Repository query keywords</a> covers the query method keywords supported by the repository abstraction in general. For detailed information on the specific features of your module, consult the chapter on that module of this document.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="repositories.core-concepts">Core concepts</h3>
<div class="paragraph">
<p>The central interface in Spring Data repository abstraction is <code>Repository</code> (probably not that much of a surprise). It takes the domain class to manage as well as the id type of the domain class as type arguments. This interface acts primarily as a marker interface to capture the types to work with and to help you to discover interfaces that extend this one. The <code>CrudRepository</code> provides sophisticated CRUD functionality for the entity class that is being managed.</p>
</div>
<div id="repositories.repository" class="exampleblock">
<div class="title">Example 1. CrudRepository interface</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public interface CrudRepository&lt;T, ID extends Serializable&gt;
    extends Repository&lt;T, ID&gt; {

    &lt;S extends T&gt; S save(S entity); <b>(1)</b>

    T findOne(ID primaryKey);       <b>(2)</b>

    Iterable&lt;T&gt; findAll();          <b>(3)</b>

    Long count();                   <b>(4)</b>

    void delete(T entity);          <b>(5)</b>

    boolean exists(ID primaryKey);  <b>(6)</b>

    // … more functionality omitted.
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Saves the given entity.</p>
</li>
<li>
<p>Returns the entity identified by the given id.</p>
</li>
<li>
<p>Returns all entities.</p>
</li>
<li>
<p>Returns the number of entities.</p>
</li>
<li>
<p>Deletes the given entity.</p>
</li>
<li>
<p>Indicates whether an entity with the given id exists.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>We also provide persistence technology-specific abstractions like e.g. <code>JpaRepository</code> or <code>MongoRepository</code>. Those interfaces extend    <code>CrudRepository</code> and expose the capabilities of the underlying persistence technology in addition to the rather generic persistence technology-agnostic interfaces like e.g. CrudRepository.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>On top of the <code>CrudRepository</code> there is a <code>PagingAndSortingRepository</code> abstraction that adds additional methods to ease paginated access to entities:</p>
</div>
<div class="exampleblock">
<div class="title">Example 2. PagingAndSortingRepository</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public interface PagingAndSortingRepository&lt;T, ID extends Serializable&gt;
  extends CrudRepository&lt;T, ID&gt; {

  Iterable&lt;T&gt; findAll(Sort sort);

  Page&lt;T&gt; findAll(Pageable pageable);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Accessing the second page of <code>User</code> by a page size of 20 you could simply do something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">PagingAndSortingRepository&lt;User, Long&gt; repository = // … get access to a bean
Page&lt;User&gt; users = repository.findAll(new PageRequest(1, 20));</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition to query methods, query derivation for both count and delete queries, is available.</p>
</div>
<div class="exampleblock">
<div class="title">Example 3. Derived Count Query</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public interface UserRepository extends CrudRepository&lt;User, Long&gt; {

  Long countByLastname(String lastname);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 4. Derived Delete Query</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public interface UserRepository extends CrudRepository&lt;User, Long&gt; {

  Long deleteByLastname(String lastname);

  List&lt;User&gt; removeByLastname(String lastname);

}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="repositories.query-methods">Query methods</h3>
<div class="paragraph">
<p>Standard CRUD functionality repositories usually have queries on the underlying datastore. With Spring Data, declaring those queries becomes a four-step process:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Declare an interface extending Repository or one of its subinterfaces and type it to the domain class and ID type that it will handle.</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">interface PersonRepository extends Repository&lt;User, Long&gt; { … }</code></pre>
</div>
</div>
</li>
<li>
<p>Declare query methods on the interface.</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">interface PersonRepository extends Repository&lt;User, Long&gt; {
  List&lt;Person&gt; findByLastname(String lastname);
}</code></pre>
</div>
</div>
</li>
<li>
<p>Set up Spring to create proxy instances for those interfaces. Either via <a href="#repositories.create-instances.java-config">JavaConfig</a>:</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">import org.springframework.data.jpa.repository.config.EnableJpaRepositories;

@EnableJpaRepositories
class Config {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>or via <a href="#repositories.create-instances">XML configuration</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xmlns:jpa="http://www.springframework.org/schema/data/jpa"
   xsi:schemaLocation="http://www.springframework.org/schema/beans
     http://www.springframework.org/schema/beans/spring-beans.xsd
     http://www.springframework.org/schema/data/jpa
     http://www.springframework.org/schema/data/jpa/spring-jpa.xsd"&gt;

   &lt;jpa:repositories base-package="com.acme.repositories"/&gt;

&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The JPA namespace is used in this example. If you are using the repository abstraction for any other store, you need to change this to the appropriate namespace declaration of your store module which should be exchanging <code>jpa</code> in favor of, for example, <code>mongodb</code>. Also, note that the JavaConfig variant doesn&#8217;t configure a package explictly as the package of the annotated class is used by default. To customize the package to scan</p>
</div>
</li>
<li>
<p>Get the repository instance injected and use it.</p>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public class SomeClient {

  @Autowired
  private PersonRepository repository;

  public void doSomething() {
    List&lt;Person&gt; persons = repository.findByLastname("Matthews");
  }
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The sections that follow explain each step in detail.</p>
</div>
<div class="sect3">
<h4 id="repositories.definition">Defining repository interfaces</h4>
<div class="paragraph">
<p>As a first step you define a domain class-specific repository interface. The interface must extend Repository and be typed to the domain class and an ID type. If you want to expose CRUD methods for that domain type, extend <code>CrudRepository</code> instead of <code>Repository</code>.</p>
</div>
<div class="sect4">
<h5 id="repositories.definition-tuning">Fine-tuning repository definition</h5>
<div class="paragraph">
<p>Typically, your repository interface will extend <code>Repository</code>, <code>CrudRepository</code> or <code>PagingAndSortingRepository</code>. Alternatively, if you do not want to extend Spring Data interfaces, you can also annotate your repository interface with <code>@RepositoryDefinition</code>. Extending <code>CrudRepository</code> exposes a complete set of methods to manipulate your entities. If you prefer to be selective about the methods being exposed, simply copy the ones you want to expose from <code>CrudRepository</code> into your domain repository.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This allows you to define your own abstractions on top of the provided Spring Data Repositories functionality.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 5. Selectively exposing CRUD methods</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">@NoRepositoryBean
interface MyBaseRepository&lt;T, ID extends Serializable&gt; extends Repository&lt;T, ID&gt; {

  T findOne(ID id);

  T save(T entity);
}

interface UserRepository extends MyBaseRepository&lt;User, Long&gt; {
  User findByEmailAddress(EmailAddress emailAddress);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In this first step you defined a common base interface for all your domain repositories and exposed <code>findOne(…)</code> as well as <code>save(…)</code>.These methods will be routed into the base repository implementation of the store of your choice provided by Spring Data ,e.g. in the case if JPA <code>SimpleJpaRepository</code>, because they are matching the method signatures in <code>CrudRepository</code>. So the <code>UserRepository</code> will now be able to save users, and find single ones by id, as well as triggering a query to find <code>Users</code> by their email address.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Note, that the intermediate repository interface is annotated with <code>@NoRepositoryBean</code>. Make sure you add that annotation to all repository interfaces that Spring Data should not create instances for at runtime.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="repositories.query-methods.details">Defining query methods</h4>
<div class="paragraph">
<p>The repository proxy has two ways to derive a store-specific query from the method name. It can derive the query from the method name directly, or by using an manually defined query. Available options depend on the actual store. However, there&#8217;s got to be an strategy that decides what actual query is created. Let&#8217;s have a look at the available options.</p>
</div>
<div class="sect4">
<h5 id="repositories.query-methods.query-lookup-strategies">Query lookup strategies</h5>
<div class="paragraph">
<p>The following strategies are available for the repository infrastructure to resolve the query. You can configure the strategy at the namespace through the <code>query-lookup-strategy</code> attribute in case of XML configuration or via the <code>queryLookupStrategy</code> attribute of the Enable${store}Repositories annotation in case of Java config. Some strategies may not be supported for particular datastores.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>CREATE</code> attempts to construct a store-specific query from the query method name. The general approach is to remove a given set of well-known prefixes from the method name and parse the rest of the method. Read more about query construction in <a href="#repositories.query-methods.query-creation">Query creation</a>.</p>
</li>
<li>
<p><code>USE_DECLARED_QUERY</code> tries to find a declared query and will throw an exception in case it can&#8217;t find one. The query can be defined by an annotation somewhere or declared by other means. Consult the documentation of the specific store to find available options for that store. If the repository infrastructure does not find a declared query for the method at bootstrap time, it fails.</p>
</li>
<li>
<p><code>CREATE_IF_NOT_FOUND</code> (default) combines <code>CREATE</code> and <code>USE_DECLARED_QUERY</code>. It looks up a declared query first, and if no declared query is found, it creates a custom method name-based query. This is the default lookup strategy and thus will be used if you do not configure anything explicitly. It allows quick query definition by method names but also custom-tuning of these queries by introducing declared queries as needed.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="repositories.query-methods.query-creation">Query creation</h5>
<div class="paragraph">
<p>The query builder mechanism built into Spring Data repository infrastructure is useful for building constraining queries over entities of the repository. The mechanism strips the prefixes <code>find…By</code>, <code>read…By</code>, <code>query…By</code>, <code>count…By</code>, and <code>get…By</code> from the method and starts parsing the rest of it. The introducing clause can contain further expressions such as a <code>Distinct</code> to set a distinct flag on the query to be created. However, the first <code>By</code> acts as delimiter to indicate the start of the actual criteria. At a very basic level you can define conditions on entity properties and concatenate them with <code>And</code> and <code>Or</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 6. Query creation from method names</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public interface PersonRepository extends Repository&lt;User, Long&gt; {

  List&lt;Person&gt; findByEmailAddressAndLastname(EmailAddress emailAddress, String lastname);

  // Enables the distinct flag for the query
  List&lt;Person&gt; findDistinctPeopleByLastnameOrFirstname(String lastname, String firstname);
  List&lt;Person&gt; findPeopleDistinctByLastnameOrFirstname(String lastname, String firstname);

  // Enabling ignoring case for an individual property
  List&lt;Person&gt; findByLastnameIgnoreCase(String lastname);
  // Enabling ignoring case for all suitable properties
  List&lt;Person&gt; findByLastnameAndFirstnameAllIgnoreCase(String lastname, String firstname);

  // Enabling static ORDER BY for a query
  List&lt;Person&gt; findByLastnameOrderByFirstnameAsc(String lastname);
  List&lt;Person&gt; findByLastnameOrderByFirstnameDesc(String lastname);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The actual result of parsing the method depends on the persistence store for which you create the query. However, there are some general things to notice.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The expressions are usually property traversals combined with operators that can be concatenated. You can combine property expressions with <code>AND</code> and <code>OR</code>. You also get support for operators such as <code>Between</code>, <code>LessThan</code>, <code>GreaterThan</code>, <code>Like</code> for the property expressions. The supported operators can vary by datastore, so consult the appropriate part of your reference documentation.</p>
</li>
<li>
<p>The method parser supports setting an <code>IgnoreCase</code> flag for individual properties (for example, <code>findByLastnameIgnoreCase(…)</code>) or for all properties of a type that support ignoring case (usually <code>String</code> instances, for example, <code>findByLastnameAndFirstnameAllIgnoreCase(…)</code>). Whether ignoring cases is supported may vary by store, so consult the relevant sections in the reference documentation for the store-specific query method.</p>
</li>
<li>
<p>You can apply static ordering by appending an <code>OrderBy</code> clause to the query method that references a property and by providing a sorting direction (<code>Asc</code> or <code>Desc</code>). To create a query method that supports dynamic sorting, see <a href="#repositories.special-parameters">Special parameter handling</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="repositories.query-methods.query-property-expressions">Property expressions</h5>
<div class="paragraph">
<p>Property expressions can refer only to a direct property of the managed entity, as shown in the preceding example. At query creation time you already make sure that the parsed property is a property of the managed domain class. However, you can also define constraints by traversing nested properties. Assume a <code>Person</code> has an <code>Address</code> with a <code>ZipCode</code>. In that case a method name of</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">List&lt;Person&gt; findByAddressZipCode(ZipCode zipCode);</code></pre>
</div>
</div>
<div class="paragraph">
<p>creates the property traversal <code>x.address.zipCode</code>. The resolution algorithm starts with interpreting the entire part (<code>AddressZipCode</code>) as the property and checks the domain class for a property with that name (uncapitalized). If the algorithm succeeds it uses that property. If not, the algorithm splits up the source at the camel case parts from the right side into a head and a tail and tries to find the corresponding property, in our example, <code>AddressZip</code> and <code>Code</code>. If the algorithm finds a property with that head it takes the tail and continue building the tree down from there, splitting the tail up in the way just described. If the first split does not match, the algorithm move the split point to the left (<code>Address</code>, <code>ZipCode</code>) and continues.</p>
</div>
<div class="paragraph">
<p>Although this should work for most cases, it is possible for the algorithm to select the wrong property. Suppose the <code>Person</code> class has an <code>addressZip</code> property as well. The algorithm would match in the first split round already and essentially choose the wrong property and finally fail (as the type of <code>addressZip</code> probably has no <code>code</code> property).</p>
</div>
<div class="paragraph">
<p>To resolve this ambiguity you can use <code>_</code> inside your method name to manually define traversal points. So our method name would end up like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">List&lt;Person&gt; findByAddress_ZipCode(ZipCode zipCode);</code></pre>
</div>
</div>
<div class="paragraph">
<p>If your property names contain underscores (e.g. <code>first_name</code>) you can escape the underscore in the method name with a second underscore. For a <code>first_name</code> property the query method would have to be named <code>findByFirst__name(…)</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="repositories.special-parameters">Special parameter handling</h5>
<div class="paragraph">
<p>To handle parameters in your query you simply define method parameters as already seen in the examples above. Besides that the infrastructure will recognize certain specific types like <code>Pageable</code> and <code>Sort</code> to apply pagination and sorting to your queries dynamically.</p>
</div>
<div class="exampleblock">
<div class="title">Example 7. Using <code>Pageable</code> and Sort in query methods</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">Page&lt;User&gt; findByLastname(String lastname, Pageable pageable);

List&lt;User&gt; findByLastname(String lastname, Sort sort);

List&lt;User&gt; findByLastname(String lastname, Pageable pageable);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The first method allows you to pass an <code>org.springframework.data.domain.Pageable</code> instance to the query method to dynamically add paging to your statically defined query. Sorting options are handled through the <code>Pageable</code> instance too. If you only need sorting, simply add an <code>org.springframework.data.domain.Sort</code> parameter to your method. As you also can see, simply returning a <code>List</code> is possible as well. In this case the additional metadata required to build the actual <code>Page</code> instance will not be created (which in turn means that the additional count query that would have been necessary not being issued) but rather simply restricts the query to look up only the given range of entities.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>To find out how many pages you get for a query entirely you have to trigger an additional count query. By default this query will be derived from the query you actually trigger.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="repositories.create-instances">Creating repository instances</h4>
<div class="paragraph">
<p>In this section you create instances and bean definitions for the repository interfaces defined. One way to do so is using the Spring namespace that is shipped with each Spring Data module that supports the repository mechanism although we generally recommend to use the Java-Config style configuration.</p>
</div>
<div class="sect4">
<h5 id="repositories.create-instances.spring">XML configuration</h5>
<div class="paragraph">
<p>Each Spring Data module includes a repositories element that allows you to simply define a base package that Spring scans for you.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans:beans xmlns:beans="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns="http://www.springframework.org/schema/data/jpa"
  xsi:schemaLocation="http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/data/jpa
    http://www.springframework.org/schema/data/jpa/spring-jpa.xsd"&gt;

  &lt;repositories base-package="com.acme.repositories" /&gt;

&lt;/beans:beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the preceding example, Spring is instructed to scan <code>com.acme.repositories</code> and all its sub-packages for interfaces extending <code>Repository</code> or one of its sub-interfaces. For each interface found, the infrastructure registers the persistence technology-specific <code>FactoryBean</code> to create the appropriate proxies that handle invocations of the query methods. Each bean is registered under a bean name that is derived from the interface name, so an interface of <code>UserRepository</code> would be registered under <code>userRepository</code>. The <code>base-package</code> attribute allows wildcards, so that you can define a pattern of scanned packages.</p>
</div>
<div class="sect5">
<h6 id="using_filters">Using filters</h6>
<div class="paragraph">
<p>By default the infrastructure picks up every interface extending the persistence technology-specific <code>Repository</code> sub-interface located under the configured base package and creates a bean instance for it. However, you might want more fine-grained control over which interfaces bean instances get created for. To do this you use <code>&lt;include-filter /&gt;</code> and <code>&lt;exclude-filter /&gt;</code> elements inside <code>&lt;repositories /&gt;</code>. The semantics are exactly equivalent to the elements in Spring&#8217;s context namespace. For details, see <a href="{spring-framework-docs}/beans.html#beans-scanning-filters">Spring reference documentation</a> on these elements.</p>
</div>
<div class="paragraph">
<p>For example, to exclude certain interfaces from instantiation as repository, you could use the following configuration:</p>
</div>
<div class="exampleblock">
<div class="title">Example 8. Using exclude-filter element</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;repositories base-package="com.acme.repositories"&gt;
  &lt;context:exclude-filter type="regex" expression=".*SomeRepository" /&gt;
&lt;/repositories&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example excludes all interfaces ending in <code>SomeRepository</code> from being instantiated.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="repositories.create-instances.java-config">JavaConfig</h5>
<div class="paragraph">
<p>The repository infrastructure can also be triggered using a store-specific <code>@Enable${store}Repositories</code> annotation on a JavaConfig class. For an introduction into Java-based configuration of the Spring container, see the reference documentation.<span class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnote_1" title="View footnote.">1</a>]</span></p>
</div>
<div class="paragraph">
<p>A sample configuration to enable Spring Data repositories looks something like this.</p>
</div>
<div class="exampleblock">
<div class="title">Example 9. Sample annotation based repository configuration</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">@Configuration
@EnableJpaRepositories("com.acme.repositories")
class ApplicationConfiguration {

  @Bean
  public EntityManagerFactory entityManagerFactory() {
    // …
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The sample uses the JPA-specific annotation, which you would change according to the store module you actually use. The same applies to the definition of the `EntityManagerFactory bean. Consult the sections covering the store-specific configuration.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="repositories.create-instances.standalone">Standalone usage</h5>
<div class="paragraph">
<p>You can also use the repository infrastructure outside of a Spring container, e.g. in CDI environments. You still need some Spring libraries in your classpath, but generally you can set up repositories programmatically as well. The Spring Data modules that provide repository support ship a persistence technology-specific RepositoryFactory that you can use as follows.</p>
</div>
<div class="exampleblock">
<div class="title">Example 10. Standalone usage of repository factory</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">RepositoryFactorySupport factory = … // Instantiate factory here
UserRepository repository = factory.getRepository(UserRepository.class);</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="repositories.custom-implementations">Custom implementations for Spring Data repositories</h3>
<div class="paragraph">
<p>Often it is necessary to provide a custom implementation for a few repository methods. Spring Data repositories easily allow you to provide custom repository code and integrate it with generic CRUD abstraction and query method functionality.</p>
</div>
<div class="sect3">
<h4 id="repositories.single-repository-behaviour">Adding custom behavior to single repositories</h4>
<div class="paragraph">
<p>To enrich a repository with custom functionality you first define an interface and an implementation for the custom functionality. Use the repository interface you provided to extend the custom interface.</p>
</div>
<div class="exampleblock">
<div class="title">Example 11. Interface for custom repository functionality</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">interface UserRepositoryCustom {
  public void someCustomMethod(User user);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 12. Implementation of custom repository functionality</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">class UserRepositoryImpl implements UserRepositoryCustom {

  public void someCustomMethod(User user) {
    // Your custom implementation
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation itself does not depend on Spring Data and can be a regular Spring bean. So you can use standard dependency injection behavior to inject references to other beans like a JdbTemplate, take part in aspects, and so on.</p>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 13. Changes to the your basic repository interface</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">interface UserRepository extends CrudRepository&lt;User, Long&gt;, UserRepositoryCustom {

  // Declare query methods here
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let your standard repository interface extend the custom one. Doing so combines the CRUD and custom functionality and makes it available to clients.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configuration">Configuration</h5>
<div class="paragraph">
<p>If you use namespace configuration, the repository infrastructure tries to autodetect custom implementations by scanning for classes below the package we found a repository in. These classes need to follow the naming convention of appending the namespace element&#8217;s attribute <code>repository-impl-postfix</code> to the found repository interface name. This postfix defaults to <code>Impl</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 14. Configuration example</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;repositories base-package="com.acme.repository" /&gt;

&lt;repositories base-package="com.acme.repository" repository-impl-postfix="FooBar" /&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The first configuration example will try to look up a class com.acme.repository.UserRepositoryImpl to act as custom repository implementation, whereas the second example will try to lookup com.acme.repository.UserRepositoryFooBar.</p>
</div>
<div class="paragraph">
<p>Manual wiring The preceding approach works well if your custom implementation uses annotation-based configuration and autowiring only, as it will be treated as any other Spring bean. If your custom implementation bean needs special wiring, you simply declare the bean and name it after the conventions just described. The infrastructure will then refer to the manually defined bean definition by name instead of creating one itself.</p>
</div>
<div class="exampleblock">
<div class="title">Example 15. Manual wiring of custom implementations (I)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;repositories base-package="com.acme.repository" /&gt;

&lt;beans:bean id="userRepositoryImpl" class="…"&gt;
  &lt;!-- further configuration --&gt;
&lt;/beans:bean&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="repositories.custom-behaviour-for-all-repositories">Adding custom behavior to all repositories</h4>
<div class="paragraph">
<p>The preceding approach is not feasible when you want to add a single method to all your repository interfaces.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To add custom behavior to all repositories, you first add an intermediate interface to declare the shared behavior.</p>
</li>
</ol>
</div>
<div class="exampleblock">
<div class="title">Example 16. An interface declaring custom shared behavior</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public interface MyRepository&lt;T, ID extends Serializable&gt;
  extends JpaRepository&lt;T, ID&gt; {

  void sharedCustomMethod(ID id);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Now your individual repository interfaces will extend this intermediate interface instead of the Repository interface to include the functionality declared.</p>
</li>
<li>
<p>Next, create an implementation of the intermediate interface that extends the persistence technology-specific repository base class. This class will then act as a custom base class for the repository proxies.</p>
</li>
</ol>
</div>
<div class="exampleblock">
<div class="title">Example 17. Custom repository base class</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public class MyRepositoryImpl&lt;T, ID extends Serializable&gt;
  extends SimpleJpaRepository&lt;T, ID&gt; implements MyRepository&lt;T, ID&gt; {

  private EntityManager entityManager;

  // There are two constructors to choose from, either can be used.
  public MyRepositoryImpl(Class&lt;T&gt; domainClass, EntityManager entityManager) {
    super(domainClass, entityManager);

    // This is the recommended method for accessing inherited class dependencies.
    this.entityManager = entityManager;
  }

  public void sharedCustomMethod(ID id) {
    // implementation goes here
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The default behavior of the Spring <code>&lt;repositories /&gt;</code> namespace is to provide an implementation for all interfaces that fall under the <code>base-package</code>. This means that if left in its current state, an implementation instance of MyRepository will be created by Spring. This is of course not desired as it is just supposed to act as an intermediary between Repository and the actual repository interfaces you want to define for each entity. To exclude an interface that extends Repository from being instantiated as a repository instance, you can either annotate it with @NoRepositoryBean or move it outside of the configured <code>base-package</code>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Then create a custom repository factory to replace the default RepositoryFactoryBean that will in turn produce a custom RepositoryFactory. The new repository factory will then provide your MyRepositoryImpl as the implementation of any interfaces that extend the Repository interface, replacing the SimpleJpaRepository implementation you just extended.</p>
</li>
</ol>
</div>
<div class="exampleblock">
<div class="title">Example 18. Custom repository factory bean</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public class MyRepositoryFactoryBean&lt;R extends JpaRepository&lt;T, I&gt;, T, I extends Serializable&gt;
  extends JpaRepositoryFactoryBean&lt;R, T, I&gt; {

  protected RepositoryFactorySupport createRepositoryFactory(EntityManager entityManager) {

    return new MyRepositoryFactory(entityManager);
  }

  private static class MyRepositoryFactory&lt;T, I extends Serializable&gt; extends JpaRepositoryFactory {

    private EntityManager entityManager;

    public MyRepositoryFactory(EntityManager entityManager) {
      super(entityManager);

      this.entityManager = entityManager;
    }

    protected Object getTargetRepository(RepositoryMetadata metadata) {

      return new MyRepositoryImpl&lt;T, I&gt;((Class&lt;T&gt;) metadata.getDomainClass(), entityManager);
    }

    protected Class&lt;?&gt; getRepositoryBaseClass(RepositoryMetadata metadata) {

      // The RepositoryMetadata can be safely ignored, it is used by the JpaRepositoryFactory
      //to check for QueryDslJpaRepository's which is out of scope.
      return MyRepository.class;
    }
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Finally, either declare beans of the custom factory directly or use the <code>factory-class</code> attribute of the Spring namespace to tell the repository infrastructure to use your custom factory implementation.</p>
</li>
</ol>
</div>
<div class="exampleblock">
<div class="title">Example 19. Using the custom factory with the namespace</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;repositories base-package="com.acme.repository"
  factory-class="com.acme.MyRepositoryFactoryBean" /&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="core.extensions">Spring Data extensions</h3>
<div class="paragraph">
<p>This section documents a set of Spring Data extensions that enable Spring Data usage in a variety of contexts. Currently most of the integration is targeted towards Spring MVC.</p>
</div>
<div class="sect3">
<h4 id="core.web">Web support</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This section contains the documentation for the Spring Data web support as it is implemented as of Spring Data Commons in the 1.6 range. As it the newly introduced support changes quite a lot of things we kept the documentation of the former behavior in <a href="#web.legacy">Legacy web support</a>.</p>
</div>
<div class="paragraph">
<p>Also note that the JavaConfig support introduced in Spring Data Commons 1.6 requires Spring 3.2 due to some issues with JavaConfig and overridden methods in Spring 3.1.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Spring Data modules ships with a variety of web support if the module supports the repository programming model. The web related stuff requires Spring MVC JARs on the classpath, some of them even provide integration with Spring HATEOAS.</p>
</div>
<div class="paragraph">
<p><span class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnote_2" title="View footnote.">2</a>]</span>In general, the integration support is enabled by using the @EnableSpringDataWebSupport annotation in your JavaConfig configuration class.</p>
</div>
<div class="exampleblock">
<div class="title">Example 20. Enabling Spring Data web support</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">@Configuration
@EnableWebMvc
@EnableSpringDataWebSupport
class WebConfiguration { }</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The @EnableSpringDataWebSupport annotation registers a few components we will discuss in a bit. It will also detect Spring HATEOAS on the classpath and register integration components for it as well if present.</p>
</div>
<div class="paragraph">
<p>Alternatively, if you are using XML configuration, register either SpringDataWebSupport or HateoasAwareSpringDataWebSupport as Spring beans:</p>
</div>
<div class="exampleblock">
<div class="title">Example 21. Enabling Spring Data web support in XML</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;bean class="org.springframework.data.web.config.SpringDataWebConfiguration" /&gt;

&lt;!-- If you're using Spring HATEOAS as well register this one *instead* of the former --&gt;
&lt;bean class="org.springframework.data.web.config.HateoasAwareSpringDataWebConfiguration" /&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="core.web.basic">Basic web support</h5>
<div class="paragraph">
<p>The configuration setup shown above will register a few basic components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>DomainClassConverter</code> to enable Spring MVC to resolve instances of repository managed domain classes from request parameters or path variables.</p>
</li>
<li>
<p><code>HandlerMethodArgumentResolver</code> implementations to let Spring MVC resolve Pageable and Sort instances from request parameters.</p>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="domainclassconverter">DomainClassConverter</h6>
<div class="paragraph">
<p>The <code>DomainClassConverter</code> allows you to use domain types in your Spring MVC controller method signatures directly, so that you don&#8217;t have to manually lookup the instances via the repository:</p>
</div>
<div class="exampleblock">
<div class="title">Example 22. A Spring MVC controller using domain types in method signatures</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">@Controller
@RequestMapping("/users")
public class UserController {

  @RequestMapping("/{id}")
  public String showUserForm(@PathVariable("id") User user, Model model) {

    model.addAttribute("user", user);
    return "userForm";
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>As you can see the method receives a User instance directly and no further lookup is necessary. The instance can be resolved by letting Spring MVC convert the path variable into the id type of the domain class first and eventually access the instance through calling findOne(…) on the repository instance registered for the domain type.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Currently the repository has to implement CrudRepository to be eligible to be discovered for conversion.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="code_handlermethodargumentresolvers_code_for_code_pageable_code_and_code_sort_code"><code>HandlerMethodArgumentResolvers</code> for <code>Pageable</code> and <code>Sort</code></h6>
<div class="paragraph">
<p>The configuration snippet above also registers a <code>PageableHandlerMethodArgumentResolver</code> as well as an instance of <code>SortHandlerMethodArgumentResolver</code>. The registration enables <code>Pageable</code> and <code>Sort</code> being valid controller method arguments</p>
</div>
<div class="exampleblock">
<div class="title">Example 23. Using Pageable as controller method argument</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">@Controller
@RequestMapping("/users")
public class UserController {

  @Autowired UserRepository repository;

  @RequestMapping
  public String showUsers(Model model, Pageable pageable) {

    model.addAttribute("users", repository.findAll(pageable));
    return "users";
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This method signature will cause Spring MVC try to derive a Pageable instance from the request parameters using the following default configuration:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 100%;">
<caption class="title">Table 1. Request parameters evaluated for Pageable instances</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>page</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Page you want to retrieve.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>size</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size of the page you want to retrieve.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sort</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Properties that should be sorted by in the format `property,property(,ASC</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>To customize this behavior extend either <code>SpringDataWebConfiguration</code> or the HATEOAS-enabled equivalent and override the <code>pageableResolver()</code> or <code>sortResolver()</code> methods and import your customized configuration file instead of using the <code>@Enable</code>-annotation.</p>
</div>
<div class="paragraph">
<p>In case you need multiple <code>Pageable</code> or <code>Sort</code> instances to be resolved from the request (for multiple tables, for example) you can use Spring&#8217;s <code>@Qualifier</code> annotation to distinguish one from another. The request parameters then have to be prefixed with <code>${qualifier}_</code>. So for a method signature like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public String showUsers(Model model,
      @Qualifier("foo") Pageable first,
      @Qualifier("bar") Pageable second) { … }</code></pre>
</div>
</div>
<div class="paragraph">
<p>you have to populate <code>foo_page</code> and <code>bar_page</code> etc.</p>
</div>
<div class="paragraph">
<p>The default <code>Pageable</code> handed into the method is equivalent to a <code>new PageRequest(0, 20)</code> but can be customized using the @PageableDefaults annotation on the Pageable parameter.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="core.web.pageables">Hypermedia support for Pageables</h5>
<div class="paragraph">
<p>Spring HATEOAS ships with a representation model class PagedResources that allows enrichting the content of a Page instance with the necessary Page metadata as well as links to let the clients easily navigate the pages. The conversion of a Page to a PagedResources is done by an implementation of the Spring HATEOAS ResourceAssembler interface, the PagedResourcesAssembler.</p>
</div>
<div class="exampleblock">
<div class="title">Example 24. Using a PagedResourcesAssembler as controller method argument</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">@Controller
class PersonController {

  @Autowired PersonRepository repository;

  @RequestMapping(value = "/persons", method = RequestMethod.GET)
  HttpEntity&lt;PagedResources&lt;Person&gt;&gt; persons(Pageable pageable,
    PagedResourcesAssembler assembler) {

    Page&lt;Person&gt; persons = repository.findAll(pageable);
    return new ResponseEntity&lt;&gt;(assembler.toResources(persons), HttpStatus.OK);
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Enabling the configuration as shown above allows the <code>PagedResourcesAssembler</code> to be used as controller method argument. Calling <code>toResources(…)</code> on it will cause the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The content of the <code>Page</code> will become the content of the <code>PagedResources</code> instance.</p>
</li>
<li>
<p>The <code>PagedResources</code> will get a <code>PageMetadata</code> instance attached populated with information form the <code>Page</code> and the underlying <code>PageRequest</code>.</p>
</li>
<li>
<p>The <code>PagedResources</code> gets <code>prev</code> and <code>next</code> links attached depending on the page&#8217;s state. The links will point to the URI the method invoked is mapped to. The pagination parameters added to the method will match the setup of the <code>PageableHandlerMethodArgumentResolver</code> to make sure the links can be resolved later on.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Assume we have 30 Person instances in the database. You can now trigger a request <code>GET http://localhost:8080/persons</code> and you&#8217;ll see something similar to this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="javascript language-javascript">{ "links" : [ { "rel" : "next",
                "href" : "http://localhost:8080/persons?page=1&amp;size=20 }
  ],
  "content" : [
     … // 20 Person instances rendered here
  ],
  "pageMetadata" : {
    "size" : 20,
    "totalElements" : 30,
    "totalPages" : 2,
    "number" : 0
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You see that the assembler produced the correct URI and also picks up the default configuration present to resolve the parameters into a <code>Pageable</code> for an upcoming request. This means, if you change that configuration, the links will automatically adhere to the change. By default the assembler points to the controller method it was invoked in but that can be customized by handing in a custom <code>Link</code> to be used as base to build the pagination links to overloads of the <code>PagedResourcesAssembler.toResource(…)</code> method.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="core.repository-populators">Repository populators</h4>
<div class="paragraph">
<p>If you work with the Spring JDBC module, you probably are familiar with the support to populate a <code>DataSource</code> using SQL scripts. A similar abstraction is available on the repositories level, although it does not use SQL as the data definition language because it must be store-independent. Thus the populators support XML (through Spring&#8217;s OXM abstraction) and JSON (through Jackson) to define data with which to populate the repositories.</p>
</div>
<div class="paragraph">
<p>Assume you have a file <code>data.json</code> with the following content:</p>
</div>
<div class="exampleblock">
<div class="title">Example 25. Data defined in JSON</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="javascript language-javascript">[ { "_class" : "com.acme.Person",
 "firstname" : "Dave",
  "lastname" : "Matthews" },
  { "_class" : "com.acme.Person",
 "firstname" : "Carter",
  "lastname" : "Beauford" } ]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can easily populate your repositories by using the populator elements of the repository namespace provided in Spring Data Commons. To populate the preceding data to your PersonRepository , do the following:</p>
</div>
<div class="exampleblock">
<div class="title">Example 26. Declaring a Jackson repository populator</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:repository="http://www.springframework.org/schema/data/repository"
  xsi:schemaLocation="http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/data/repository
    http://www.springframework.org/schema/data/repository/spring-repository.xsd"&gt;

  &lt;repository:jackson-populator locations="classpath:data.json" /&gt;

&lt;/beans&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This declaration causes the <code>data.json</code> file to
be read and deserialized via a Jackson <code>ObjectMapper</code>.</p>
</div>
<div class="paragraph">
<p>The type to which the JSON object will be unmarshalled to will be determined by inspecting the <code>_class</code> attribute of the JSON document. The infrastructure will eventually select the appropriate repository to handle the object just deserialized.</p>
</div>
<div class="paragraph">
<p>To rather use XML to define the data the repositories shall be populated with, you can use the <code>unmarshaller-populator</code> element. You configure it to use one of the XML marshaller options Spring OXM provides you with. See the <a href="{spring-framework-docs}/oxm.html">Spring reference documentation</a> for details.</p>
</div>
<div class="exampleblock">
<div class="title">Example 27. Declaring an unmarshalling repository populator (using JAXB)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:repository="http://www.springframework.org/schema/data/repository"
  xmlns:oxm="http://www.springframework.org/schema/oxm"
  xsi:schemaLocation="http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/data/repository
    http://www.springframework.org/schema/data/repository/spring-repository.xsd
    http://www.springframework.org/schema/oxm
    http://www.springframework.org/schema/oxm/spring-oxm.xsd"&gt;

  &lt;repository:unmarshaller-populator locations="classpath:data.json"
    unmarshaller-ref="unmarshaller" /&gt;

  &lt;oxm:jaxb2-marshaller contextPath="com.acme" /&gt;

&lt;/beans&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="web.legacy">Legacy web support</h4>
<div class="sect4">
<h5 id="web-domain-class-binding">Domain class web binding for Spring MVC</h5>
<div class="paragraph">
<p>Given you are developing a Spring MVC web application you typically have to resolve domain class ids from URLs. By default your task is to transform that request parameter or URL part into the domain class to hand it to layers below then or execute business logic on the entities directly. This would look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">@Controller
@RequestMapping("/users")
public class UserController {

  private final UserRepository userRepository;

  @Autowired
  public UserController(UserRepository userRepository) {
    Assert.notNull(repository, "Repository must not be null!");
    this.userRepository = userRepository;
  }

  @RequestMapping("/{id}")
  public String showUserForm(@PathVariable("id") Long id, Model model) {

    // Do null check for id
    User user = userRepository.findOne(id);
    // Do null check for user

    model.addAttribute("user", user);
    return "user";
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>First you declare a repository dependency for each controller to look up the entity managed by the controller or repository respectively. Looking up the entity is boilerplate as well, as it&#8217;s always a <code>findOne(…)</code> call. Fortunately Spring provides means to register custom components that allow conversion between a <code>String</code> value to an arbitrary type.</p>
</div>
<div class="sect5">
<h6 id="propertyeditors">PropertyEditors</h6>
<div class="paragraph">
<p>For Spring versions before 3.0 simple Java <code>PropertyEditors</code> had to be used. To integrate with that, Spring Data offers a <code>DomainClassPropertyEditorRegistrar</code>, which looks up all Spring Data repositories registered in the <code>ApplicationContext</code> and registers a custom <code>PropertyEditor</code> for the managed domain class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;bean class="….web.servlet.mvc.annotation.AnnotationMethodHandlerAdapter"&gt;
  &lt;property name="webBindingInitializer"&gt;
    &lt;bean class="….web.bind.support.ConfigurableWebBindingInitializer"&gt;
      &lt;property name="propertyEditorRegistrars"&gt;
        &lt;bean class="org.springframework.data.repository.support.DomainClassPropertyEditorRegistrar" /&gt;
      &lt;/property&gt;
    &lt;/bean&gt;
  &lt;/property&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you have configured Spring MVC as in the preceding example, you can configure your controller as follows, which reduces a lot of the clutter and boilerplate.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">@Controller
@RequestMapping("/users")
public class UserController {

  @RequestMapping("/{id}")
  public String showUserForm(@PathVariable("id") User user, Model model) {

    model.addAttribute("user", user);
    return "userForm";
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>ConversionServiceIn Spring 3.0 and later the <code>PropertyEditor</code> support is superseded by a new conversion infrastructure that eliminates the drawbacks of <code>PropertyEditors</code> and uses a stateless X to Y conversion approach. Spring Data now ships with a <code>DomainClassConverter</code> that mimics the behavior of <code>DomainClassPropertyEditorRegistrar</code>. To configure, simply declare a bean instance and pipe the <code>ConversionService</code> being used into its constructor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;mvc:annotation-driven conversion-service="conversionService" /&gt;

&lt;bean class="org.springframework.data.repository.support.DomainClassConverter"&gt;
  &lt;constructor-arg ref="conversionService" /&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are using JavaConfig, you can simply extend Spring MVC&#8217;s <code>WebMvcConfigurationSupport</code> and hand the <code>FormatingConversionService</code> that the configuration superclass provides into the <code>DomainClassConverter</code> instance you create.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">class WebConfiguration extends WebMvcConfigurationSupport {

  // Other configuration omitted

  @Bean
  public DomainClassConverter&lt;?&gt; domainClassConverter() {
    return new DomainClassConverter&lt;FormattingConversionService&gt;(mvcConversionService());
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="web-pagination">Web pagination</h5>
<div class="paragraph">
<p>When working with pagination in the web layer you usually have to write a lot of boilerplate code yourself to extract the necessary metadata from the request. The less desirable approach shown in the example below requires the method to contain an <code>HttpServletRequest</code> parameter that has to be parsed manually. This example also omits appropriate failure handling, which would make the code even more verbose.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">@Controller
@RequestMapping("/users")
public class UserController {

  // DI code omitted

  @RequestMapping
  public String showUsers(Model model, HttpServletRequest request) {

    int page = Integer.parseInt(request.getParameter("page"));
    int pageSize = Integer.parseInt(request.getParameter("pageSize"));

    Pageable pageable = new PageRequest(page, pageSize);

    model.addAttribute("users", userService.getUsers(pageable));
    return "users";
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The bottom line is that the controller should not have to handle the functionality of extracting pagination information from the request. So Spring Data ships with a <code>PageableHandlerMethodArgumentResolver</code> that will do the work for you. The Spring MVC JavaConfig support exposes a <code>WebMvcConfigurationSupport</code> helper class to customize the configuration as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">@Configuration
public class WebConfig extends WebMvcConfigurationSupport {

  @Override
  protected void addArgumentResolvers(List&lt;HandlerMethodArgumentResolver&gt; argumentResolvers) {
    argumentResolvers.add(new PageableHandlerMethodArgumentResolver());
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you&#8217;re stuck with XML configuration you can register the resolver as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;bean class="….web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter"&gt;
  &lt;property name="customArgumentResolvers"&gt;
    &lt;list&gt;
      &lt;bean class="org.springframework.data.web.PageableHandlerMethodArgumentResolver" /&gt;
    &lt;/list&gt;
  &lt;/property&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you&#8217;ve configured the resolver with Spring MVC it allows you to simplify controllers down to something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">@Controller
@RequestMapping("/users")
public class UserController {

  @RequestMapping
  public String showUsers(Model model, Pageable pageable) {

    model.addAttribute("users", userRepository.findAll(pageable));
    return "users";
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>PageableArgumentResolver</code> automatically resolves request parameters to build a <code>PageRequest</code> instance. By default it expects the following structure for the request parameters.</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 100%;">
<caption class="title">Table 2. Request parameters evaluated by <code>PageableHandlerMethodArgumentResolver</code></caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>page</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Page you want to retrieve, 0 indexed and defaults to 0.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>size</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size of the page you want to retrieve, defaults to 20.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sort</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A collection of sort directives in the format `($propertyname,)[asc</p></td>
</tr>
</tbody>
</table>
<div class="exampleblock">
<div class="title">Example 28. Pagination URL Parameter Examples</div>
<div class="content">
<div class="paragraph">
<p>To retrieve the third page with a maximum page size of 100 with the data sorted by the email property in ascending order use the following url parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>?page=2&amp;size=100&amp;sort=email,asc</pre>
</div>
</div>
<div class="paragraph">
<p>To sort the data by multiple properties in different sort order use the following URL parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>?sort=foo,asc&amp;sort=bar,desc</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In case you need multiple <code>Pageable</code> instances to be resolved from the request (for multiple tables, for example) you can use Spring&#8217;s <code>@Qualifier</code> annotation to distinguish one from another. The request parameters then have to be prefixed with <code>${qualifier}_</code>. So for a method signature like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public String showUsers(Model model,
  @Qualifier("foo") Pageable first,
  @Qualifier("bar") Pageable second) { … }</code></pre>
</div>
</div>
<div class="paragraph">
<p>you have to populate <code>foo_page</code> and <code>bar_page</code> and the related subproperties.</p>
</div>
<div class="paragraph">
<p>Configuring a global default on bean declaration the <code>PageableArgumentResolver</code> will use a <code>PageRequest</code> with the first page and a page size of 10 by default. It will use that value if it cannot resolve a <code>PageRequest</code> from the request (because of missing parameters, for example). You can configure a global default on the bean declaration directly. If you might need controller method specific defaults for the <code>Pageable</code>, annotate the method parameter with @PageableDefaults and specify page (through <code>pageNumber</code>), page size (through <code>value</code>), <code>sort</code> (list of properties to sort by), and <code>sortDir</code> (the direction to sort by) as annotation attributes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public String showUsers(Model model,
  @PageableDefaults(pageNumber = 0, value = 30) Pageable pageable) { … }</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="reference">Reference Documentation</h2>
<div class="sectionbody">

</div>
</div>
<h1 id="document_structure" class="sect0">Document Structure</h1>
<div class="paragraph">
<p>This part of the reference documentation explains the core functionality offered by Spring Data Document.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>introduces the MongoDB module feature set.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>introduces the repository support for MongoDB.</pre>
</div>
</div>
<div class="sect1">
<h2 id="mongo.core">MongoDB support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The MongoDB support contains a wide range of features which are summarized below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Spring configuration support using Java based @Configuration classes or an XML namespace for a Mongo driver instance and replica sets</p>
</li>
<li>
<p>MongoTemplate helper class that increases productivity performing common Mongo operations. Includes integrated object mapping between documents and POJOs.</p>
</li>
<li>
<p>Exception translation into Spring&#8217;s portable Data Access Exception hierarchy</p>
</li>
<li>
<p>Feature Rich Object Mapping integrated with Spring&#8217;s Conversion Service</p>
</li>
<li>
<p>Annotation based mapping metadata but extensible to support other metadata formats</p>
</li>
<li>
<p>Persistence and mapping lifecycle events</p>
</li>
<li>
<p>Java based Query, Criteria, and Update DSLs</p>
</li>
<li>
<p>Automatic implementation of Repository interfaces including support for custom finder methods.</p>
</li>
<li>
<p>QueryDSL integration to support type-safe queries.</p>
</li>
<li>
<p>Cross-store persistance - support for JPA Entities with fields transparently persisted/retrieved using MongoDB</p>
</li>
<li>
<p>Log4j log appender</p>
</li>
<li>
<p>GeoSpatial integration</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For most tasks you will find yourself using <code>MongoTemplate</code> or the Repository support that both leverage the rich mapping functionality. MongoTemplate is the place to look for accessing functionality such as incrementing counters or ad-hoc CRUD operations. MongoTemplate also provides callback methods so that it is easy for you to get a hold of the low level API artifacts such as  to communicate directly with MongoDB. The goal with naming conventions on various API artifacts is to copy those in the base MongoDB Java driver so you can easily map your existing knowledge onto the Spring APIs.</p>
</div>
<div class="sect2">
<h3 id="mongodb-getting-started">Getting Started</h3>
<div class="paragraph">
<p>Spring MongoDB support requires MongoDB 1.4 or higher and Java SE 5 or higher. The latest production release (2.4.9 as of this writing) is recommended. An easy way to bootstrap setting up a working environment is to create a Spring based project in <a href="http://spring.io/tools/sts">STS</a>.</p>
</div>
<div class="paragraph">
<p>First you need to set up a running Mongodb server. Refer to the <a href="http://docs.mongodb.org/manual/core/introduction/">Mongodb Quick Start guide</a> for an explanation on how to startup a MongoDB instance. Once installed starting MongoDB is typically a matter of executing the following command:</p>
</div>
<div class="paragraph">
<p>To create a Spring project in STS go to File &#8594; New &#8594; Spring Template Project &#8594; Simple Spring Utility Project &#8594; press Yes when prompted. Then enter a project and a package name such as org.spring.mongodb.example.</p>
</div>
<div class="paragraph">
<p>Then add the following to pom.xml dependencies section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;dependencies&gt;

  &lt;!-- other dependency elements omitted --&gt;

  &lt;dependency&gt;
    &lt;groupId&gt;org.springframework.data&lt;/groupId&gt;
    &lt;artifactId&gt;spring-data-mongodb&lt;/artifactId&gt;
    &lt;version&gt;1.4.1.RELEASE&lt;/version&gt;
  &lt;/dependency&gt;

&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also change the version of Spring in the pom.xml to be</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;spring.framework.version&gt;3.2.8.RELEASE&lt;/spring.framework.version&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will also need to add the location of the Spring Milestone repository for maven to your pom.xml which is at the same level of your &lt;dependencies/&gt; element</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;repositories&gt;
  &lt;repository&gt;
    &lt;id&gt;spring-milestone&lt;/id&gt;
    &lt;name&gt;Spring Maven MILESTONE Repository&lt;/name&gt;
    &lt;url&gt;http://repo.spring.io/libs-milestone&lt;/url&gt;
  &lt;/repository&gt;
&lt;/repositories&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The repository is also <a href="http://shrub.appspot.com/maven.springframework.org/milestone/org/springframework/data/">browseable here</a>.</p>
</div>
<div class="paragraph">
<p>You may also want to set the logging level to <code>DEBUG</code> to see some additional information, edit the log4j.properties file to have</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>log4j.category.org.springframework.data.document.mongodb=DEBUG
log4j.appender.stdout.layout.ConversionPattern=%d{ABSOLUTE} %5p %40.40c:%4L - %m%n</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a simple Person class to persist</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">package org.spring.mongodb.example;

public class Person {

  private String id;
  private String name;
  private int age;

  public Person(String name, int age) {
    this.name = name;
    this.age = age;
  }

  public String getId() {
    return id;
  }
  public String getName() {
    return name;
  }
  public int getAge() {
    return age;
  }

  @Override
  public String toString() {
    return "Person [id=" + id + ", name=" + name + ", age=" + age + "]";
  }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And a main application to run</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">package org.spring.mongodb.example;

import static org.springframework.data.mongodb.core.query.Criteria.where;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.springframework.data.mongodb.core.MongoOperations;
import org.springframework.data.mongodb.core.MongoTemplate;
import org.springframework.data.mongodb.core.query.Query;

import com.mongodb.Mongo;

public class MongoApp {

  private static final Log log = LogFactory.getLog(MongoApp.class);

  public static void main(String[] args) throws Exception {

    MongoOperations mongoOps = new MongoTemplate(new Mongo(), "database");

    mongoOps.insert(new Person("Joe", 34));

    log.info(mongoOps.findOne(new Query(where("name").is("Joe")), Person.class));

    mongoOps.dropCollection("person");
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will produce the following output</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>10:01:32,062 DEBUG apping.MongoPersistentEntityIndexCreator:  80 - Analyzing class class org.spring.example.Person for index information.
10:01:32,265 DEBUG ramework.data.mongodb.core.MongoTemplate: 631 - insert DBObject containing fields: [_class, age, name] in collection: Person
10:01:32,765 DEBUG ramework.data.mongodb.core.MongoTemplate:1243 - findOne using query: { "name" : "Joe"} in db.collection: database.Person
10:01:32,953  INFO      org.spring.mongodb.example.MongoApp:  25 - Person [id=4ddbba3c0be56b7e1b210166, name=Joe, age=34]
10:01:32,984 DEBUG ramework.data.mongodb.core.MongoTemplate: 375 - Dropped collection [database.person]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Even in this simple example, there are few things to take notice of</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You can instantiate the central helper class of Spring Mongo, <a href="#mongo-template"><code>MongoTemplate</code></a>, using the standard <code>com.mongodb.Mongo</code> object and the name of the database to use.</p>
</li>
<li>
<p>The mapper works against standard POJO objects without the need for any additional metadata (though you can optionally provide that information. See <a href="#mongo.mapping">here</a>.).</p>
</li>
<li>
<p>Conventions are used for handling the id field, converting it to be a ObjectId when stored in the database.</p>
</li>
<li>
<p>Mapping conventions can use field access. Notice the Person class has only getters.</p>
</li>
<li>
<p>If the constructor argument names match the field names of the stored document, they will be used to instantiate the object</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="mongo.examples-repo">Examples Repository</h3>
<div class="paragraph">
<p>There is an <a href="https://github.com/spring-projects/spring-data-document-examples">github repository with several examples</a> that you can download and play around with to get a feel for how the library works.</p>
</div>
</div>
<div class="sect2">
<h3 id="mongodb-connectors">Connecting to MongoDB with Spring</h3>
<div class="paragraph">
<p>One of the first tasks when using MongoDB and Spring is to create a <code>com.mongodb.Mongo</code> object using the IoC container. There are two main ways to do this, either using Java based bean metadata or XML based bean metadata. These are discussed in the following sections.</p>
</div>
<div class="paragraph">
<p>For those not familiar with how to configure the Spring container using Java based bean metadata instead of XML based metadata see the high level introduction in the reference docs <a href="http://docs.spring.io/spring/docs/3.2.x/spring-framework-reference/html/new-in-3.0.html#new-java-configuration">here </a> as well as the detailed documentationhttp://docs.spring.io/spring/docs/3.2.x/spring-framework-reference/html/beans.html#beans-java-instantiating-container[ here].</p>
</div>
<div class="sect3">
<h4 id="mongo.mongo-java-config">Registering a Mongo instance using Java based metadata Registering a com.mongodb.Mongo object using Spring&#8217;s MongoFactoryBean and enabling Spring&#8217;s exception translation support</h4>
<div class="paragraph">
<p>An example of using Java based bean metadata to register an instance of a <code>com.mongodb.Mongo</code> is shown below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">@Configuration
public class AppConfig {

  /*
   * Use the standard Mongo driver API to create a com.mongodb.Mongo instance.
   */
   public @Bean Mongo mongo() throws UnknownHostException {
       return new Mongo("localhost");
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This approach allows you to use the standard <code>com.mongodb.Mongo</code> API that you may already be used to using but also pollutes the code with the UnknownHostException checked exception. The use of the checked exception is not desirable as Java based bean metadata uses methods as a means to set object dependencies, making the calling code cluttered.</p>
</div>
<div class="paragraph">
<p>An alternative is to register an instance of <code>com.mongodb.Mongo</code> instance with the container using Spring&#8217;s` MongoFactoryBean`. As compared to instantiating a <code>com.mongodb.Mongo</code> instance directly, the FactoryBean approach does not throw a checked exception and has the added advantage of also providing the container with an ExceptionTranslator implementation that translates MongoDB exceptions to exceptions in Spring&#8217;s portable <code>DataAccessException</code> hierarchy for data access classes annoated with the  annotation. This hierarchy and use of  is described in <a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/dao.html">Spring&#8217;s DAO support features</a>.</p>
</div>
<div class="paragraph">
<p>An example of a Java based bean metadata that supports exception translation on <code>@Repository</code> annotated classes is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">@Configuration
public class AppConfig {

    /*
     * Factory bean that creates the com.mongodb.Mongo instance
     */
     public @Bean MongoFactoryBean mongo() {
          MongoFactoryBean mongo = new MongoFactoryBean();
          mongo.setHost("localhost");
          return mongo;
     }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To access the <code>com.mongodb.Mongo</code> object created by the <code>MongoFactoryBean</code> in other  or your own classes, use a "" field.</p>
</div>
</div>
<div class="sect3">
<h4 id="mongo.mongo-xml-config">Registering a Mongo instance using XML based metadata XML schema to configure MongoDB XML schema to configure a com.mongodb.Mongo object with MongoOptions</h4>
<div class="paragraph">
<p>While you can use Spring&#8217;s traditional  XML namespace to register an instance of <code>com.mongodb.Mongo</code> with the container, the XML can be quite verbose as it is general purpose. XML namespaces are a better alternative to configuring commonly used objects such as the Mongo instance. The mongo namespace alows you to create a Mongo instance server location, replica-sets, and options.</p>
</div>
<div class="paragraph">
<p>To use the Mongo namespace elements you will need to reference the Mongo schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xmlns:context="http://www.springframework.org/schema/context"
          xmlns:mongo="http://www.springframework.org/schema/data/mongo"
          xsi:schemaLocation=
          "http://www.springframework.org/schema/context
          http://www.springframework.org/schema/context/spring-context-3.0.xsd

          http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans-3.0.xsd"&gt;

    &lt;!-- Default bean name is 'mongo' --&gt;


&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A more advanced configuration with MongoOptions is shown below (note these are not recommended values)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;beans&gt;

  &lt;mongo:mongo host="localhost" port="27017"&gt;
    &lt;mongo:options connections-per-host="8"
                   threads-allowed-to-block-for-connection-multiplier="4"
                   connect-timeout="1000"
                   max-wait-time="1500}"
                   auto-connect-retry="true"
                   socket-keep-alive="true"
                   socket-timeout="1500"
                   slave-ok="true"
                   write-number="1"
                   write-timeout="0"
                   write-fsync="true"/&gt;
  &lt;/mongo:mongo/&gt;

&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A configuration using replica sets is shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;mongo:mongo id="replicaSetMongo" replica-set="127.0.0.1:27017,localhost:27018"/&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo.mongo-db-factory">The MongoDbFactory interface</h4>
<div class="paragraph">
<p>While <code>com.mongodb.Mongo</code> is the entry point to the MongoDB driver API, connecting to a specific MongoDB database instance requires additional information such as the database name and an optional username and password. With that information you can obtain a com.mongodb.DB object and access all the functionality of a specific MongoDB database instance. Spring provides the <code>org.springframework.data.mongodb.core.MongoDbFactory</code> interface shown below to bootstrap connectivity to the database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public interface MongoDbFactory {

  DB getDb() throws DataAccessException;

  DB getDb(String dbName) throws DataAccessException;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following sections show how you can use the container with either Java or the XML based metadata to configure an instance of the <code>MongoDbFactory</code> interface. In turn, you can use the <code>MongoDbFactory</code> instance to configure MongoTemplate.</p>
</div>
<div class="paragraph">
<p>The class <code>org.springframework.data.mongodb.core.SimpleMongoDbFactory</code> provides implements the MongoDbFactory interface and is created with a standard <code>com.mongodb.Mongo</code> instance, the database name and an optional <code>org.springframework.data.authentication.UserCredentials</code> constructor argument.</p>
</div>
<div class="paragraph">
<p>Instead of using the IoC container to create an instance of MongoTemplate, you can just use them in standard Java code as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public class MongoApp {

  private static final Log log = LogFactory.getLog(MongoApp.class);

  public static void main(String[] args) throws Exception {

    MongoOperations mongoOps = new MongoTemplate();

    mongoOps.insert(new Person("Joe", 34));

    log.info(mongoOps.findOne(new Query(where("name").is("Joe")), Person.class));

    mongoOps.dropCollection("person");
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code in bold highlights the use of SimpleMongoDbFactory and is the only difference between the listing shown in the <a href="#mongodb-getting-started">getting started section</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="mongo.mongo-db-factory-java">Registering a MongoDbFactory instance using Java based metadata</h4>
<div class="paragraph">
<p>To register a MongoDbFactory instance with the container, you write code much like what was highlighted in the previous code listing. A simple example is shown below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">@Configuration
public class MongoConfiguration {

  public @Bean MongoDbFactory mongoDbFactory() throws Exception {
    return new SimpleMongoDbFactory(new Mongo(), "database");
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To define the username and password create an instance of <code>org.springframework.data.authentication.UserCredentials</code> and pass it into the constructor as shown below. This listing also shows using <code>MongoDbFactory</code> register an instance of MongoTemplate with the container.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">@Configuration
public class MongoConfiguration {

  public @Bean MongoDbFactory mongoDbFactory() throws Exception {
    UserCredentials userCredentials = new UserCredentials("joe", "secret");
    return new SimpleMongoDbFactory(new Mongo(), "database", userCredentials);
  }

  public @Bean MongoTemplate mongoTemplate() throws Exception {
    return new MongoTemplate(mongoDbFactory());
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo.mongo-db-factory-xml">Registering a MongoDbFactory instance using XML based metadata</h4>
<div class="paragraph">
<p>The mongo namespace provides a convient way to create a <code>SimpleMongoDbFactory</code> as compared to using the namespace. Simple usage is shown below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;mongo:db-factory dbname="database"&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example a <code>com.mongodb.Mongo</code> instance is created using the default host and port number. The <code>SimpleMongoDbFactory</code> registered with the container is identified by the id <em>mongoDbFactory</em> unless a value for the id attribute is specified.</p>
</div>
<div class="paragraph">
<p>You can also provide the host and port for the underlying <code>com.mongodb.Mongo</code> instance as shown below, in addition to username and password for the database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;mongo:db-factory id="anotherMongoDbFactory"
                  host="localhost"
                  port="27017"
                  dbname="database"
                  username="joe"
                  password="secret"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you need to configure additional options on the <code>com.mongodb.Mongo</code> instance that is used to create a <code>SimpleMongoDbFactory</code> you can refer to an existing bean using the  attribute as shown below. To show another common usage pattern, this listing show the use of a property placeholder to parameterise the configuration and creating <code>MongoTemplate</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;context:property-placeholder location="classpath:/com/myapp/mongodb/config/mongo.properties"/&gt;

&lt;mongo:mongo host="${mongo.host}" port="${mongo.port}"&gt;
  &lt;mongo:options
     connections-per-host="${mongo.connectionsPerHost}"
     threads-allowed-to-block-for-connection-multiplier="${mongo.threadsAllowedToBlockForConnectionMultiplier}"
     connect-timeout="${mongo.connectTimeout}"
     max-wait-time="${mongo.maxWaitTime}"
     auto-connect-retry="${mongo.autoConnectRetry}"
     socket-keep-alive="${mongo.socketKeepAlive}"
     socket-timeout="${mongo.socketTimeout}"
     slave-ok="${mongo.slaveOk}"
     write-number="1"
     write-timeout="0"
     write-fsync="true"/&gt;
&lt;/mongo:mongo&gt;

&lt;mongo:db-factory dbname="database" mongo-ref="mongo"/&gt;

&lt;bean id="anotherMongoTemplate" class="org.springframework.data.mongodb.core.MongoTemplate"&gt;
  &lt;constructor-arg name="mongoDbFactory" ref="mongoDbFactory"/&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo.auditing">General auditing configuration Activating auditing using XML configuration Activating auditing using JavaConfig</h3>
<div class="paragraph">
<p>Activating auditing functionality is just a matter of adding the Spring Data Mongo  namespace element to your configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;mongo:auditing mapping-context-ref="customMappingContext" auditor-aware-ref="yourAuditorAwareImpl"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since Spring Data MongoDB 1.4 auditing can be enabled by annotating a configuration class with the <code>@EnableMongoAuditing</code> annotation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">@Configuration
@EnableMongoAuditing
class Config {

    @Bean
    public AuditorAware&lt;AuditableUser&gt; myAuditorProvider() {
        return new AuditorAwareImpl();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you expose a bean of type <code>AuditorAware</code> to the <code>ApplicationContext</code>, the auditing infrastructure will pick it up automatically and use it to determine the current user to be set on domain types. If you have multiple implementations registered in the <code>ApplicationContext</code>, you can select the one to be used by explicitly setting the <code>auditorAwareRef</code> attribute of <code>@EnableJpaAuditing</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="mongo-template">Introduction to MongoTemplate</h3>
<div class="paragraph">
<p>The class <code>MongoTemplate</code>, located in the package , is the central class of the Spring&#8217;s MongoDB support providng a rich feature set to interact with the database. The template offers convenience operations to create, update, delete and query for MongoDB documents and provides a mapping between your domain objects and MongoDB documents.</p>
</div>
<div class="paragraph">
<p>Once configured, <code>MongoTemplate</code> is thread-safe and can be reused across multiple instances.</p>
</div>
<div class="paragraph">
<p>The mapping between MongoDB documents and domain classes is done by delegating to an implementation of the interface <code>MongoConverter</code>. Spring provides two implementations, <code>SimpleMappingConverter</code> and <code>MongoMappingConverter</code>, but you can also write your own converter. Please refer to the section on MongoCoverters for more detailed information.</p>
</div>
<div class="paragraph">
<p>The <code>MongoTemplate</code> class implements the interface <code>MongoOperations</code>. In as much as possible, the methods on <code>MongoOperations</code> are named after methods available on the MongoDB driver <code>Collection</code> object as as to make the API familiar to existing MongoDB developers who are used to the driver API. For example, you will find methods such as "find", "findAndModify", "findOne", "insert", "remove", "save", "update" and "updateMulti". The design goal was to make it as easy as possible to transition between the use of the base MongoDB driver and <code>MongoOperations</code>. A major difference in between the two APIs is that MongOperations can be passed domain objects instead of <code>DBObject</code> and there are fluent APIs for <code>Query</code>, <code>Criteria</code>, and <code>Update</code> operations instead of populating a <code>DBObject</code> to specify the parameters for those operatiosn.</p>
</div>
<div class="paragraph">
<p>The preferred way to reference the operations on <code>MongoTemplate</code> instance is via its interface <code>MongoOperations</code>.</p>
</div>
<div class="paragraph">
<p>The default converter implementation used by <code>MongoTemplate</code> is MongoMappingConverter. While the <code>MongoMappingConverter</code> can make use of additional metadata to specify the mapping of objects to documents it is also capable of converting objects that contain no additonal metadata by using some conventions for the mapping of IDs and collection names. These conventions as well as the use of mapping annotations is explained in the <a href="#mongo.mapping">Mapping chapter</a>.</p>
</div>
<div class="paragraph">
<p>In the M2 release <code>SimpleMappingConverter</code>, was the default and this class is now deprecated as its functionality has been subsumed by the MongoMappingConverter.</p>
</div>
<div class="paragraph">
<p>Another central feature of MongoTemplate is exception translation of exceptions thrown in the MongoDB Java driver into Spring&#8217;s portable Data Access Exception hierarchy. Refer to the section on <a href="#mongo.exception">exception translation</a> for more information.</p>
</div>
<div class="paragraph">
<p>While there are many convenience methods on <code>MongoTemplate</code> to help you easily perform common tasks if you should need to access the MongoDB driver API directly to access functionality not explicitly exposed by the MongoTemplate you can use one of several Execute callback methods to access underlying driver APIs. The execute callbacks will give you a reference to either a <code>com.mongodb.Collection</code> or a <code>com.mongodb.DB</code> object. Please see the section mongo.executioncallback[Execution Callbacks] for more information.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s look at a examples of how to work with the <code>MongoTemplate</code> in the context of the Spring container.</p>
</div>
<div class="sect3">
<h4 id="mongo-template.instantiating">Instantiating MongoTemplate Registering a com.mongodb.Mongo object and enabling Spring&#8217;s exception translation support</h4>
<div class="paragraph">
<p>You can use Java to create and register an instance of MongoTemplate as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">@Configuration
public class AppConfig {

    public @Bean Mongo mongo() throws Exception {
        return new Mongo("localhost");
    }

    public @Bean MongoTemplate mongoTemplate() throws Exception {
        return new MongoTemplate(mongo(), "mydatabase");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are several overloaded constructors of MongoTemplate. These are</p>
</div>
<div class="ulist">
<ul>
<li>
<p>- takes the <code>com.mongodb.Mongo</code> object and the default database name to operate against.</p>
</li>
<li>
<p>- adds the username and password for authenticating with the database.</p>
</li>
<li>
<p>- takes a MongoDbFactory object that encapsulated the <code>com.mongodb.Mongo</code> object, database name, and username and password.</p>
</li>
<li>
<p>- adds a MongoConverter to use for mapping.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can also configure a MongoTemplate using Spring&#8217;s XML &lt;beans/&gt; schema.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">  &lt;mongo:mongo host="localhost" port="27017"/&gt;

  &lt;bean id="mongoTemplate" class="org.springframework.data.mongodb.core.MongoTemplate"&gt;
    &lt;constructor-arg ref="mongo"/&gt;
    &lt;constructor-arg name="databaseName" value="geospatial"/&gt;
  &lt;/bean&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Other optional properties that you might like to set when creating a <code>MongoTemplate</code> are the default <code>WriteResultCheckingPolicy</code>, <code>WriteConcern</code>, and <code>ReadPreference</code>.</p>
</div>
<div class="paragraph">
<p>The preferred way to reference the operations on <code>MongoTemplate</code> instance is via its interface <code>MongoOperations</code>.</p>
</div>
<div class="sect4">
<h5 id="mongo-template.writeresultchecking">WriteResultChecking Policy</h5>
<div class="paragraph">
<p>When in development it is very handy to either log or throw an exception if the <code>com.mongodb.WriteResult</code> returned from any MongoDB operation contains an error. It is quite common to forget to do this during development and then end up with an application that looks like it runs successfully but in fact the database was not modified according to your expectations. Set MongoTemplate&#8217;s  property to an enum with the following values, LOG, EXCEPTION, or NONE to either log the error, throw and exception or do nothing. The default is to use a  value of NONE.</p>
</div>
</div>
<div class="sect4">
<h5 id="mongo-template.writeconcern">WriteConcern</h5>
<div class="paragraph">
<p>You can set the <code>com.mongodb.WriteConcern</code> property that the <code>MongoTemplate</code> will use for write operations if it has not yet been specified via the driver at a higher level such as <code>com.mongodb.Mongo</code>. If MongoTemplate&#8217;s <code>WriteConcern</code> property is not set it will default to the one set in the MongoDB driver&#8217;s DB or Collection setting.</p>
</div>
</div>
<div class="sect4">
<h5 id="mongo-template.writeconcernresolver">WriteConcernResolver</h5>
<div class="paragraph">
<p>For more advanced cases where you want to set different <code>WriteConcern</code> values on a per-operation basis (for remove, update, insert and save operations), a strategy interface called <code>WriteConcernResolver</code> can be configured on <code>MongoTemplate</code>. Since <code>MongoTemplate</code> is used to persist POJOs, the <code>WriteConcernResolver</code> lets you create a policy that can map a specific POJO class to a <code>WriteConcern</code> value. The <code>WriteConcernResolver</code> interface is shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public interface WriteConcernResolver {
  WriteConcern resolve(MongoAction action);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The passed in argument, MongoAction, is what you use to determine the <code>WriteConcern</code> value to be used or to use the value of the Template itself as a default. <code>MongoAction</code> contains the collection name being written to, the <code>java.lang.Class</code> of the POJO, the converted <code>DBObject</code>, as well as the operation as an enumeration (<code>MongoActionOperation</code>: REMOVE, UPDATE, INSERT, INSERT_LIST, SAVE) and a few other pieces of contextual information. For example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>private class MyAppWriteConcernResolver implements WriteConcernResolver {

  public WriteConcern resolve(MongoAction action) {
    if (action.getEntityClass().getSimpleName().contains("Audit")) {
      return WriteConcern.NONE;
    } else if (action.getEntityClass().getSimpleName().contains("Metadata")) {
      return WriteConcern.JOURNAL_SAFE;
    }
    return action.getDefaultWriteConcern();
  }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo-template.save-update-remove">Saving, Updating, and Removing Documents</h3>
<div class="paragraph">
<p><code>MongoTemplate</code> provides a simple way for you to save, update, and delete your domain objects and map those objects to documents stored in MongoDB.</p>
</div>
<div class="paragraph">
<p>Given a simple class such as Person</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public class Person {

  private String id;
  private String name;
  private int age;

  public Person(String name, int age) {
    this.name = name;
    this.age = age;
  }

  public String getId() {
    return id;
  }
  public String getName() {
    return name;
  }
  public int getAge() {
    return age;
  }

  @Override
  public String toString() {
    return "Person [id=" + id + ", name=" + name + ", age=" + age + "]";
  }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can save, update and delete the object as shown below.</p>
</div>
<div class="paragraph">
<p><code>MongoOperations</code> is the interface that <code>MongoTemplate</code> implements.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">package org.spring.example;

import static org.springframework.data.mongodb.core.query.Criteria.where;
import static org.springframework.data.mongodb.core.query.Update.update;
import static org.springframework.data.mongodb.core.query.Query.query;

import java.util.List;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.springframework.data.mongodb.core.MongoOperations;
import org.springframework.data.mongodb.core.MongoTemplate;
import org.springframework.data.mongodb.core.SimpleMongoDbFactory;

import com.mongodb.Mongo;

public class MongoApp {

  private static final Log log = LogFactory.getLog(MongoApp.class);

  public static void main(String[] args) throws Exception {

    MongoOperations mongoOps = new MongoTemplate(new SimpleMongoDbFactory(new Mongo(), "database"));

    Person p = new Person("Joe", 34);

    // Insert is used to initially store the object into the database.
    mongoOps.insert(p);
    log.info("Insert: " + p);

    // Find
    p = mongoOps.findById(p.getId(), Person.class);
    log.info("Found: " + p);

    // Update
    mongoOps.updateFirst(query(where("name").is("Joe")), update("age", 35), Person.class);
    p = mongoOps.findOne(query(where("name").is("Joe")), Person.class);
    log.info("Updated: " + p);

    // Delete
    mongoOps.remove(p);

    // Check that deletion worked
    List&lt;Person&gt; people =  mongoOps.findAll(Person.class);
    log.info("Number of people = : " + people.size());


    mongoOps.dropCollection(Person.class);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This would produce the following log output (including debug messages from <code>MongoTemplate</code> itself)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>DEBUG apping.MongoPersistentEntityIndexCreator:  80 - Analyzing class class org.spring.example.Person for index information.
DEBUG work.data.mongodb.core.MongoTemplate: 632 - insert DBObject containing fields: [_class, age, name] in collection: person
INFO               org.spring.example.MongoApp:  30 - Insert: Person [id=4ddc6e784ce5b1eba3ceaf5c, name=Joe, age=34]
DEBUG work.data.mongodb.core.MongoTemplate:1246 - findOne using query: { "_id" : { "$oid" : "4ddc6e784ce5b1eba3ceaf5c"}} in db.collection: database.person
INFO               org.spring.example.MongoApp:  34 - Found: Person [id=4ddc6e784ce5b1eba3ceaf5c, name=Joe, age=34]
DEBUG work.data.mongodb.core.MongoTemplate: 778 - calling update using query: { "name" : "Joe"} and update: { "$set" : { "age" : 35}} in collection: person
DEBUG work.data.mongodb.core.MongoTemplate:1246 - findOne using query: { "name" : "Joe"} in db.collection: database.person
INFO               org.spring.example.MongoApp:  39 - Updated: Person [id=4ddc6e784ce5b1eba3ceaf5c, name=Joe, age=35]
DEBUG work.data.mongodb.core.MongoTemplate: 823 - remove using query: { "id" : "4ddc6e784ce5b1eba3ceaf5c"} in collection: person
INFO               org.spring.example.MongoApp:  46 - Number of people = : 0
DEBUG work.data.mongodb.core.MongoTemplate: 376 - Dropped collection [database.person]</code></pre>
</div>
</div>
<div class="paragraph">
<p>There was implicit conversion using the <code>MongoConverter</code> between a <code>String</code> and <code>ObjectId</code> as stored in the database and recognizing a convention of the property "Id" name.</p>
</div>
<div class="paragraph">
<p>This example is meant to show the use of save, update and remove operations on MongoTemplate and not to show complex mapping functionality</p>
</div>
<div class="paragraph">
<p>The query syntax used in the example is explained in more detail in the section <a href="#mongo.query">Querying Documents</a>.</p>
</div>
<div class="sect3">
<h4 id="mongo-template.id-handling">How the <em>_id</em> field is handled in the mapping layer</h4>
<div class="paragraph">
<p>MongoDB requires that you have an <em>_id</em> field for all documents. If you don&#8217;t provide one the driver will assign a <code>ObjectId</code> with a generated value. When using the <code>MongoMappingConverter</code> there are certain rules that govern how properties from the Java class is mapped to this <em>_id</em> field.</p>
</div>
<div class="paragraph">
<p>The following outlines what property will be mapped to the <em>_id</em> document field:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A property or field annotated with <code>@Id</code> (<code>org.springframework.data.annotation.Id</code>) will be mapped to the <em>_id</em> field.</p>
</li>
<li>
<p>A property or field without an annotation but named <code>id</code> will be mapped to the <em>_id</em> field.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following outlines what type conversion, if any, will be done on the property mapped to the _id document field when using the <code>MappingMongoConverter</code>, the default for <code>MongoTemplate</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An id property or field declared as a String in the Java class will be converted to and stored as an <code>ObjectId</code> if possible using a Spring <code>Converter&lt;String, ObjectId&gt;</code>. Valid conversion rules are delegated to the MongoDB Java driver. If it cannot be converted to an ObjectId, then the value will be stored as a string in the database.</p>
</li>
<li>
<p>An id property or field declared as <code>BigInteger</code> in the Java class will be converted to and stored as an <code>ObjectId</code> using a Spring <code>Converter&lt;BigInteger, ObjectId&gt;</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If no field or property specified above is present in the Java class then an implicit <em>_id</em> file will be generated by the driver but not mapped to a property or field of the Java class.</p>
</div>
<div class="paragraph">
<p>When querying and updating <code>MongoTemplate</code> will use the converter to handle conversions of the <code>Query</code> and <code>Update</code> objects that correspond to the above rules for saving documents so field names and types used in your queries will be able to match what is in your domain classes.</p>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.type-mapping">Type mapping Type mapping</h4>
<div class="paragraph">
<p>As MongoDB collections can contain documents that represent instances of a variety of types. A great example here is if you store a hierarchy of classes or simply have a class with a property of type <code>Object</code>. In the latter case the values held inside that property have to be read in correctly when retrieving the object. Thus we need a mechanism to store type information alongside the actual document.</p>
</div>
<div class="paragraph">
<p>To achieve that the <code>MappingMongoConverter</code> uses a <code>MongoTypeMapper</code> abstraction with <code>DefaultMongoTypeMapper</code> as it&#8217;s main implementation. It&#8217;s default behaviour is storing the fully qualified classname under <code>_class</code> inside the document for the top-level document as well as for every value if it&#8217;s a complex type and a subtype of the property type declared.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public class Sample {
  Contact value;
}

public abstract class Contact { … }

public class Person extends Contact { … }

Sample sample = new Sample();
sample.value = new Person();

mongoTemplate.save(sample);

{ "_class" : "com.acme.Sample",
  "value" : { "_class" : "com.acme.Person" }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see we store the type information for the actual root class persistent as well as for the nested type as it is complex and a subtype of <code>Contact</code>. So if you&#8217;re now using <code>mongoTemplate.findAll(Object.class, "sample")</code> we are able to find out that the document stored shall be a <code>Sample</code> instance. We are also able to find out that the value property shall be a <code>Person</code> actually.</p>
</div>
<div class="sect4">
<h5 id="nullnull">Customizing type mapping Defining a TypeAlias for an Entity</h5>
<div class="paragraph">
<p>In case you want to avoid writing the entire Java class name as type information but rather like to use some key you can use the <code>@TypeAlias</code> annotation at the entity class being persisted. If you need to customize the mapping even more have a look at the <code>TypeInformationMapper</code> interface. An instance of that interface can be configured at the <code>DefaultMongoTypeMapper</code> which can be configured in turn on <code>MappingMongoConverter</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">@TypeAlias("pers")
class Person {

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the resulting document will contain <code>"pers"</code> as the value in the <code>_class</code> Field.</p>
</div>
</div>
<div class="sect4">
<h5 id="nullnullnull">Configuring custom type mapping Configuring a custom MongoTypeMapper via Spring Java Config Configuring a custom MongoTypeMapper via XML</h5>
<div class="paragraph">
<p>The following example demonstrates how to configure a custom <code>MongoTypeMapper</code> in <code>MappingMongoConverter</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">class CustomMongoTypeMapper extends DefaultMongoTypeMapper {
  //implement custom type mapping here
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">@Configuration
class SampleMongoConfiguration extends AbstractMongoConfiguration {

    @Override
    protected String getDatabaseName() {
        return "database";
    }

    @Override
    public Mongo mongo() throws Exception {
        return new Mongo();
    }

    @Bean
    @Override
    public MappingMongoConverter mappingMongoConverter() throws Exception {
        MappingMongoConverter mmc = super.mappingMongoConverter();
        mmc.setTypeMapper(customTypeMapper());
        return mmc;
    }

    @Bean
    public MongoTypeMapper customTypeMapper() {
        return new CustomMongoTypeMapper();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that we are extending the <code>AbstractMongoConfiguration</code> class and override the bean definition of the <code>MappingMongoConverter</code> where we configure our custom <code>MongoTypeMapper</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;mongo:mapping-converter type-mapper-ref="customMongoTypeMapper"/&gt;

&lt;bean name="customMongoTypeMapper" class="com.bubu.mongo.CustomMongoTypeMapper"/&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.save-insert">Methods for saving and inserting documents Inserting and retrieving documents using the MongoTemplate</h4>
<div class="paragraph">
<p>There are several convenient methods on <code>MongoTemplate</code> for saving and inserting your objects. To have more fine grained control over the conversion process you can register Spring converters with the <code>MappingMongoConverter</code>, for example  <code>Converter&lt;Person, DBObject&gt;</code> and <code>Converter&lt;DBObject, Person&gt;</code>.</p>
</div>
<div class="paragraph">
<p>The difference between insert and save operations is that a save operation will perform an insert if the object is not already present.</p>
</div>
<div class="paragraph">
<p>The simple case of using the save operation is to save a POJO. In this case the collection name will be determined by name (not fully qualfied) of the class. You may also call the save operation with a specific collection name. The collection to store the object can be overriden using mapping metadata.</p>
</div>
<div class="paragraph">
<p>When inserting or saving, if the Id property is not set, the assumption is that its value will be auto-generated by the database. As such, for auto-generation of an ObjectId to succeed the type of the Id property/field in your class must be either a <code>String</code>, <code>ObjectId</code>, or <code>BigInteger</code>.</p>
</div>
<div class="paragraph">
<p>Here is a basic example of using the save operation and retrieving its contents.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">import static org.springframework.data.mongodb.core.query.Criteria.where;
import static org.springframework.data.mongodb.core.query.Criteria.query;

…

Person p = new Person("Bob", 33);
mongoTemplate.insert(p);

Person qp = mongoTemplate.findOne(query(where("age").is(33)), Person.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The insert/save operations available to you are listed below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Save the object to the default collection.</p>
</li>
<li>
<p>Save the object to the specified collection.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A similar set of insert operations is listed below</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Insert the object to the default collection.</p>
</li>
<li>
<p>Insert the object to the specified collection.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="mongo-template.save-insert.collection">Which collection will my documents be saved into?</h5>
<div class="paragraph">
<p>There are two ways to manage the collection name that is used for operating on the documents. The default collection name that is used is the class name changed to start with a lower-case letter. So a <code>com.test.Person</code> class would be stored in the "person" collection. You can customize this by providing a different collection name using the @Document annotation. You can also override the collection name by providing your own collection name as the last parameter for the selected MongoTemplate method calls.</p>
</div>
</div>
<div class="sect4">
<h5 id="mongo-template.save-insert.individual">Inserting or saving individual objects</h5>
<div class="paragraph">
<p>The MongoDB driver supports inserting a collection of documents in one operation. The methods in the MongoOperations interface that support this functionality are listed below</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Insert an object. If there is an existing document with the same id then an error is generated.</p>
</li>
<li>
<p>Takes a of objects as the first parameter. This method inspects each object and inserts it to the appropriate collection based on the rules specified above.</p>
</li>
<li>
<p>Save the object overwriting any object that might exist with the same id.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="mongo-template.save-insert.batch">Inserting several objects in a batch</h5>
<div class="paragraph">
<p>The MongoDB driver supports inserting a collection of documents in one operation. The methods in the MongoOperations interface that support this functionality are listed below</p>
</div>
<div class="ulist">
<ul>
<li>
<p>This inserts a list of objects in a single batch write to the database.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongodb-template-update">Updating documents in a collection Updating documents using the MongoTemplate</h4>
<div class="paragraph">
<p>For updates we can elect to update the first document found using <code>MongoOperation</code>'s method  or we can update all documents that were found to match the query using the method . Here is an example of an update of all SAVINGS accounts where we are adding a one time $50.00 bonus to the balance using the  operator.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">import static org.springframework.data.mongodb.core.query.Criteria.where;
import static org.springframework.data.mongodb.core.query.Query;
import static org.springframework.data.mongodb.core.query.Update;

          ...

  WriteResult wr = mongoTemplate.updateMulti(new Query(where("accounts.accountType").is(Account.Type.SAVINGS)),
                                                            new Update().inc("accounts.$.balance", 50.00),
                                                            Account.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition to the <code>Query</code> discussed above we provide the update definition using an <code>Update</code> object. The <code>Update</code> class has methods that match the update modifiers available for MongoDB.</p>
</div>
<div class="paragraph">
<p>As you can see most methods return the <code>Update</code> object to provide a fluent style for the API.</p>
</div>
<div class="sect4">
<h5 id="mongodb-template-update.methods">Methods for executing updates for documents</h5>
<div class="ulist">
<ul>
<li>
<p>Updates the first document that matches the query document criteria with the provided updated document.</p>
</li>
<li>
<p>Updates all objects that match the query document criteria with the provided updated document.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="mongodb-template-update.update">Methods for the Update class</h5>
<div class="paragraph">
<p>The Update class can be used with a little <em>syntax sugar</em> as its methods are meant to be chained together and you can kick-start the creation of a new Update instance via the static method  and using static imports.</p>
</div>
<div class="paragraph">
<p>Here is a listing of methods on the Update class</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Update using the  update modifier</p>
</li>
<li>
<p>Update using the  update modifier</p>
</li>
<li>
<p>Update using the  update modifier</p>
</li>
<li>
<p>Update using the  update modifier</p>
</li>
<li>
<p>Update using the  update modifier</p>
</li>
<li>
<p>Update using the  update modifier</p>
</li>
<li>
<p>Update using the  update modifier</p>
</li>
<li>
<p>Update using the  update modifier</p>
</li>
<li>
<p>Update using the  update modifier</p>
</li>
<li>
<p>Update using the  update modifier</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.upserts">Upserting documents in a collection</h4>
<div class="paragraph">
<p>Related to performing an <code>updateFirst</code> operations, you can also perform an upsert operation which will perform an insert if no document is found that matches the query. The document that is inserted is a combination of the query document and the update document. Here is an example</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>template.upsert(query(where("ssn").is(1111).and("firstName").is("Joe").and("Fraizer").is("Update")), update("address", addr), Person.class);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.find-and-upsert">Finding and Upserting documents in a collection</h4>
<div class="paragraph">
<p>The <code>findAndModify(…)</code> method on DBCollection can update a document and return either the old or newly updated document in a single operation. <code>MongoTemplate</code> provides a findAndModify method that takes <code>Query</code> and <code>Update</code> classes and converts from <code>DBObject</code> to your POJOs. Here are the methods</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">&lt;T&gt; T findAndModify(Query query, Update update, Class&lt;T&gt; entityClass);

&lt;T&gt; T findAndModify(Query query, Update update, Class&lt;T&gt; entityClass, String collectionName);

&lt;T&gt; T findAndModify(Query query, Update update, FindAndModifyOptions options, Class&lt;T&gt; entityClass);

&lt;T&gt; T findAndModify(Query query, Update update, FindAndModifyOptions options, Class&lt;T&gt; entityClass, String collectionName);</code></pre>
</div>
</div>
<div class="paragraph">
<p>As an example usage, we will insert of few <code>Person</code> objects into the container and perform a simple findAndUpdate operation</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">mongoTemplate.insert(new Person("Tom", 21));
mongoTemplate.insert(new Person("Dick", 22));
mongoTemplate.insert(new Person("Harry", 23));

Query query = new Query(Criteria.where("firstName").is("Harry"));
Update update = new Update().inc("age", 1);
Person p = mongoTemplate.findAndModify(query, update, Person.class); // return's old person object

assertThat(p.getFirstName(), is("Harry"));
assertThat(p.getAge(), is(23));
p = mongoTemplate.findOne(query, Person.class);
assertThat(p.getAge(), is(24));


// Now return the newly updated document when updating
p = template.findAndModify(query, update, new FindAndModifyOptions().returnNew(true), Person.class);
assertThat(p.getAge(), is(25));</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>FindAndModifyOptions</code> lets you set the options of returnNew, upsert, and remove. An example extending off the previous code snippit is shown below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">Query query2 = new Query(Criteria.where("firstName").is("Mary"));
p = mongoTemplate.findAndModify(query2, update, new FindAndModifyOptions().returnNew(true).upsert(true), Person.class);
assertThat(p.getFirstName(), is("Mary"));
assertThat(p.getAge(), is(1));</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.delete">Methods for removing documents</h4>
<div class="paragraph">
<p>You can use several overloaded methods to remove an object from the database.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Remove the given document based on one of the following: a specific object instance, a query document criteria combined with a class or a query document criteria combined with a specific collection name.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo.query">Querying Documents Creating a Query instance from a plain JSON String</h3>
<div class="paragraph">
<p>You can express your queries using the <code>Query</code> and <code>Criteria</code> classes which have method names that mirror the native MongoDB operator names such as , , , and others. The <code>Query</code> and <code>Criteria</code> classes follow a fluent API style so that you can easily chain together multiple method criteria and queries while having easy to understand code. Static imports in Java are used to help remove the need to see the <em>new</em> keyword for creating <code>Query</code> and <code>Criteria</code> instances so as to improve readability. If you like to create <code>Query</code> instances from a plain JSON String use <code>BasicQuery</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">BasicQuery query = new BasicQuery("{ age : { $lt : 50 }, accounts.balance : { $gt : 1000.00 }}");
List&lt;Person&gt; result = mongoTemplate.find(query, Person.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>GeoSpatial queries are also supported and are described more in the section <a href="#mongo.geospatial">GeoSpatial Queries</a>.</p>
</div>
<div class="paragraph">
<p>Map-Reduce operations are also supported and are described more in the section <a href="#mongo.mapreduce">Map-Reduce</a>.</p>
</div>
<div class="sect3">
<h4 id="mongodb-template-query">Querying documents in a collection Querying for documents using the MongoTemplate</h4>
<div class="paragraph">
<p>We saw how to retrieve a single document using the findOne and findById methods on MongoTemplate in previous sections which return a single domain object. We can also query for a collection of documents to be returned as a list of domain objects. Assuming that we have a number of Person objects with name and age stored as documents in a collection and that each person has an embedded account document with a balance. We can now run a query using the following code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">import static org.springframework.data.mongodb.core.query.Criteria.where;
import static org.springframework.data.mongodb.core.query.Query.query;

…

List&lt;Person&gt; result = mongoTemplate.find(query(where("age").lt(50)
                                                .and("accounts.balance").gt(1000.00d)), Person.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>All find methods take a <code>Query</code> object as a parameter. This object defines the criteria and options used to perform the query. The criteria is specified using a <code>Criteria</code> object that has a static factory method named <code>where</code> used to instantiate a new <code>Criteria</code> object. We recommend using a static import for <code>org.springframework.data.mongodb.core.query.Criteria.where</code> and  to make the query more readable.</p>
</div>
<div class="paragraph">
<p>This query should return a list of <code>Person</code> objects that meet the specified criteria. The <code>Criteria</code> class has the following methods that correspond to the operators provided in MongoDB.</p>
</div>
<div class="paragraph">
<p>As you can see most methods return the <code>Criteria</code> object to provide a fluent style for the API.</p>
</div>
<div class="sect4">
<h5 id="mongodb-template-query.criteria">Methods for the Criteria class</h5>
<div class="ulist">
<ul>
<li>
<p>Creates a criterion using the  operator</p>
</li>
<li>
<p>Adds a chained <code>Criteria</code> with the specified  to the current <code>Criteria</code> and returns the newly created one</p>
</li>
<li>
<p>Creates an and query using the  operator for all of the provided criteria (requires MongoDB 2.0 or later)</p>
</li>
<li>
<p>Creates a criterion using the  operator</p>
</li>
<li>
<p>Creates a criterion using the  operator</p>
</li>
<li>
<p>Creates a criterion using the  operator</p>
</li>
<li>
<p>Creates a criterion using the  operator</p>
</li>
<li>
<p>Creates a criterion using the  operator for a varargs argument.</p>
</li>
<li>
<p>Creates a criterion using the  operator using a collection</p>
</li>
<li>
<p>Creates a criterion using the  operator</p>
</li>
<li>
<p>Creates a criterion using the  operator</p>
</li>
<li>
<p>Creates a criterion using the  operator</p>
</li>
<li>
<p>Creates a criterion using the  operator</p>
</li>
<li>
<p>Creates a criterion using the  operator</p>
</li>
<li>
<p>Creates a criterion using the  operator</p>
</li>
<li>
<p>Creates an nor query using the  operator for all of the provided criteria</p>
</li>
<li>
<p>Creates a criterion using the  meta operator which affects the clause directly following</p>
</li>
<li>
<p>Creates an or query using the  operator for all of the provided  criteria</p>
</li>
<li>
<p>Creates a criterion using a</p>
</li>
<li>
<p>Creates a criterion using the  operator</p>
</li>
<li>
<p>Creates a criterion using the  operator</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are also methods on the Criteria class for geospatial queries. Here is a listing but look at the section on <a href="#mongo.geospatial">GeoSpatial Queries</a> to see them in action.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Creates a geospatial criterion using  operators</p>
</li>
<li>
<p>Creates a geospatial criterion using  operators. This is only available for MongoDB 1.7 and higher.</p>
</li>
<li>
<p>Creates a geospatial criterion using a  operation</p>
</li>
<li>
<p>Creates a geospatial criterion using a operation</p>
</li>
<li>
<p>Creates a geospatial criterion using  operations. This is only available for MongoDB 1.7 and higher.</p>
</li>
<li>
<p>Creates a geospatial criterion using the  operation, for use with $near.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>Query</code> class has some additional methods used to provide options for the query.</p>
</div>
</div>
<div class="sect4">
<h5 id="mongodb-template-query.query">Methods for the Query class</h5>
<div class="ulist">
<ul>
<li>
<p>used to add additional criteria to the query</p>
</li>
<li>
<p>used to define fields to be included in the query results</p>
</li>
<li>
<p>used to limit the size of the returned results to the provided limit (used for paging)</p>
</li>
<li>
<p>used to skip the provided number of documents in the results (used for paging)</p>
</li>
<li>
<p>used to provide sort definition for the results</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.querying">Methods for querying for documents</h4>
<div class="paragraph">
<p>The query methods need to specify the target type T that will be returned and they are also overloaded with an explicit collection name for queries that should operate on a collection other than the one indicated by the return type.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Query for a list of objects of type T from the collection.</p>
</li>
<li>
<p>Map the results of an ad-hoc query on the collection to a single instance of an object of the specified type.</p>
</li>
<li>
<p>Return an object of the given id and target class.</p>
</li>
<li>
<p>Map the results of an ad-hoc query on the collection to a List of the specified type.</p>
</li>
<li>
<p>Map the results of an ad-hoc query on the collection to a single instance of an object of the specified type. The first document that matches the query is returned and also removed from the collection in the database.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="mongo.geospatial">GeoSpatial Queries</h4>
<div class="paragraph">
<p>MongoDB supports GeoSpatial queries through the use of operators such as , , and . Methods specific to geospatial queries are available on the <code>Criteria</code> class. There are also a few shape classes, <code>Box</code>, <code>Circle</code>, and <code>Point</code> that are used in conjunction with geospatial related <code>Criteria</code> methods.</p>
</div>
<div class="paragraph">
<p>To understand how to perform GeoSpatial queries we will use the following Venue class taken from the integration tests.which relies on using the rich <code>MappingMongoConverter</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">@Document(collection="newyork")
public class Venue {

  @Id
  private String id;
  private String name;
  private double[] location;

  @PersistenceConstructor
  Venue(String name, double[] location) {
    super();
    this.name = name;
    this.location = location;
  }

  public Venue(String name, double x, double y) {
    super();
    this.name = name;
    this.location = new double[] { x, y };
  }

  public String getName() {
    return name;
  }

  public double[] getLocation() {
    return location;
  }

  @Override
  public String toString() {
    return "Venue [id=" + id + ", name=" + name + ", location="
        + Arrays.toString(location) + "]";
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To find locations within a <code>Circle</code>, the following query can be used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">Circle circle = new Circle(-73.99171, 40.738868, 0.01);
List&lt;Venue&gt; venues =
    template.find(new Query(Criteria.where("location").withinCenter(circle)), Venue.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To find venues within a <code>Circle</code> using spherical coordinates the following query can be used</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">Circle circle = new Circle(-73.99171, 40.738868, 0.003712240453784);
List&lt;Venue&gt; venues =
    template.find(new Query(Criteria.where("location").withinCenterSphere(circle)), Venue.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To find venues within a <code>Box</code> the following query can be used</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">//lower-left then upper-right
Box box = new Box(new Point(-73.99756, 40.73083), new Point(-73.988135, 40.741404));
List&lt;Venue&gt; venues =
    template.find(new Query(Criteria.where("location").withinBox(box)), Venue.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To find venues near a <code>Point</code>, the following query can be used</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">Point point = new Point(-73.99171, 40.738868);
List&lt;Venue&gt; venues =
    template.find(new Query(Criteria.where("location").near(point).maxDistance(0.01)), Venue.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To find venues near a <code>Point</code> using spherical coordines the following query can be used</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">Point point = new Point(-73.99171, 40.738868);
List&lt;Venue&gt; venues =
    template.find(new Query(
        Criteria.where("location").nearSphere(point).maxDistance(0.003712240453784)),
        Venue.class);</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="mongo.geo-near">Geo near queries</h5>
<div class="paragraph">
<p>MongoDB supports querying the database for geo locations and calculation the distance from a given origin at the very same time. With geo-near queries it&#8217;s possible to express queries like: "find all restaurants in the surrounding 10 miles". To do so <code>MongoOperations</code> provides <code>geoNear(…)</code> methods taking a <code>NearQuery</code> as argument as well as the already familiar entity type and collection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">Point location = new Point(-73.99171, 40.738868);
NearQuery query = NearQuery.near(location).maxDistance(new Distance(10, Metrics.MILES));

GeoResults&lt;Restaurant&gt; = operations.geoNear(query, Restaurant.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see we use the <code>NearQuery</code> builder API to set up a query to return all <code>Restaurant</code> instances surrounding the given <code>Point</code> by 10 miles maximum. The <code>Metrics</code> enum used here actually implements an interface so that other metrics could be plugged into a distance as well. A <code>Metric</code> is backed by a multiplier to transform the distance value of the given metric into native distances. The sample shown here would consider the 10 to be miles. Using one of the pre-built in metrics (miles and kilometers) will automatically trigger the spherical flag to be set on the query. If you want to avoid that, simply hand in plain <code>double</code> values into <code>maxDistance(…)</code>. For more information see the JavaDoc of <code>NearQuery</code> and <code>Distance</code>.</p>
</div>
<div class="paragraph">
<p>The geo near operations return a <code>GeoResults</code> wrapper object that encapsulates <code>GeoResult</code> instances. The wrapping <code>GeoResults</code> allows to access the average distance of all results. A single <code>GeoResult</code> object simply carries the entity found plus its distance from the origin.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo.textsearch">Full Text Queries Full Text Search</h4>
<div class="paragraph">
<p>Since mongodb 2.6 full text queries can be excuted using the  operator. Methods and operations specific for full text queries are available in <code>TextQuery</code> and <code>TextCriteria</code>. When doing full text search please refer to the <a href="http://docs.mongodb.org/manual/reference/operator/query/text/#behavior">mongodb reference</a> for its behavior and limitations.</p>
</div>
<div class="paragraph">
<p>Bevore we are actually able to use full text search we have to ensure to set up the search index correctly. Please refer to section <a href="#mapping-usage-indexes.text-index">Text Index</a> for creating index structures.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="javascript language-javascript">db.foo.ensureIndex(
{
  title : "text",
  content : "text"
},
{
  weights : {
              title : 3
            }
}
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>A query searching for , sorted by relevance according to the  can be defined and executed as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">Query query = TextQuery.searching(new TextCriteria().matchingAny("coffee", "cake")).sortByScore();
List&lt;Document&gt; page = template.find(query, Document.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Exclusion of search terms can directly be done by prefixing the term with  or using</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">// search for 'coffee' and not 'cake'
TextQuery.searching(new TextCriteria().matching("coffee").matching("-cake"));
TextQuery.searching(new TextCriteria().matching("coffee").notMatching("cake"));</code></pre>
</div>
</div>
<div class="paragraph">
<p>As <code>TextCriteria.matching</code> takes the provided term as is. Therefore phrases can be defined by putting them between double quotes (eg.  or using <code>TextCriteria.phrase.</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">// search for phrase 'coffee cake'
TextQuery.searching(new TextCriteria().matching("\"coffee cake\""));
TextQuery.searching(new TextCriteria().phrase("coffee cake"));</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo.mapreduce">Map-Reduce Operations</h3>
<div class="paragraph">
<p>You can query MongoDB using Map-Reduce which is useful for batch processing, data aggregation, and for when the query language doesn&#8217;t fulfill your needs.</p>
</div>
<div class="paragraph">
<p>Spring provides integration with MongoDB&#8217;s map reduce by providing methods on MongoOperations to simplify the creation and execution of Map-Reduce operations. It can convert the results of a Map-Reduce operation to a POJO also integrates with Spring&#8217;s <a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/resources.html">Resource abstraction</a> abstraction. This will let you place your JavaScript files on the file system, classpath, http server or any other Spring Resource implementation and then reference the JavaScript resources via an easy URI style syntax, e.g. 'classpath:reduce.js;. Externalizing JavaScript code in files is often preferable to embedding them as Java strings in your code. Note that you can still pass JavaScript code as Java strings if you prefer.</p>
</div>
<div class="sect3">
<h4 id="mongo.mapreduce.example">Example Usage</h4>
<div class="paragraph">
<p>To understand how to perform Map-Reduce operations an example from the book <em>MongoDB - The definitive guide</em> is used. In this example we will create three documents that have the values [a,b], [b,c], and [c,d] respectfully. The values in each document are associated with the key <em>x</em> as shown below. For this example assume these documents are in the collection named "jmr1".  A map function that will count the occurance of each letter in the array for each document is shown below  The reduce function that will sum up the occurance of each letter across all the documents is shown below  Executing this will result in a collection as shown below.  Assuming that the map and reduce functions are located in map.js and reduce.js and bundled in your jar so they are available on the classpath, you can execute a map-reduce operation and obtain the results as shown below  The output of the above code is  The MapReduceResults class implements <code>Iterable</code> and provides access to the raw output, as well as timing and count statistics. The <code>ValueObject</code> class is simply  By default the output type of INLINE is used so you don&#8217;t have to specify an output collection. To specify additional map-reduce options use an overloaded method that takes an additional <code>MapReduceOptions</code> argument. The class <code>MapReduceOptions</code> has a fluent API so adding additional options can be done in a very compact syntax. Here an example that sets the output collection to "jmr1_out". Note that setting only the output collection assumes a default output type of REPLACE.  There is also a static import  that can be used to make the syntax slightly more compact  You can also specify a query to reduce the set of data that will be used to feed into the map-reduce operation. This will remove the document that contains [a,b] from consideration for map-reduce operations.  Note that you can specify additional limit and sort values as well on the query but not skip values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>{ "_id" : ObjectId("4e5ff893c0277826074ec533"), "x" : [ "a", "b" ] }
{ "_id" : ObjectId("4e5ff893c0277826074ec534"), "x" : [ "b", "c" ] }
{ "_id" : ObjectId("4e5ff893c0277826074ec535"), "x" : [ "c", "d" ] }</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">function () {
    for (var i = 0; i &lt; this.x.length; i++) {
        emit(this.x[i], 1);
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">function (key, values) {
    var sum = 0;
    for (var i = 0; i &lt; values.length; i++)
        sum += values[i];
    return sum;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>{ "_id" : "a", "value" : 1 }
{ "_id" : "b", "value" : 2 }
{ "_id" : "c", "value" : 2 }
{ "_id" : "d", "value" : 1 }</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">MapReduceResults&lt;ValueObject&gt; results = mongoOperations.mapReduce("jmr1", "classpath:map.js", "classpath:reduce.js", ValueObject.class);
for (ValueObject valueObject : results) {
  System.out.println(valueObject);
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>ValueObject [id=a, value=1.0]
ValueObject [id=b, value=2.0]
ValueObject [id=c, value=2.0]
ValueObject [id=d, value=1.0]</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public class ValueObject {

  private String id;
  private float value;

  public String getId() {
    return id;
  }

  public float getValue() {
    return value;
  }

  public void setValue(float value) {
    this.value = value;
  }

  @Override
  public String toString() {
    return "ValueObject [id=" + id + ", value=" + value + "]";
  }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">MapReduceResults&lt;ValueObject&gt; results = mongoOperations.mapReduce("jmr1", "classpath:map.js", "classpath:reduce.js",
                                                                     new MapReduceOptions().outputCollection("jmr1_out"), ValueObject.class);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">MapReduceResults&lt;ValueObject&gt; results = mongoOperations.mapReduce("jmr1", "classpath:map.js", "classpath:reduce.js",
                                                                     options().outputCollection("jmr1_out"), ValueObject.class);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">Query query = new Query(where("x").ne(new String[] { "a", "b" }));
MapReduceResults&lt;ValueObject&gt; results = mongoOperations.mapReduce(query, "jmr1", "classpath:map.js", "classpath:reduce.js",
                                                                     options().outputCollection("jmr1_out"), ValueObject.class);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo.group">Group Operations</h3>
<div class="paragraph">
<p>As an alternative to using Map-Reduce to perform data aggregation, you can use the <a href="http://www.mongodb.org/display/DOCS/Aggregation#Aggregation-Group"> operation</a> which feels similar to using SQL&#8217;s group by query style, so it may feel more approachable vs. using Map-Reduce. Using the group operations does have some limitations, for example it is not supported in a shareded environment and it returns the full result set in a single BSON object, so the result should be small, less than 10,000 keys.</p>
</div>
<div class="paragraph">
<p>Spring provides integration with MongoDB&#8217;s group operation by providing methods on MongoOperations to simplify the creation and execution of group operations. It can convert the results of the group operation to a POJO and also integrates with Spring&#8217;s <a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/resources.html">Resource abstraction</a> abstraction. This will let you place your JavaScript files on the file system, classpath, http server or any other Spring Resource implementation and then reference the JavaScript resources via an easy URI style syntax, e.g. 'classpath:reduce.js;. Externalizing JavaScript code in files if often preferable to embedding them as Java strings in your code. Note that you can still pass JavaScript code as Java strings if you prefer.</p>
</div>
<div class="sect3">
<h4 id="mongo.group.example">Example Usage</h4>
<div class="paragraph">
<p>In order to understand how group operations work the following example is used, which is somewhat artificial. For a more realistic example consult the book <em>MongoDB - The definitive guide</em>. A collection named "group_test_collection" created with the following rows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>{ "_id" : ObjectId("4ec1d25d41421e2015da64f1"), "x" : 1 }
{ "_id" : ObjectId("4ec1d25d41421e2015da64f2"), "x" : 1 }
{ "_id" : ObjectId("4ec1d25d41421e2015da64f3"), "x" : 2 }
{ "_id" : ObjectId("4ec1d25d41421e2015da64f4"), "x" : 3 }
{ "_id" : ObjectId("4ec1d25d41421e2015da64f5"), "x" : 3 }
{ "_id" : ObjectId("4ec1d25d41421e2015da64f6"), "x" : 3 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>We would like to group by the only field in each row, the <em>x</em> field and aggregate the number of times each specific value of <em>x</em> occurs. To do this we need to create an initial document that contains our count variable and also a reduce function which will increment it each time it is encountered. The Java code to execute the group operation is shown below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">GroupByResults&lt;XObject&gt; results = mongoTemplate.group("group_test_collection",
                                                      GroupBy.key("x").initialDocument("{ count: 0 }").reduceFunction("function(doc, prev) { prev.count += 1 }"),
                                                      XObject.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first argument is the name of the collection to run the group operation over, the second is a fluent API that specifies properties of the group operation via a <code>GroupBy</code> class. In this example we are using just the <code>intialDocument</code> and <code>reduceFunction</code> methods. You can also specify a key-function, as well as a finalizer as part of the fluent API. If you have multiple keys to group by, you can pass in a comma separated list of keys.</p>
</div>
<div class="paragraph">
<p>The raw results of the group operation is a JSON document that looks like this</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>{
  "retval" : [ { "x" : 1.0 , "count" : 2.0} ,
               { "x" : 2.0 , "count" : 1.0} ,
               { "x" : 3.0 , "count" : 3.0} ] ,
  "count" : 6.0 ,
  "keys" : 3 ,
  "ok" : 1.0
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The document under the "retval" field is mapped onto the third argument in the group method, in this case XObject which is shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public class XObject {

  private float x;

  private float count;


  public float getX() {
    return x;
  }

  public void setX(float x) {
    this.x = x;
  }

  public float getCount() {
    return count;
  }

  public void setCount(float count) {
    this.count = count;
  }

  @Override
  public String toString() {
    return "XObject [x=" + x + " count = " + count + "]";
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also obtain the raw result as a <code>DbObject</code> by calling the method <code>getRawResults</code> on the <code>GroupByResults</code> class.</p>
</div>
<div class="paragraph">
<p>There is an additional method overload of the group method on <code>MongoOperations</code> which lets you specify a <code>Criteria</code> object for selecting a subset of the rows. An example which uses a <code>Criteria</code> object, with some syntax sugar using static imports, as well as referencing a key-function and reduce function javascript files via a Spring Resource string is shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>import static org.springframework.data.mongodb.core.mapreduce.GroupBy.keyFunction;
import static org.springframework.data.mongodb.core.query.Criteria.where;

GroupByResults&lt;XObject&gt; results = mongoTemplate.group(where("x").gt(0),
                                        "group_test_collection",
                                        keyFunction("classpath:keyFunction.js").initialDocument("{ count: 0 }").reduceFunction("classpath:groupReduce.js"), XObject.class);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo.aggregation">Aggregation Framework Support</h3>
<div class="paragraph">
<p>Spring Data MongoDB provides support for the Aggregation Framework introduced to MongoDB in version 2.2.</p>
</div>
<div class="paragraph">
<p>The MongoDB Documentation describes the <a href="http://docs.mongodb.org/manual/core/aggregation/">Aggregation Framework</a> as follows:</p>
</div>
<div class="paragraph">
<p>For further information see the full <a href="http://docs.mongodb.org/manual/aggregation/">reference documentation</a> of the aggregation framework and other data aggregation tools for MongoDB.</p>
</div>
<div class="sect3">
<h4 id="mongo.aggregation.basic-concepts">Basic Concepts</h4>
<div class="paragraph">
<p>The Aggregation Framework support in Spring Data MongoDB is based on the following key abstractions <code>Aggregation</code>, <code>AggregationOperation</code> and <code>AggregationResults</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Aggregation</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An Aggregation represents a MongoDB <code>aggregate</code> operation and holds the description of the aggregation pipline instructions. Aggregations are created by inoking the appropriate <code>newAggregation(…)</code> static factory Method of the <code>Aggregation</code> class which takes the list of <code>AggregateOperation</code> as a parameter next to the optional input class.</p>
</div>
<div class="paragraph">
<p>The actual aggregate operation is executed by the <code>aggregate</code> method of the <code>MongoTemplate</code> which also takes the desired output class as parameter.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AggregationOperation</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An <code>AggregationOperation</code> represents a MongoDB aggregation pipeline operation and describes the processing that should be performed in this aggregation step. Although one could manually create an <code>AggregationOperation</code> the recommended way to construct an <code>AggregateOperation</code> is to use the static factory methods provided by the <code>Aggregate</code> class.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AggregationResults</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>AggregationResults</code> is the container for the result of an aggregate operation. It provides access to the raw aggregation result in the form of an <code>DBObject</code>, to the mapped objects and information which performed the aggregation.</p>
</div>
<div class="paragraph">
<p>The canonical example for using the Spring Data MongoDB support for the MongoDB Aggregation Framework looks as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">import static org.springframework.data.mongodb.core.aggregation.Aggregation.*;

Aggregation agg = newAggregation(
    pipelineOP1(),
    pipelineOP2(),
    pipelineOPn()
);

AggregationResults&lt;OutputType&gt; results = mongoTemplate.aggregate(agg, "INPUT_COLLECTION_NAME", OutputType.class);
List&lt;OutputType&gt; mappedResult = results.getMappedResults();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that if you provide an input class as the first parameter to the <code>newAggregation</code> method the <code>MongoTemplate</code> will derive the name of the input collection from this class. Otherwise if you don&#8217;t not specify an input class you must provide the name of the input collection explicitly. If an input-class and an input-collection is provided the latter takes precedence.</p>
</div>
</div>
<div class="sect3">
<h4 id="mongo.aggregation.supported-aggregation-operations">Supported Aggregation Operations Aggregation Operations currently supported by Spring Data MongoDB</h4>
<div class="paragraph">
<p>The MongoDB Aggregation Framework provides the following types of Aggregation Operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Pipeline Aggregation Operators</p>
</li>
<li>
<p>Group Aggregation Operators</p>
</li>
<li>
<p>Boolean Aggregation Operators</p>
</li>
<li>
<p>Comparison Aggregation Operators</p>
</li>
<li>
<p>Arithmetic Aggregation Operators</p>
</li>
<li>
<p>String Aggregation Operators</p>
</li>
<li>
<p>Date Aggregation Operators</p>
</li>
<li>
<p>Conditional Aggregation Operators</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>At the time of this writing we provide support for the following Aggregation Operations in Spring Data MongoDB.</p>
</div>
<div class="paragraph">
<p>Note that the aggregation operations not listed here are currently not supported by Spring Data MongoDB. Comparison aggregation operators are expressed as <code>Criteria</code> expressions.</p>
</div>
<div class="paragraph">
<p>*) The operation is mapped or added by Spring Data MongoDB.</p>
</div>
</div>
<div class="sect3">
<h4 id="mongo.aggregation.projection">Projection Expressions Projection expression examples</h4>
<div class="paragraph">
<p>Projection expressions are used to define the fields that are the outcome of a particular aggregation step. Projection expressions can be defined via the <code>project</code> method of the <code>Aggregate</code> class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">project("name", "netPrice") // will generate {$project: {name: 1, netPrice: 1}}
project().and("foo").as("bar") // will generate {$project: {bar: $foo}}
project("a","b").and("foo").as("bar") // will generate {$project: {a: 1, b: 1, bar: $foo}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that more examples for project operations can be found in the <code>AggregationTests</code> class.</p>
</div>
<div class="paragraph">
<p>Note that further details regarding the projection expressions can be found in the <a href="http://docs.mongodb.org/manual/reference/operator/aggregation/project/#pipe._S_project">corresponding section</a> of the MongoDB Aggregation Framework reference documentation.</p>
</div>
<div class="sect4">
<h5 id="mongo.aggregation.projection.expressions">Spring Expression Support in Projection Expressions Complex calculations with SpEL expressions</h5>
<div class="paragraph">
<p>As of Version 1.4.0 we support the use of SpEL expression in projection expressions via the <code>andExpression</code> method of the <code>ProjectionOperation</code> class. This allows you to define the desired expression as a SpEL expression which is translated into a corresponding MongoDB projection expression part on query execution. This makes it much easier to express complex calculations.</p>
</div>
<div class="paragraph">
<p>The following SpEL expression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">1 + (q + 1) / (q - 1)</code></pre>
</div>
</div>
<div class="paragraph">
<p>will be translated into the following projection expression part:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="javascript language-javascript">{ "$add" : [ 1, {
    "$divide" : [ {
        "$add":["$q", 1]}, {
        "$subtract":[ "$q", 1]}
    ]
}]}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Have a look at an example in more context in  and . You can find more usage examples for supported SpEL expression constructs in <code>SpelExpressionTransformerUnitTests</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo.aggregation.examples">Aggregation Framework Examples Aggregation Framework Example 1 Aggregation Framework Example 2 Aggregation Framework Example 3 Aggregation Framework Example 4 Aggregation Framework Example 5 Aggregation Framework Example 6</h4>
<div class="paragraph">
<p>The following examples demonstrate the usage patterns for the MongoDB Aggregation Framework with Spring Data MongoDB.</p>
</div>
<div class="paragraph">
<p>In this introductory example we want to aggregate a list of tags to get the occurrence count of a particular tag from a MongoDB collection called <code>"tags"</code> sorted by the occurrence count in descending order. This example demonstrates the usage of grouping, sorting, projections (selection) and unwinding (result splitting).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">class TagCount {
 String tag;
 int n;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">import static org.springframework.data.mongodb.core.aggregation.Aggregation.*;

Aggregation agg = newAggregation(
    project("tags"),
    unwind("tags"),
    group("tags").count().as("n"),
    project("n").and("tag").previousOperation(),
    sort(DESC, "n")
);

AggregationResults&lt;TagCount&gt; results = mongoTemplate.aggregate(agg, "tags", TagCount.class);
List&lt;TagCount&gt; tagCount = results.getMappedResults();</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>In order to do this we first create a new aggregation via the <code>newAggregation</code> static factory method to which we pass a list of aggregation operations. These aggregate operations define the aggregation pipeline of our <code>Aggregation</code>.</p>
</li>
<li>
<p>As a second step we select the <code>"tags"</code> field (which is an array of strings) from the input collection with the <code>project</code> operation.</p>
</li>
<li>
<p>In a third step we use the <code>unwind</code> operation to generate a new document for each tag within the <code>"tags"</code> array.</p>
</li>
<li>
<p>In the forth step we use the <code>group</code> operation to define a group for each <code>"tags"</code>-value for which we aggregate the occurrence count via the <code>count</code> aggregation operator and collect the result in a new field called <code>"n"</code>.</p>
</li>
<li>
<p>As a fifth step we select the field <code>"n"</code> and create an alias for the id-field generated from the previous group operation (hence the call to <code>previousOperation()</code>) with the name <code>"tag"</code>.</p>
</li>
<li>
<p>As the sixth step we sort the resulting list of tags by their occurrence count in descending order via the <code>sort</code> operation.</p>
</li>
<li>
<p>Finally we call the <code>aggregate</code> Method on the MongoTemplate in order to let MongoDB perform the acutal aggregation operation with the created <code>Aggregation</code> as an argument.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that the input collection is explicitly specified as the <code>"tags"</code> parameter to the <code>aggregate</code> Method. If the name of the input collection is not specified explicitly, it is derived from the input-class passed as first parameter to the <code>newAggreation</code> Method.</p>
</div>
<div class="paragraph">
<p>This example is based on the <a href="http://docs.mongodb.org/manual/tutorial/aggregation-examples/#largest-and-smallest-cities-by-state">Largest and Smallest Cities by State</a> example from the MongoDB Aggregation Framework documentation. We added additional sorting to produce stable results with different MongoDB versions. Here we want to return the smallest and largest cities by population for each state, using the aggregation framework. This example demonstrates the usage of grouping, sorting and projections (selection).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">class ZipInfo {
   String id;
   String city;
   String state;
   @Field("pop") int population;
   @Field("loc") double[] location;
}

class City {
   String name;
   int population;
}

class ZipInfoStats {
   String id;
   String state;
   City biggestCity;
   City smallestCity;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">import static org.springframework.data.mongodb.core.aggregation.Aggregation.*;

TypedAggregation&lt;ZipInfo&gt; aggregation = newAggregation(ZipInfo.class,
    group("state", "city")
       .sum("population").as("pop"),
    sort(ASC, "pop", "state", "city"),
    group("state")
       .last("city").as("biggestCity")
       .last("pop").as("biggestPop")
       .first("city").as("smallestCity")
       .first("pop").as("smallestPop"),
    project()
       .and("state").previousOperation()
       .and("biggestCity")
          .nested(bind("name", "biggestCity").and("population", "biggestPop"))
       .and("smallestCity")
          .nested(bind("name", "smallestCity").and("population", "smallestPop")),
    sort(ASC, "state")
);

AggregationResults&lt;ZipInfoStats&gt; result = mongoTemplate.aggregate(aggregation, ZipInfoStats.class);
ZipInfoStats firstZipInfoStats = result.getMappedResults().get(0);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The class <code>ZipInfo</code> maps the structure of the given input-collection. The class <code>ZipInfoStats</code> defines the structure in the desired output format.</p>
</li>
<li>
<p>As a first step we use the <code>group</code> operation to define a group from the input-collection. The grouping criteria is the combination of the fields <code>"state"</code> and <code>"city" `which forms the id structure of the group. We aggregate the value of the `"population"</code> property from the grouped elements with by using the <code>sum</code> operator saving the result in the field <code>"pop"</code>.</p>
</li>
<li>
<p>In a second step we use the <code>sort</code> operation to sort the intermediate-result by the fields <code>"pop"</code>, <code>"state"</code> and <code>"city"</code> in ascending order, such that the smallest city is at the top and the biggest city is at the bottom of the result. Note that the sorting on "state" and <code>"city"</code> is implicitly performed against the group id fields which Spring Data MongoDB took care of.</p>
</li>
<li>
<p>In the third step we use a <code>group</code> operation again to group the intermediate result by <code>"state"</code>. Note that <code>"state"</code> again implicitly references an group-id field. We select the name and the population count of the biggest and smallest city with calls to the <code>last(…)</code> and <code>first(...)</code> operator respectively via the <code>project</code> operation.</p>
</li>
<li>
<p>As the forth step we select the <code>"state"</code> field from the previous <code>group</code> operation. Note that <code>"state"</code> again implicitly references an group-id field. As we do not want an implicit generated id to appear, we exclude the id from the previous operation via <code>and(previousOperation()).exclude()</code>. As we want to populate the nested <code>City</code> structures in our output-class accordingly we have to emit appropriate sub-documents with the nested method.</p>
</li>
<li>
<p>Finally as the fifth step we sort the resulting list of <code>StateStats</code> by their state name in ascending order via the <code>sort</code> operation.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that we derive the name of the input-collection from the <code>ZipInfo</code>-class passed as first parameter to the <code>newAggregation</code>-Method.</p>
</div>
<div class="paragraph">
<p>This example is based on the <a href="http://docs.mongodb.org/manual/tutorial/aggregation-examples/#states-with-populations-over-10-million">States with Populations Over 10 Million </a>example from the MongoDB Aggregation Framework documentation. We added additional sorting to produce stable results with different MongoDB versions. Here we want to return all states with a population greater than 10 million, using the aggregation framework. This example demonstrates the usage of grouping, sorting and matching (filtering).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">class StateStats {
   @Id String id;
   String state;
   @Field("totalPop") int totalPopulation;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">import static org.springframework.data.mongodb.core.aggregation.Aggregation.*;

TypedAggregation&lt;ZipInfo&gt; agg = newAggregation(ZipInfo.class,
    group("state").sum("population").as("totalPop"),
    sort(ASC, previousOperation(), "totalPop"),
    match(where("totalPop").gte(10 * 1000 * 1000))
);

AggregationResults&lt;StateStats&gt; result = mongoTemplate.aggregate(agg, StateStats.class);
List&lt;StateStats&gt; stateStatsList = result.getMappedResults();</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>As a first step we group the input collection by the <code>"state"</code> field and calculate the sum of the <code>"population"</code> field and store the result in the new field <code>"totalPop"</code>.</p>
</li>
<li>
<p>In the second step we sort the intermediate result by the id-reference of the previous group operation in addition to the <code>"totalPop"</code> field in ascending order.</p>
</li>
<li>
<p>Finally in the third step we filter the intermediate result by using a <code>match</code> operation which accepts a <code>Criteria</code> query as an argument.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that we derive the name of the input-collection from the <code>ZipInfo</code>-class passed as first parameter to the <code>newAggregation</code>-Method.</p>
</div>
<div class="paragraph">
<p>This example demonstrates the use of simple arithmetic operations in the projection operation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">class Product {
    String id;
    String name;
    double netPrice;
    int spaceUnits;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">import static org.springframework.data.mongodb.core.aggregation.Aggregation.*;

TypedAggregation&lt;Product&gt; agg = newAggregation(Product.class,
    project("name", "netPrice")
        .and("netPrice").plus(1).as("netPricePlus1")
        .and("netPrice").minus(1).as("netPriceMinus1")
        .and("netPrice").multiply(1.19).as("grossPrice")
        .and("netPrice").divide(2).as("netPriceDiv2")
        .and("spaceUnits").mod(2).as("spaceUnitsMod2")
);

AggregationResults&lt;DBObject&gt; result = mongoTemplate.aggregate(agg, DBObject.class);
List&lt;DBObject&gt; resultList = result.getMappedResults();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that we derive the name of the input-collection from the <code>Product</code>-class passed as first parameter to the <code>newAggregation</code>-Method.</p>
</div>
<div class="paragraph">
<p>This example demonstrates the use of simple arithmetic operations derived from SpEL Expressions in the projection operation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">class Product {
    String id;
    String name;
    double netPrice;
    int spaceUnits;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">import static org.springframework.data.mongodb.core.aggregation.Aggregation.*;

TypedAggregation&lt;Product&gt; agg = newAggregation(Product.class,
    project("name", "netPrice")
        .andExpression("netPrice + 1").as("netPricePlus1")
        .andExpression("netPrice - 1").as("netPriceMinus1")
        .andExpression("netPrice / 2").as("netPriceDiv2")
        .andExpression("netPrice * 1.19").as("grossPrice")
        .andExpression("spaceUnits % 2").as("spaceUnitsMod2")
        .andExpression("(netPrice * 0.8  + 1.2) * 1.19").as("grossPriceIncludingDiscountAndCharge")

);

AggregationResults&lt;DBObject&gt; result = mongoTemplate.aggregate(agg, DBObject.class);
List&lt;DBObject&gt; resultList = result.getMappedResults();</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example demonstrates the use of complex arithmetic operations derived from SpEL Expressions in the projection operation.</p>
</div>
<div class="paragraph">
<p>Note: The additional parameters passed to the <code>addExpression</code> Method can be referenced via indexer expressions according to their position. In this example we reference the parameter  which is the first parameter of the parameters array via <code>[0]</code>. External parameter expressions are replaced with their respective values when the SpEL expression is transformed into a MongoDB aggregation framework expression.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">class Product {
    String id;
    String name;
    double netPrice;
    int spaceUnits;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">import static org.springframework.data.mongodb.core.aggregation.Aggregation.*;

double shippingCosts = 1.2;

TypedAggregation&lt;Product&gt; agg = newAggregation(Product.class,
    project("name", "netPrice")
        .andExpression("(netPrice * (1-discountRate)  + [0]) * (1+taxRate)", shippingCosts).as("salesPrice")
);

AggregationResults&lt;DBObject&gt; result = mongoTemplate.aggregate(agg, DBObject.class);
List&lt;DBObject&gt; resultList = result.getMappedResults();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that we can also refer to other fields of the document within the SpEL expression.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo.custom-converters">Overriding default mapping with custom converters</h3>
<div class="paragraph">
<p>In order to have more fine grained control over the mapping process you can register Spring converters with the <code>MongoConverter</code> implementations such as the <code>MappingMongoConverter</code>.</p>
</div>
<div class="paragraph">
<p>The <code>MappingMongoConverter</code> checks to see if there are any Spring converters that can handle a specific class before attempting to map the object itself. To <em>hijack</em> the normal mapping strategies of the <code>MappingMongoConverter</code>, perhaps for increased performance or other custom mapping needs, you first need to create an implementation of the Spring <code>Converter</code> interface and then register it with the MappingConverter.</p>
</div>
<div class="paragraph">
<p>For more information on the Spring type conversion service see the reference docs <a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/validation.html#core-convert">here</a>.</p>
</div>
<div class="sect3">
<h4 id="mongo.custom-converters.writer">Saving using a registered Spring Converter</h4>
<div class="paragraph">
<p>An example implementation of the <code>Converter</code> that converts from a Person object to a <code>com.mongodb.DBObject</code> is shown below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">import org.springframework.core.convert.converter.Converter;

import com.mongodb.BasicDBObject;
import com.mongodb.DBObject;

public class PersonWriteConverter implements Converter&lt;Person, DBObject&gt; {

  public DBObject convert(Person source) {
    DBObject dbo = new BasicDBObject();
    dbo.put("_id", source.getId());
    dbo.put("name", source.getFirstName());
    dbo.put("age", source.getAge());
    return dbo;
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo.custom-converters.reader">Reading using a Spring Converter</h4>
<div class="paragraph">
<p>An example implementation of a Converter that converts from a DBObject ot a Person object is shownn below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public class PersonReadConverter implements Converter&lt;DBObject, Person&gt; {

  public Person convert(DBObject source) {
    Person p = new Person((ObjectId) source.get("_id"), (String) source.get("name"));
    p.setAge((Integer) source.get("age"));
    return p;
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo.custom-converters.xml">Registering Spring Converters with the MongoConverter</h4>
<div class="paragraph">
<p>The Mongo Spring namespace provides a convenience way to register Spring <code>Converter`s with the `MappingMongoConverter</code>. The configuration snippet below shows how to manually register converter beans as well as configuring the wrapping <code>MappingMongoConverter</code> into a <code>MongoTemplate</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;mongo:db-factory dbname="database"/&gt;

&lt;mongo:mapping-converter&gt;
  &lt;mongo:custom-converters&gt;
    &lt;mongo:converter ref="readConverter"/&gt;
    &lt;mongo:converter&gt;
      &lt;bean class="org.springframework.data.mongodb.test.PersonWriteConverter"/&gt;
    &lt;/mongo:converter&gt;
  &lt;/mongo:custom-converters&gt;
&lt;/mongo:mapping-converter&gt;

&lt;bean id="readConverter" class="org.springframework.data.mongodb.test.PersonReadConverter"/&gt;

&lt;bean id="mongoTemplate" class="org.springframework.data.mongodb.core.MongoTemplate"&gt;
  &lt;constructor-arg name="mongoDbFactory" ref="mongoDbFactory"/&gt;
  &lt;constructor-arg name="mongoConverter" ref="mappingConverter"/&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use the base-package attribute of the custom-converters element to enable classpath scanning for all <code>Converter</code> and <code>GenericConverter</code> implementations below the given package.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;mongo:mapping-converter&gt;
  &lt;mongo:custom-converters base-package="com.acme.**.converters" /&gt;
&lt;/mongo:mapping-converter&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo.converter-disambiguation">Converter disambiguation</h4>
<div class="paragraph">
<p>Generally we inspect the <code>Converter</code> implementations for the source and target types they convert from and to. Depending on whether one of those is a type MongoDB can handle natively we will register the converter instance as reading or writing one. Have a look at the following samples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">// Write converter as only the target type is one Mongo can handle natively
class MyConverter implements Converter&lt;Person, String&gt; { … }

// Read converter as only the source type is one Mongo can handle natively
class MyConverter implements Converter&lt;String, Person&gt; { … }</code></pre>
</div>
</div>
<div class="paragraph">
<p>In case you write a <code>Converter</code> whose source and target type are native Mongo types there&#8217;s no way for us to determine whether we should consider it as reading or writing converter. Registering the converter instance as both might lead to unwanted results then. E.g. a <code>Converter&lt;String, Long&gt;</code> is ambiguous although it probably does not make sense to try to convert all <code>String`s into `Long`s when writing. To be generally able to force the infrastructure to register a converter for one way only we provide `@ReadingConverter</code> as well as <code>@WritingConverter</code> to be used at the converter implementation.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo-template.index-and-collections">Index and Collection management</h3>
<div class="paragraph">
<p><code>MongoTemplate</code> provides a few methods for managing indexes and collections. These are collected into a helper interface called <code>IndexOperations</code>. You access these operations by calling the method <code>indexOps</code> and pass in either the collection name or the  of your entity (the collection name will be derived from the .class either by name or via annotation metadata).</p>
</div>
<div class="paragraph">
<p>The <code>IndexOperations</code> interface is shown below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public interface IndexOperations {

  void ensureIndex(IndexDefinition indexDefinition);

  void dropIndex(String name);

  void dropAllIndexes();

  void resetIndexCache();

  List&lt;IndexInfo&gt; getIndexInfo();
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.index-and-collections.index">Methods for creating an Index Creating an index using the MongoTemplate</h4>
<div class="paragraph">
<p>We can create an index on a collection to improve query performance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">mongoTemplate.indexOps(Person.class).ensureIndex(new Index().on("name",Order.ASCENDING));</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensure that an index for the provided IndexDefinition exists for the collection.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can create standard, geospatial and text indexes using the classes <code>IndexDefinition</code>, <code>GeoSpatialIndex</code> and <code>TextIndexDefinition</code>. For example, given the Venue class defined in a previous section, you would declare a geospatial query as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">mongoTemplate.indexOps(Venue.class).ensureIndex(new GeospatialIndex("location"));</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.index-and-collections.access">Accessing index information</h4>
<div class="paragraph">
<p>The IndexOperations interface has the method getIndexInfo that returns a list of IndexInfo objects. This contains all the indexes defined on the collectcion. Here is an example that defines an index on the Person class that has age property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">template.indexOps(Person.class).ensureIndex(new Index().on("age", Order.DESCENDING).unique(Duplicates.DROP));

List&lt;IndexInfo&gt; indexInfoList = template.indexOps(Person.class).getIndexInfo();

// Contains
// [IndexInfo [fieldSpec={_id=ASCENDING}, name=_id_, unique=false, dropDuplicates=false, sparse=false],
//  IndexInfo [fieldSpec={age=DESCENDING}, name=age_-1, unique=true, dropDuplicates=true, sparse=false]]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.index-and-collections.collection">Methods for working with a Collection Working with collections using the MongoTemplate</h4>
<div class="paragraph">
<p>It&#8217;s time to look at some code examples showing how to use the <code>MongoTemplate</code>. First we look at creating our first collection.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">DBCollection collection = null;
if (!mongoTemplate.getCollectionNames().contains("MyNewCollection")) {
    collection = mongoTemplate.createCollection("MyNewCollection");
}

mongoTemplate.dropCollection("MyNewCollection");</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Returns a set of collection names.</p>
</li>
<li>
<p>Check to see if a collection with a given name exists.</p>
</li>
<li>
<p>Create an uncapped collection</p>
</li>
<li>
<p>Drop the collection</p>
</li>
<li>
<p>Get a collection by name, creating it if it doesn&#8217;t exist.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo-template.commands">Executing Commands</h3>
<div class="paragraph">
<p>You can also get at the MongoDB driver&#8217;s <code>DB.command( )</code> method using the <code>executeCommand(…)</code> methods on <code>MongoTemplate</code>. These will also perform exception translation into Spring&#8217;s <code>DataAccessException</code> hierarchy.</p>
</div>
<div class="sect3">
<h4 id="mongo-template.commands.execution">Methods for executing commands</h4>
<div class="ulist">
<ul>
<li>
<p>Execute a MongoDB command.</p>
</li>
<li>
<p>Execute the a MongoDB command expressed as a JSON string.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongodb.mapping-usage.events">Lifecycle Events</h3>
<div class="paragraph">
<p>Built into the MongoDB mapping framework are several <code>org.springframework.context.ApplicationEvent</code> events that your application can respond to by registering special beans in the <code>ApplicationContext</code>. By being based off Spring&#8217;s ApplicationContext event infastructure this enables other products, such as Spring Integration, to easily receive these events as they are a well known eventing mechanism in Spring based applications.</p>
</div>
<div class="paragraph">
<p>To intercept an object before it goes through the conversion process (which turns your domain object into a <code>com.mongodb.DBObject</code>), you&#8217;d register a subclass of <code>AbstractMongoEventListener</code> that overrides the <code>onBeforeConvert</code> method. When the event is dispatched, your listener will be called and passed the domain object before it goes into the converter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public class BeforeConvertListener extends AbstractMongoEventListener&lt;Person&gt; {
  @Override
  public void onBeforeConvert(Person p) {
    ... does some auditing manipulation, set timestamps, whatever ...
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To intercept an object before it goes into the database, you&#8217;d register a subclass of <code>org.springframework.data.mongodb.core.mapping.event.AbstractMongoEventListener</code> that overrides the <code>onBeforeSave</code> method. When the event is dispatched, your listener will be called and passed the domain object and the converted <code>com.mongodb.DBObject</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public class BeforeSaveListener extends AbstractMongoEventListener&lt;Person&gt; {
  @Override
  public void onBeforeSave(Person p, DBObject dbo) {
    … change values, delete them, whatever …
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Simply declaring these beans in your Spring ApplicationContext will cause them to be invoked whenever the event is dispatched.</p>
</div>
<div class="paragraph">
<p>The list of callback methods that are present in AbstractMappingEventListener are</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>onBeforeConvert</code> - called in MongoTemplate insert, insertList and save operations before the object is converted to a DBObject using a MongoConveter.</p>
</li>
<li>
<p><code>onBeforeSave</code> - called in MongoTemplate insert, insertList and save operations  inserting/saving the DBObject in the database.</p>
</li>
<li>
<p><code>onAfterSave</code> - called in MongoTemplate insert, insertList and save operations  inserting/saving the DBObject in the database.</p>
</li>
<li>
<p><code>onAfterLoad</code> - called in MongoTempnlate find, findAndRemove, findOne and getCollection methods after the DBObject is retrieved from the database.</p>
</li>
<li>
<p><code>onAfterConvert</code> - called in MongoTempnlate find, findAndRemove, findOne and getCollection methods after the DBObject retrieved from the database was converted to a POJO.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="mongo.exception">Exception Translation</h3>
<div class="paragraph">
<p>The Spring framework provides exception translation for a wide variety of database and mapping technologies. This has traditionally been for JDBC and JPA. The Spring support for MongoDB extends this feature to the MongoDB Database by providing an implementation of the <code>org.springframework.dao.support.PersistenceExceptionTranslator</code> interface.</p>
</div>
<div class="paragraph">
<p>The motivation behind mapping to Spring&#8217;s <a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/dao.html#dao-exceptions">consistent data access exception hierarchy</a> is that you are then able to write portable and descriptive exception handling code without resorting to coding against <a href="http://www.mongodb.org/about/contributors/error-codes/">MongoDB error codes</a>. All of Spring&#8217;s data access exceptions are inherited from the root <code>DataAccessException</code> class so you can be sure that you will be able to catch all database related exception within a single try-catch block. Note, that not all exceptions thrown by the MongoDB driver inherit from the MongoException class. The inner exception and message are preserved so no information is lost.</p>
</div>
<div class="paragraph">
<p>Some of the mappings performed by the <code>MongoExceptionTranslator</code> are: com.mongodb.Network to DataAccessResourceFailureException and <code>MongoException</code> error codes 1003, 12001, 12010, 12011, 12012 to <code>InvalidDataAccessApiUsageException</code>. Look into the implementation for more details on the mapping.</p>
</div>
</div>
<div class="sect2">
<h3 id="mongo.executioncallback">Execution callbacks</h3>
<div class="paragraph">
<p>One common design feature of all Spring template classes is that all functionality is routed into one of the templates execute callback methods. This helps ensure that exceptions and any resource management that maybe required are performed consistency. While this was of much greater need in the case of JDBC and JMS than with MongoDB, it still offers a single spot for exception translation and logging to occur. As such, using thexe execute callback is the preferred way to access the MongoDB driver&#8217;s <code>DB</code> and <code>DBCollection</code> objects to perform uncommon operations that were not exposed as methods on <code>MongoTemplate</code>.</p>
</div>
<div class="paragraph">
<p>Here is a list of execute callback methods.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Executes the given CollectionCallback for the entity collection of the specified class.</p>
</li>
<li>
<p>Executes the given CollectionCallback on the collection of the given name.</p>
</li>
<li>
<p>Executes a DbCallback translating any exceptions as necessary.</p>
</li>
<li>
<p>Executes a DbCallback on the collection of the given name translating any exceptions as necessary.</p>
</li>
<li>
<p>Executes the given DbCallback within the same connection to the database so as to ensure consistency in a write heavy environment where you may read the data that you wrote.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is an example that uses the <code>CollectionCallback</code> to return information about an index</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">boolean hasIndex = template.execute("geolocation", new CollectionCallbackBoolean&gt;() {
  public Boolean doInCollection(Venue.class, DBCollection collection) throws MongoException, DataAccessException {
    List&lt;DBObject&gt; indexes = collection.getIndexInfo();
    for (DBObject dbo : indexes) {
      if ("location_2d".equals(dbo.get("name"))) {
        return true;
      }
    }
    return false;
  }
});</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="gridfs">GridFS support JavaConfig setup for a GridFsTemplate XML configuration for a GridFsTemplate Using GridFsTemplate to store files Using GridFsTemplate to query for files Using GridFsTemplate to read files</h3>
<div class="paragraph">
<p>MongoDB supports storing binary files inside it&#8217;s filesystem GridFS. Spring Data MongoDB provides a <code>GridFsOperations</code> interface as well as the according implementation <code>GridFsTemplate</code> to easily interact with the filesystem. You can setup a <code>GridFsTemplate</code> instance by handing it a <code>MongoDbFactory</code> as well as a <code>MongoConverter</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">class GridFsConfiguration extends AbstractMongoConfiguration {

  // … further configuration omitted

  @Bean
  public GridFsTemplate gridFsTemplate() {
    return new GridFsTemplate(mongoDbFactory(), mappingMongoConverter());
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>An according XML configuration looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:mongo="http://www.springframework.org/schema/data/mongo"
  xsi:schemaLocation="http://www.springframework.org/schema/data/mongo
                      http://www.springframework.org/schema/data/mongo/spring-mongo.xsd
                      http://www.springframework.org/schema/beans
                      http://www.springframework.org/schema/beans/spring-beans.xsd"&gt;

  &lt;mongo:db-factory id="mongoDbFactory" dbname="database" /&gt;
  &lt;mongo:mapping-converter id="converter" /&gt;

  &lt;bean class="org.springframework.data.mongodb.gridfs.GridFsTemplate"&gt;
    &lt;constructor-arg ref="mongoDbFactory" /&gt;
    &lt;constructor-arg ref="converter" /&gt;
  &lt;/bean&gt;

&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The template can now be injected and used to perform storage and retrieval operations.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">class GridFsClient {

  @Autowired
  GridFsOperations operations;

  @Test
  public void storeFileToGridFs {

    FileMetadata metadata = new FileMetadata();
    // populate metadata
    Resource file = … // lookup File or Resource

    operations.store(file.getInputStream(), "filename.txt", metadata);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>store(…)</code> operations take an <code>InputStream</code>, a filename and optionally metadata information about the file to store. The metadata can be an arbitrary object which will be marshalled by the <code>MongoConverter</code> configured with the <code>GridFsTemplate</code>. Alternatively you can also provide a <code>DBObject</code> as well.</p>
</div>
<div class="paragraph">
<p>Reading files from the filesystem can either be achieved through the <code>find(…)</code> or <code>getResources(…)</code> methods. Let&#8217;s have a look at the <code>find(…)</code> methods first. You can either find a single file matching a <code>Query</code> or multiple ones. To easily define file queries we provide the <code>GridFsCriteria</code> helper class. It provides static factory methods to encapsulate default metadata fields (e.g. <code>whereFilename()</code>, <code>whereContentType()</code>) or the custom one through <code>whereMetaData()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">class GridFsClient {

  @Autowired
  GridFsOperations operations;

  @Test
  public void findFilesInGridFs {
    List&lt;GridFSDBFile&gt; result = operations.find(query(whereFilename().is("filename.txt")))
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Currently MongoDB does not support defining sort criterias when retrieving files from GridFS. Thus any sort criterias defined on the <code>Query</code> instance handed into the <code>find(…)</code> method will be disregarded.</p>
</div>
<div class="paragraph">
<p>The other option to read files from the GridFs is using the methods introduced by the <code>ResourcePatternResolver</code> interface. They allow handing an Ant path into the method ar thus retrieve files matching the given pattern.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">class GridFsClient {

  @Autowired
  GridFsOperations operations;

  @Test
  public void readFilesFromGridFs {
    GridFsResources[] txtFiles = operations.getResources("*.txt");
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>GridFsOperations</code> extending <code>ResourcePatternResolver</code> allows the <code>GridFsTemplate</code> e.g. to be plugged into an <code>ApplicationContext</code> to read Spring Config files from a MongoDB.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mongo.repositories">MongoDB repositories</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="mongo-repo-intro">Introduction</h3>
<div class="paragraph">
<p>This chapter will point out the specialties for repository support for MongoDB. This builds on the core repository support explained in . So make sure you&#8217;ve got a sound understanding of the basic concepts explained there.</p>
</div>
</div>
<div class="sect2">
<h3 id="mongo-repo-usage">Usage Sample Person entity Basic repository interface to persist Person entities General MongoDB repository Spring configuration JavaConfig for repositories Paging access to Person entities</h3>
<div class="paragraph">
<p>To access domain entities stored in a MongoDB you can leverage our sophisticated repository support that eases implementing those quite significantly. To do so, simply create an interface for your repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public class Person {

  @Id
  private String id;
  private String firstname;
  private String lastname;
  private Address address;

  // … getters and setters omitted
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have a quite simple domain object here. Note that it has a property named <code>id</code> of type`ObjectId`. The default serialization mechanism used in <code>MongoTemplate</code> (which is backing the repository support) regards properties named id as document id. Currently we support`String`, <code>ObjectId</code> and <code>BigInteger</code> as id-types.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>public interface PersonRepository extends PagingAndSortingRepository&lt;Person, Long&gt; {

  // additional custom finder methods go here
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Right now this interface simply serves typing purposes but we will add additional methods to it later. In your Spring configuration simply add</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:mongo="http://www.springframework.org/schema/data/mongo"
  xsi:schemaLocation="http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
    http://www.springframework.org/schema/data/mongo
    http://www.springframework.org/schema/data/mongo/spring-mongo-1.0.xsd"&gt;

  &lt;mongo:mongo id="mongo" /&gt;

  &lt;bean id="mongoTemplate" class="org.springframework.data.mongodb.core.MongoTemplate"&gt;
    &lt;constructor-arg ref="mongo" /&gt;
    &lt;constructor-arg value="databaseName" /&gt;
  &lt;/bean&gt;

  &lt;mongo:repositories base-package="com.acme.*.repositories" /&gt;

&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This namespace element will cause the base packages to be scanned for interfaces extending <code>MongoRepository</code> and create Spring beans for each of them found. By default the repositories will get a <code>MongoTemplate</code> Spring bean wired that is called <code>mongoTemplate</code>, so you only need to configure <code>mongo-template-ref</code> explicitly if you deviate from this convention.</p>
</div>
<div class="paragraph">
<p>If you&#8217;d rather like to go with JavaConfig use the <code>@EnableMongoRepositories</code> annotation. The annotation carries the very same attributes like the namespace element. If no base package is configured the infrastructure will scan the package of the annotated configuration class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">@Configuration
@EnableMongoRepositories
class ApplicationConfig extends AbstractMongoConfiguration {

  @Override
  protected String getDatabaseName() {
    return "e-store";
  }

  @Override
  public Mongo mongo() throws Exception {
    return new Mongo();
  }

  @Override
  protected String getMappingBasePackage() {
    return "com.oreilly.springdata.mongodb"
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As our domain repository extends <code>PagingAndSortingRepository</code> it provides you with CRUD operations as well as methods for paginated and sorted access to the entities. Working with the repository instance is just a matter of dependency injecting it into a client. So accessing the second page of `Person`s at a page size of 10 would simply look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration
public class PersonRepositoryTests {

    @Autowired PersonRepository repository;

    @Test
    public void readsFirstPageCorrectly() {

      Page&lt;Person&gt; persons = repository.findAll(new PageRequest(0, 10));
      assertThat(persons.isFirstPage(), is(true));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The sample creates an application context with Spring&#8217;s unit test support which will perform annotation based dependency injection into test cases. Inside the test method we simply use the repository to query the datastore. We hand the repository a <code>PageRequest</code> instance that requests the first page of persons at a page size of 10.</p>
</div>
</div>
<div class="sect2">
<h3 id="mongodb.repositories.queries">Query methods PersonRepository with query methods</h3>
<div class="paragraph">
<p>Most of the data access operations you usually trigger on a repository result a query being executed against the MongoDB databases. Defining such a query is just a matter of declaring a method on the repository interface</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public interface PersonRepository extends PagingAndSortingRepository&lt;Person, String&gt; {

    List&lt;Person&gt; findByLastname(String lastname);

    Page&lt;Person&gt; findByFirstname(String firstname, Pageable pageable);

    Person findByShippingAddresses(Address address);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first method shows a query for all people with the given lastname. The query will be derived parsing the method name for constraints which can be concatenated with  and . Thus the method name will result in a query expression of`{"lastname" : lastname}<code>. The second example shows how pagination is applied to a query. Just equip your method signature with a `Pageable</code> parameter and let the method return a <code>Page</code> instance and we will automatically page the query accordingly. The third examples shows that you can query based on properties which are not a primitive type.</p>
</div>
<div class="paragraph">
<p>Note that for version 1.0 we currently don&#8217;t support referring to parameters that are mapped as <code>DBRef</code> in the domain class.</p>
</div>
<div class="sect3">
<h4 id="mongodb.repositories.queries.delete">Repository delete queries <code>Delete…By</code> Query</h4>
<div class="paragraph">
<p>The above keywords can be used in conjunciton with <code>delete…By</code> or <code>remove…By</code> to create queries deleting matching documents.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public interface PersonRepository extends MongoRepository&lt;Person, String&gt; {
  List &lt;Person&gt; deleteByLastname(String lastname);

  Long deletePersonByLastname(String lastname);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using return type <code>List</code> will retrieve and return all matching documents before actually deleting them. A numeric return type directly removes the matching documents returning the total number of documents removed.</p>
</div>
</div>
<div class="sect3">
<h4 id="mongodb.repositories.queries.geo-spatial">Geo-spatial repository queries Advanced <code>Near</code> queries Using <code>Distance</code> with <code>Metrics</code></h4>
<div class="paragraph">
<p>As you&#8217;ve just seen there are a few keywords triggering geo-spatial operations within a MongoDB query. The <code>Near</code> keyword allows some further modification. Let&#8217;s have look at some examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public interface PersonRepository extends MongoRepository&lt;Person, String&gt;

  // { 'location' : { '$near' : [point.x, point.y], '$maxDistance' : distance}}
  List&lt;Person&gt; findByLocationNear(Point location, Distance distance);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Adding a <code>Distance</code> parameter to the query method allows restricting results to those within the given distance. If the <code>Distance</code> was set up containing a <code>Metric</code> we will transparently use <code>$nearSphere</code> instead of $code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">Point point = new Point(43.7, 48.8);
Distance distance = new Distance(200, Metrics.KILOMETERS);
… = repository.findByLocationNear(point, distance);
// {'location' : {'$nearSphere' : [43.7, 48.8], '$maxDistance' : 0.03135711885774796}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see using a <code>Distance</code> equipped with a <code>Metric</code> causes <code>$nearSphere</code> clause to be added instead of a plain <code>$near</code>. Beyond that the actual distance gets calculated according to the <code>Metrics</code> used.</p>
</div>
<div class="sect4">
<h5 id="geo_near_queries">Geo-near queries</h5>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public interface PersonRepository extends MongoRepository&lt;Person, String&gt;

  // {'geoNear' : 'location', 'near' : [x, y] }
  GeoResults&lt;Person&gt; findByLocationNear(Point location);

  // No metric: {'geoNear' : 'person', 'near' : [x, y], maxDistance : distance }
  // Metric: {'geoNear' : 'person', 'near' : [x, y], 'maxDistance' : distance,
  //          'distanceMultiplier' : metric.multiplier, 'spherical' : true }
  GeoResults&lt;Person&gt; findByLocationNear(Point location, Distance distance);

  // {'geoNear' : 'location', 'near' : [x, y] }
  GeoResults&lt;Person&gt; findByLocationNear(Point location);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongodb.repositories.queries.json-based">MongoDB JSON based query methods and field restriction</h4>
<div class="paragraph">
<p>By adding the annotation <code>org.springframework.data.mongodb.repository.Query</code> repository finder methods you can specify a MongoDB JSON query string to use instead of having the query derived from the method name. For example</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public interface PersonRepository extends MongoRepository&lt;Person, String&gt;

  @Query("{ 'firstname' : ?0 }")
  List&lt;Person&gt; findByThePersonsFirstname(String firstname);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The placeholder ?0 lets you substitute the value from the method arguments into the JSON query string.</p>
</div>
<div class="paragraph">
<p>You can also use the filter property to restrict the set of properties that will be mapped into the Java object. For example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public interface PersonRepository extends MongoRepository&lt;Person, String&gt;

  @Query(value="{ 'firstname' : ?0 }", fields="{ 'firstname' : 1, 'lastname' : 1}")
  List&lt;Person&gt; findByThePersonsFirstname(String firstname);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will return only the firstname, lastname and Id properties of the Person objects. The age property, a java.lang.Integer, will not be set and its value will therefore be null.</p>
</div>
</div>
<div class="sect3">
<h4 id="mongodb.repositories.queries.type-safe">Type-safe Query methods</h4>
<div class="paragraph">
<p>MongoDB repository support integrates with the <a href="http://www.querydsl.com/">QueryDSL</a> project which provides a means to perform type-safe queries in Java. To quote from the project description, "Instead of writing queries as inline strings or externalizing them into XML files they are constructed via a fluent API." It provides the following features</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Code completion in IDE (all properties, methods and operations can be expanded in your favorite Java IDE)</p>
</li>
<li>
<p>Almost no syntactically invalid queries allowed (type-safe on all levels)</p>
</li>
<li>
<p>Domain types and properties can be referenced safely (no Strings involved!)</p>
</li>
<li>
<p>Adopts better to refactoring changes in domain types</p>
</li>
<li>
<p>Incremental query definition is easier</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Please refer to the QueryDSL documentation which describes how to bootstrap your environment for APT based code generation <a href="http://source.mysema.com/static/querydsl/2.1.2/reference/html/ch02.html#d0e112">using Maven</a> or <a href="http://source.mysema.com/static/querydsl/2.1.2/reference/html/ch02.html#d0e131">using Ant</a>.</p>
</div>
<div class="paragraph">
<p>Using QueryDSL you will be able to write queries as shown below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">QPerson person = new QPerson("person");
List&lt;Person&gt; result = repository.findAll(person.address.zipCode.eq("C0123"));

Page&lt;Person&gt; page = repository.findAll(person.lastname.contains("a"),
                                       new PageRequest(0, 2, Direction.ASC, "lastname"));</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>QPerson</code> is a class that is generated (via the Java annotation post processing tool) which is a <code>Predicate</code> that allows you to write type safe queries. Notice that there are no strings in the query other than the value "C0123".</p>
</div>
<div class="paragraph">
<p>You can use the generated <code>Predicate</code> class via the interface <code>QueryDslPredicateExecutor</code> which is shown below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public interface QueryDslPredicateExecutor&lt;T&gt; {

  T findOne(Predicate predicate);

  List&lt;T&gt; findAll(Predicate predicate);

  List&lt;T&gt; findAll(Predicate predicate, OrderSpecifier&lt;?&gt;... orders);

  Page&lt;T&gt; findAll(Predicate predicate, Pageable pageable);

  Long count(Predicate predicate);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use this in your repository implementation, simply inherit from it in addition to other repository interfaces. This is shown below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public interface PersonRepository extends MongoRepository&lt;Person, String&gt;, QueryDslPredicateExecutor&lt;Person&gt; {

   // additional finder methods go here

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We think you will find this an extremely powerful tool for writing MongoDB queries.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongodb.repositories.misc">Miscellaneous</h3>
<div class="sect3">
<h4 id="mongodb.repositories.misc.cdi-integration">CDI Integration</h4>
<div class="paragraph">
<p>Instances of the repository interfaces are usually created by a container, which Spring is the most natural choice when working with Spring Data. As of version 1.3.0 Spring Data MongoDB ships with a custom CDI extension that allows using the repository abstraction in CDI environments. The extension is part of the JAR so all you need to do to activate it is dropping the Spring Data MongoDB JAR into your classpath. You can now set up the infrastructure by implementing a CDI Producer for the <code>MongoTemplate</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">class MongoTemplateProducer {

    @Produces
    @ApplicationScoped
    public MongoOperations createMongoTemplate() throws UnknownHostException, MongoException {

        MongoDbFactory factory = new SimpleMongoDbFactory(new Mongo(), "database");
        return new MongoTemplate(factory);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Spring Data MongoDB CDI extension will pick up the <code>MongoTemplate</code> available as CDI bean and create a proxy for a Spring Data repository whenever an bean of a repository type is requested by the container. Thus obtaining an instance of a Spring Data repository is a matter of declaring an <code>@Inject</code>-ed property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">class RepositoryClient {

  @Inject
  PersonRepository repository;

  public void businessMethod() {

    List&lt;Person&gt; people = repository.findAll();
  }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mapping-chapter">Mapping</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Rich mapping support is provided by the <code>MongoMappingConverter</code>. <code>MongoMappingConverter</code> has a rich metadata model that provides a full feature set of functionality to map domain objects to MongoDB documents.The mapping metadata model is populated using annotations on your domain objects. However, the infrastructure is not limited to using annotations as the only source of metadata information. The <code>MongoMappingConverter</code> also allows you to map objects to documents without providing any additional metadata, by following a set of conventions.</p>
</div>
<div class="paragraph">
<p>In this section we will describe the features of the MongoMappingConverter. How to use conventions for mapping objects to documents and how to override those conventions with annotation based mapping metadata.</p>
</div>
<div class="paragraph">
<p>NOTE:
<code>SimpleMongoConverter</code> has been deprecated in Spring Data MongoDB M3 as all of its functionality has been subsumed into <code>MappingMongoConverter</code>.</p>
</div>
<div class="sect2">
<h3 id="mapping-conventions">Convention based Mapping</h3>
<div class="paragraph">
<p><code>MongoMappingConverter</code> has a few conventions for mapping objects to documents when no additional mapping metadata is provided. The conventions are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The short Java class name is mapped to the collection name in the following manner. The class <em><code>com.bigbank.SavingsAccount</code></em> maps to '' collection name.</p>
</li>
<li>
<p>All nested objects are stored as nested objects in the document and <strong>not</strong> as DBRefs</p>
</li>
<li>
<p>The converter will use any Spring Converters registered with it to override the default mapping of object properties to document field/values.</p>
</li>
<li>
<p>The fields of an object are used to convert to and from fields in the document. Public JavaBean properties are not used.</p>
</li>
<li>
<p>You can have a single non-zero argument constructor whose constructor argument names match top level field names of document, that constructor will be used. Otherwise the zero arg constructor will be used. if there is more than one non-zero argument constructor an exception will be thrown.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="mapping.conventions.id-field">How the <em>_id</em> field is handled in the mapping layer</h4>
<div class="paragraph">
<p>MongoDB requires that you have an <em>_id</em> field for all documents. If you don&#8217;t provide one the driver will assign a ObjectId with a generated value. The "_id" field can be of any type the, other than arrays, so long as it is unique. The driver naturally supports all primitive types and Dates. When using the <code>MongoMappingConverter</code> there are certain rules that govern how properties from the Java class is mapped to this <em>_id</em> field.</p>
</div>
<div class="paragraph">
<p>The following outlines what field will be mapped to the <em>_id</em> document field:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A field annotated with <code>@Id</code> (<code>org.springframework.data.annotation.Id</code>) will be mapped to the <em>_id</em> field.</p>
</li>
<li>
<p>A field without an annotation but named <code>id</code> will be mapped to the <em>_id</em> field.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following outlines what type conversion, if any, will be done on the property mapped to the _id document field.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If a field named <em>id</em> is declared as a String or BigInteger in the Java class it will be converted to and stored as an ObjectId if possible. ObjectId as a field type is also valid. If you specify a value for <em>id</em> in your application, the conversion to an ObjectId is detected to the MongoDBdriver. If the specified <em>id</em> value cannot be converted to an ObjectId, then the value will be stored as is in the document&#8217;s _id field.</p>
</li>
<li>
<p>If a field named ' id&#8217; id field is not declared as a String, BigInteger, or ObjectID in the Java class then you should assign it a value in your application so it can be stored <em>as-is</em> in the document&#8217;s _id field.</p>
</li>
<li>
<p>If no field named <em>id</em> is present in the Java class then an implicit <em>_id</em> file will be generated by the driver but not mapped to a property or field of the Java class.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When querying and updating <code>MongoTemplate</code> will use the converter to handle conversions of the <code>Query</code> and <code>Update</code> objects that correspond to the above rules for saving documents so field names and types used in your queries will be able to match what is in your domain classes.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mapping-configuration">Mapping Configuration</h3>
<div class="paragraph">
<p>Unless explicitly configured, an instance of <code>MongoMappingConverter</code> is created by default when creating a <code>MongoTemplate</code>. You can create your own instance of the <code>MappingMongoConverter</code> so as to tell it where to scan the classpath at startup your domain classes in order to extract metadata and construct indexes. Also, by creating your own instance you can register Spring converters to use for mapping specific classes to and from the database.</p>
</div>
<div class="paragraph">
<p>You can configure the <code>MongoMappingConverter</code> as well as <code>com.mongodb.Mongo</code> and MongoTemplate either using Java or XML based metadata. Here is an example using Spring&#8217;s Java based configuration</p>
</div>
<div class="sect3">
<h4 id="configuration_class_to_configure_mongodb_mapping_support">@Configuration class to configure MongoDB mapping support</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">@Configuration
public class GeoSpatialAppConfig extends AbstractMongoConfiguration {

  @Bean
  public Mongo mongo() throws Exception {
    return new Mongo("localhost");
  }

  @Override
  public String getDatabaseName() {
    return "database";
  }

  @Override
  public String getMappingBasePackage() {
    return "com.bigbank.domain";
  }

  // the following are optional


  @Bean
  @Override
  public CustomConversions customConversions() throws Exception {
    List&lt;Converter&lt;?, ?&gt;&gt; converterList = new ArrayList&lt;Converter&lt;?, ?&gt;&gt;();
    converterList.add(new org.springframework.data.mongodb.test.PersonReadConverter());
    converterList.add(new org.springframework.data.mongodb.test.PersonWriteConverter());
    return new CustomConversions(converterList);
  }

  @Bean
  public LoggingEventListener&lt;MongoMappingEvent&gt; mappingEventsListener() {
    return new LoggingEventListener&lt;MongoMappingEvent&gt;();
  }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>AbstractMongoConfiguration</code> requires you to implement methods that define a <code>com.mongodb.Mongo</code> as well as provide a database name. <code>AbstractMongoConfiguration</code> also has a method you can override named <em><code>getMappingBasePackage</code></em> which tells the converter where to scan for classes annotated with the <code>@org.springframework.data.mongodb.core.mapping.Document</code> annotation.</p>
</div>
<div class="paragraph">
<p>You can add additional converters to the converter by overriding the method afterMappingMongoConverterCreation. Also shown in the above example is a <code>LoggingEventListener</code> which logs <code>MongoMappingEvent`s that are posted onto Spring's `ApplicationContextEvent</code> infrastructure.</p>
</div>
<div class="paragraph">
<p>NOTE:
AbstractMongoConfiguration will create a MongoTemplate instance and registered with the container under the name <em>mongoTemplate</em>.</p>
</div>
<div class="paragraph">
<p>You can also override the method  to provide the username and password information to connect to the database.</p>
</div>
<div class="paragraph">
<p>Spring&#8217;s MongoDB namespace enables you to easily enable mapping functionality in XML</p>
</div>
</div>
<div class="sect3">
<h4 id="xml_schema_to_configure_mongodb_mapping_support">XML schema to configure MongoDB mapping support</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:mongo="http://www.springframework.org/schema/data/mongo"
       xsi:schemaLocation="http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.0.xsd
           http://www.springframework.org/schema/data/mongo http://www.springframework.org/schema/data/mongo/spring-mongo-1.0.xsd
           http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd"&gt;

  &lt;!-- Default bean name is 'mongo' --&gt;
  &lt;mongo:mongo host="localhost" port="27017"/&gt;

  &lt;mongo:db-factory dbname="database" mongo-ref="mongo"/&gt;

  &lt;!-- by default look for a Mongo object named 'mongo' - default name used for the converter is 'mappingConverter' --&gt;
  &lt;mongo:mapping-converter base-package="com.bigbank.domain"&gt;
    &lt;mongo:custom-converters&gt;
      &lt;mongo:converter ref="readConverter"/&gt;
      &lt;mongo:converter&gt;
        &lt;bean class="org.springframework.data.mongodb.test.PersonWriteConverter"/&gt;
      &lt;/mongo:converter&gt;
    &lt;/mongo:custom-converters&gt;
  &lt;/mongo:mapping-converter&gt;

  &lt;bean id="readConverter" class="org.springframework.data.mongodb.test.PersonReadConverter"/&gt;

  &lt;!-- set the mapping converter to be used by the MongoTemplate --&gt;
  &lt;bean id="mongoTemplate" class="org.springframework.data.mongodb.core.MongoTemplate"&gt;
    &lt;constructor-arg name="mongoDbFactory" ref="mongoDbFactory"/&gt;
    &lt;constructor-arg name="mongoConverter" ref="mappingConverter"/&gt;
  &lt;/bean&gt;

  &lt;bean class="org.springframework.data.mongodb.core.mapping.event.LoggingEventListener"/&gt;

&lt;/beans</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>base-package</code> property tells it where to scan for classes annotated with the <code>@org.springframework.data.mongodb.core.mapping.Document</code> annotation.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mapping-usage">Metadata based Mapping</h3>
<div class="paragraph">
<p>To take full advantage of the object mapping functionality inside the Spring Data/MongoDB support, you should annotate your mapped objects with the <code>@org.springframework.data.mongodb.core.mapping.Document</code> annotation. Although it is not necessary for the mapping framework to have this annotation (your POJOs will be mapped correctly, even without any annotations), it allows the classpath scanner to find and pre-process your domain objects to extract the necessary metadata. If you don&#8217;t use this annotation, your application will take a slight performance hit the first time you store a domain object because the mapping framework needs to build up its internal metadata model so it knows about the properties of your domain object and how to persist them.</p>
</div>
<div class="sect3">
<h4 id="example_domain_object">Example domain object</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">package com.mycompany.domain;

@Document
public class Person {

  @Id
  private ObjectId id;

  @Indexed
  private Integer ssn;

  private String firstName;

  @Indexed
  private String lastName;

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@Id</code> annotation tells the mapper which property you want to use for the MongoDB <code>_id</code> property and the <code>@Indexed</code> annotation tells the mapping framework to call <code>ensureIndex</code> on that property of your document, making searches faster.</p>
</div>
<div class="paragraph">
<p>Automatic index creation is only done for types annotated with <code>@Document</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="mapping-usage-annotations">Mapping annotation overview</h4>
<div class="paragraph">
<p>The MappingMongoConverter can use metadata to drive the mapping of objects to documents. An overview of the annotations is provided below</p>
</div>
<div class="ulist">
<ul>
<li>
<p>- applied at the field level to mark the field used for identiy purpose.</p>
</li>
<li>
<p>- applied at the class level to indicate this class is a candidate for mapping to the database. You can specify the name of the collection where the database will be stored.</p>
</li>
<li>
<p>- applied at the field to indicate it is to be stored using a com.mongodb.DBRef.</p>
</li>
<li>
<p>- applied at the field level to describe how to index the field.</p>
</li>
<li>
<p>- applied at the type level to declare Compound Indexes</p>
</li>
<li>
<p>- applied at the field level to describe how to geoindex the field.</p>
</li>
<li>
<p>- applied at the field level to mark the field to be included in the text index.</p>
</li>
<li>
<p>- applied at the field level to set the language override property for text index.</p>
</li>
<li>
<p>- by default all private fields are mapped to the document, this annotation excludes the field where it is applied from being stored in the database</p>
</li>
<li>
<p>- marks a given constructor - even a package protected one - to use when instantiating the object from the database. Constructor arguments are mapped by name to the key values in the retrieved DBObject.</p>
</li>
<li>
<p>- this annotation is part of the Spring Framework . Within the mapping framework it can be applied to constructor arguments. This lets you use a Spring Expression Language statement to transform a key&#8217;s value retrieved in the database before it is used to construct a domain object. In order to reference a property of a given document one has to use expressions like: <code>@Value("#root.myProperty")</code> where  refers to the root of the given document.</p>
</li>
<li>
<p>- applied at the field level and described the name of the field as it will be represented in the MongoDB BSON document thus allowing the name to be different than the fieldname of the class.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The mapping metadata infrastructure is defined in a seperate spring-data-commons project that is technology agnostic. Specific subclasses are using in the MongoDB support to support annotation based metadata. Other strategies are also possible to put in place if there is demand.</p>
</div>
<div class="paragraph">
<p>Here is an example of a more complex mapping.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">@Document
@CompoundIndexes({
    @CompoundIndex(name = "age_idx", def = "{'lastName': 1, 'age': -1}")
})
public class Person&lt;T extends Address&gt; {

  @Id
  private String id;

  @Indexed(unique = true)
  private Integer ssn;

  @Field("fName")
  private String firstName;

  @Indexed
  private String lastName;

  private Integer age;

  @Transient
  private Integer accountTotal;

  @DBRef
  private List&lt;Account&gt; accounts;

  private T address;


  public Person(Integer ssn) {
    this.ssn = ssn;
  }

  @PersistenceConstructor
  public Person(Integer ssn, String firstName, String lastName, Integer age, T address) {
    this.ssn = ssn;
    this.firstName = firstName;
    this.lastName = lastName;
    this.age = age;
    this.address = address;
  }

  public String getId() {
    return id;
  }

 // no setter for Id.  (getter is only exposed for some unit testing)

  public Integer getSsn() {
    return ssn;
  }


// other getters/setters ommitted</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mapping-custom-object-construction">Customized Object Construction</h4>
<div class="paragraph">
<p>The mapping subsystem allows the customization of the object construction by annotating a constructor with the  annotation. The values to be used for the constructor parameters are resolved in the following way:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If a parameter is annotated with the <code>@Value</code> annotation, the given expression is evaluated and the result is used as the parameter value.</p>
</li>
<li>
<p>If the Java type has a property whose name matches the given field of the input document, then it&#8217;s property information is used to select the appropriate constructor parameter to pass the input field value to. This works only if the parameter name information is present in the java .class files which can be achieved by compiling the source with debug information or using the new  command-line switch for javac in Java 8.</p>
</li>
<li>
<p>Otherwise an <code>MappingException</code> will be thrown indicating that the given constructor parameter could not be bound.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">class OrderItem {

  private @Id String id;
  private int quantity;
  private double unitPrice;

  OrderItem(String id, @Value("#root.qty ?: 0") int quantity, double unitPrice) {
    this.id = id;
    this.quantity = quantity;
    this.unitPrice = unitPrice;
  }

  // getters/setters ommitted
}

DBObject input = new BasicDBObject("id", "4711");
input.put("unitPrice", 2.5);
input.put("qty",5);
OrderItem item = converter.read(OrderItem.class, input);</code></pre>
</div>
</div>
<div class="paragraph">
<p>NOTE:
The SpEL expression in the  annotation of the  parameter falls back to the value  if the given property path cannot be resolved.</p>
</div>
<div class="paragraph">
<p>Additional examples for using the <code>@PersistenceConstructor</code> annotation can be found in the <a href="https://github.com/spring-projects/spring-data-mongodb/blob/master/spring-data-mongodb/src/test/java/org/springframework/data/mongodb/core/convert/MappingMongoConverterUnitTests.java">MappingMongoConverterUnitTests</a> test suite.</p>
</div>
</div>
<div class="sect3">
<h4 id="mapping-usage-indexes.compound-index">Compound Indexes</h4>
<div class="paragraph">
<p>Compound indexes are also supported. They are defined at the class level, rather than on indidvidual properties.</p>
</div>
<div class="paragraph">
<p>NOTE:
Compound indexes are very important to improve the performance of queries that involve criteria on multiple fields</p>
</div>
<div class="paragraph">
<p>Here&#8217;s an example that creates a compound index of <code>lastName</code> in ascending order and <code>age</code> in descending order:</p>
</div>
<div class="sect5">
<h6 id="example_compound_index_usage">Example Compound Index Usage</h6>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">package com.mycompany.domain;

@Document
@CompoundIndexes({
    @CompoundIndex(name = "age_idx", def = "{'lastName': 1, 'age': -1}")
})
public class Person {

  @Id
  private ObjectId id;
  private Integer age;
  private String firstName;
  private String lastName;

}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mapping-usage-indexes.text-index">Text Indexes</h4>
<div class="paragraph">
<p>NOTE:
The text index feature is disabled by default for mongodb v.2.4.</p>
</div>
<div class="paragraph">
<p>Creating a text index allows to accumulate several fields into a searchable full text index. It is only possible to have one text index per collection so all fields marked with <code>@TextIndexed</code> are combined into this index. Properties can be weighted to influence document score for ranking results. The default language for the text index is english, to change the default language set <code>@Document(language="spanish")</code> to any language you want. Using a property called  or <code>@Language</code> allows to define a language override on a per document base.</p>
</div>
<div class="sect4">
<h5 id="example_text_index_usage">Example Text Index Usage</h5>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">@Document(language = "spanish")
class SomeEntity {

    @TextIndexed String foo;

    @Language String lang;

    Nested nested;


}

class Nested {

    @TextIndexed(weight=5) String bar;

    String roo;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mapping-usage-references">Using DBRefs</h4>
<div class="paragraph">
<p>The mapping framework doesn&#8217;t have to store child objects embedded within the document. You can also store them separately and use a DBRef to refer to that document. When the object is loaded from MongoDB, those references will be eagerly resolved and you will get back a mapped object that looks the same as if it had been stored embedded within your master document.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s an example of using a DBRef to refer to a specific document that exists independently of the object in which it is referenced (both classes are shown in-line for brevity&#8217;s sake):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">@Document
public class Account {

  @Id
  private ObjectId id;
  private Float total;

}

@Document
public class Person {

  @Id
  private ObjectId id;
  @Indexed
  private Integer ssn;
  @DBRef
  private List&lt;Account&gt; accounts;

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There&#8217;s no need to use something like <code>@OneToMany</code> because the mapping framework sees that you&#8217;re wanting a one-to-many relationship because there is a List of objects. When the object is stored in MongoDB, there will be a list of DBRefs rather than the <code>Account</code> objects themselves.</p>
</div>
<div class="paragraph">
<p>The mapping framework does not handle cascading saves. If you change an <code>Account</code> object that is referenced by a <code>Person</code> object, you must save the Account object separately. Calling <code>save</code> on the <code>Person</code> object will not automatically save the <code>Account</code> objects in the property <code>accounts</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="mapping-usage-events">Mapping Framework Events</h4>
<div class="paragraph">
<p>Events are fired throughout the lifecycle of the mapping process. This is described in the <a href="#mongodb.mapping-usage.events">Lifecycle Events</a> section.</p>
</div>
<div class="paragraph">
<p>Simply declaring these beans in your Spring ApplicationContext will cause them to be invoked whenever the event is dispatched.</p>
</div>
</div>
<div class="sect3">
<h4 id="mapping-explicit-converters">Overriding Mapping with explicit Converters</h4>
<div class="paragraph">
<p>When storing and querying your objects it is convenient to have a <code>MongoConverter</code> instance handle the mapping of all Java types to DBObjects. However, sometimes you may want the <code>MongoConverter</code>'s do most of the work but allow you to selectivly handle the conversion for a particular type or to optimize performance.</p>
</div>
<div class="paragraph">
<p>To selectivly handle the conversion yourself, register one or more one or more <code>org.springframework.core.convert.converter.Converter</code> instances with the MongoConverter.</p>
</div>
<div class="paragraph">
<p>NOTE:
Spring 3.0 introduced a core.convert package that provides a general type conversion system. This is described in detail in the Spring reference documentation section entitled <a href="http://docs.spring.io/spring/docs/3.2.x/spring-framework-reference/html/validation.html#core-convert">Spring 3 Type Conversion</a>.</p>
</div>
<div class="paragraph">
<p>The method <code>customConversions</code> in <code>AbstractMongoConfiguration</code> can be used to configure Converters. The examples <a href="#mapping-configuration">here</a> at the begining of this chapter show how to perform the configuration using Java and XML.</p>
</div>
<div class="paragraph">
<p>Below is an example of a Spring Converter implementation that converts from a DBObject to a Person POJO.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">@ReadingConverter
 public class PersonReadConverter implements Converter&lt;DBObject, Person&gt; {

  public Person convert(DBObject source) {
    Person p = new Person((ObjectId) source.get("_id"), (String) source.get("name"));
    p.setAge((Integer) source.get("age"));
    return p;
  }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is an example that converts from a Person to a DBObject.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">@WritingConverter
public class PersonWriteConverter implements Converter&lt;Person, DBObject&gt; {

  public DBObject convert(Person source) {
    DBObject dbo = new BasicDBObject();
    dbo.put("_id", source.getId());
    dbo.put("name", source.getFirstName());
    dbo.put("age", source.getAge());
    return dbo;
  }

}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mongo.cross.store">Cross Store support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Sometimes you need to store data in multiple data stores and these data stores can be of different types. One might be relational while the other a document store. For this use case we have created a separate module in the MongoDB support that handles what we call cross-store support. The current implementation is based on JPA as the driver for the relational database and we allow select fields in the Entities to be stored in a Mongo database. In addition to allowing you to store your data in two stores we also coordinate persistence operations for the non-transactional MongoDB store with the transaction life-cycle for the relational database.</p>
</div>
<div class="sect2">
<h3 id="mongodb_cross-store-configuration">Cross Store Configuration Example Maven pom.xml with spring-data-mongodb-cross-store dependency Example Maven pom.xml with AspectJ plugin enabled Example application context with MongoDB and cross-store aspect support</h3>
<div class="paragraph">
<p>Assuming that you have a working JPA application and would like to add some cross-store persistence for MongoDB. What do you have to add to your configuration?</p>
</div>
<div class="paragraph">
<p>First of all you need to add a dependency on the  module. Using Maven this is done by adding a dependency to your pom:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

...

    &lt;!-- Spring Data --&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.data&lt;/groupId&gt;
      &lt;artifactId&gt;spring-data-mongodb-cross-store&lt;/artifactId&gt;
      &lt;version&gt;${spring.data.mongo.version}&lt;/version&gt;
    &lt;/dependency&gt;


...

&lt;/project&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once this is done we need to enable AspectJ for the project. The cross-store support is implemented using AspectJ aspects so by enabling compile time AspectJ support the cross-store features will become available to your project. In Maven you would add an additional plugin to the &lt;build&gt; section of the pom:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

...

  &lt;build&gt;
    &lt;plugins&gt;

      ...

      &lt;plugin&gt;
        &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
        &lt;artifactId&gt;aspectj-maven-plugin&lt;/artifactId&gt;
        &lt;version&gt;1.0&lt;/version&gt;
        &lt;dependencies&gt;
          &lt;!-- NB: You must use Maven 2.0.9 or above or these are ignored (see MNG-2972) --&gt;
          &lt;dependency&gt;
            &lt;groupId&gt;org.aspectj&lt;/groupId&gt;
            &lt;artifactId&gt;aspectjrt&lt;/artifactId&gt;
            &lt;version&gt;${aspectj.version}&lt;/version&gt;
          &lt;/dependency&gt;
          &lt;dependency&gt;
            &lt;groupId&gt;org.aspectj&lt;/groupId&gt;
            &lt;artifactId&gt;aspectjtools&lt;/artifactId&gt;
            &lt;version&gt;${aspectj.version}&lt;/version&gt;
          &lt;/dependency&gt;
        &lt;/dependencies&gt;
        &lt;executions&gt;
          &lt;execution&gt;
            &lt;goals&gt;
              &lt;goal&gt;compile&lt;/goal&gt;
              &lt;goal&gt;test-compile&lt;/goal&gt;
            &lt;/goals&gt;
          &lt;/execution&gt;
        &lt;/executions&gt;
        &lt;configuration&gt;
          &lt;outxml&gt;true&lt;/outxml&gt;
          &lt;aspectLibraries&gt;
            &lt;aspectLibrary&gt;
              &lt;groupId&gt;org.springframework&lt;/groupId&gt;
              &lt;artifactId&gt;spring-aspects&lt;/artifactId&gt;
            &lt;/aspectLibrary&gt;
            &lt;aspectLibrary&gt;
              &lt;groupId&gt;org.springframework.data&lt;/groupId&gt;
              &lt;artifactId&gt;spring-data-mongodb-cross-store&lt;/artifactId&gt;
            &lt;/aspectLibrary&gt;
          &lt;/aspectLibraries&gt;
          &lt;source&gt;1.6&lt;/source&gt;
          &lt;target&gt;1.6&lt;/target&gt;
        &lt;/configuration&gt;
      &lt;/plugin&gt;

      ...

    &lt;/plugins&gt;
  &lt;/build&gt;

...

&lt;/project&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, you need to configure your project to use MongoDB and also configure the aspects that are used. The following XML snippet should be added to your application context:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:jdbc="http://www.springframework.org/schema/jdbc"
  xmlns:jpa="http://www.springframework.org/schema/data/jpa"
  xmlns:mongo="http://www.springframework.org/schema/data/mongo"
  xsi:schemaLocation="http://www.springframework.org/schema/data/mongo
    http://www.springframework.org/schema/data/mongo/spring-mongo.xsd
    http://www.springframework.org/schema/jdbc
    http://www.springframework.org/schema/jdbc/spring-jdbc-3.0.xsd
    http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
    http://www.springframework.org/schema/data/jpa
    http://www.springframework.org/schema/data/jpa/spring-jpa-1.0.xsd"&gt;

  ...

  &lt;!--  Mongo config --&gt;
  &lt;mongo:mongo host="localhost" port="27017"/&gt;

  &lt;bean id="mongoTemplate" class="org.springframework.data.mongodb.core.MongoTemplate"&gt;
    &lt;constructor-arg name="mongo" ref="mongo"/&gt;
    &lt;constructor-arg name="databaseName" value="test"/&gt;
    &lt;constructor-arg name="defaultCollectionName" value="cross-store"/&gt;
  &lt;/bean&gt;

  &lt;bean class="org.springframework.data.mongodb.core.MongoExceptionTranslator"/&gt;

  &lt;!--  Mongo cross-store aspect config --&gt;
  &lt;bean class="org.springframework.data.persistence.document.mongo.MongoDocumentBacking"
        factory-method="aspectOf"&gt;
    &lt;property name="changeSetPersister" ref="mongoChangeSetPersister"/&gt;
  &lt;/bean&gt;
  &lt;bean id="mongoChangeSetPersister"
      class="org.springframework.data.persistence.document.mongo.MongoChangeSetPersister"&gt;
    &lt;property name="mongoTemplate" ref="mongoTemplate"/&gt;
    &lt;property name="entityManagerFactory" ref="entityManagerFactory"/&gt;
  &lt;/bean&gt;

  ...

&lt;/beans&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongodb_cross-store-application">Writing the Cross Store Application Example of Entity with @RelatedDocument Example of domain class to be stored as document Example of code using the JPA Entity configured for cross-store persistence Example of JSON document stored in MongoDB</h3>
<div class="paragraph">
<p>We are assuming that you have a working JPA application so we will only cover the additional steps needed to persist part of your Entity in your Mongo database. First you need to identify the field you want persisted. It should be a domain class and follow the general rules for the Mongo mapping support covered in previous chapters. The field you want persisted in MongoDB should be annotated using the <code>@RelatedDocument</code> annotation. That is really all you need to do!. The cross-store aspects take care of the rest. This includes marking the field with @Transient so it won&#8217;t be persisted using JPA, keeping track of any changes made to the field value and writing them to the database on successful transaction completion, loading the document from MongoDB the first time the value is used in your application. Here is an example of a simple Entity that has a field annotated with @RelatedEntity.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">@Entity
public class Customer {

  @Id
  @GeneratedValue(strategy = GenerationType.IDENTITY)
  private Long id;

  private String firstName;

  private String lastName;

  @RelatedDocument
  private SurveyInfo surveyInfo;

  // getters and setters omitted

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public class SurveyInfo {

  private Map&lt;String, String&gt; questionsAndAnswers;

  public SurveyInfo() {
    this.questionsAndAnswers = new HashMap&lt;String, String&gt;();
  }

  public SurveyInfo(Map&lt;String, String&gt; questionsAndAnswers) {
    this.questionsAndAnswers = questionsAndAnswers;
  }

  public Map&lt;String, String&gt; getQuestionsAndAnswers() {
    return questionsAndAnswers;
  }

  public void setQuestionsAndAnswers(Map&lt;String, String&gt; questionsAndAnswers) {
    this.questionsAndAnswers = questionsAndAnswers;
  }

  public SurveyInfo addQuestionAndAnswer(String question, String answer) {
    this.questionsAndAnswers.put(question, answer);
    return this;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the SurveyInfo has been set on the Customer object above the MongoTemplate that was configured above is used to save the SurveyInfo along with some metadata about the JPA Entity is stored in a MongoDB collection named after the fully qualified name of the JPA Entity class. The following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">    Customer customer = new Customer();
    customer.setFirstName("Sven");
    customer.setLastName("Olafsen");
    SurveyInfo surveyInfo = new SurveyInfo()
      .addQuestionAndAnswer("age", "22")
      .addQuestionAndAnswer("married", "Yes")
      .addQuestionAndAnswer("citizenship", "Norwegian");
    customer.setSurveyInfo(surveyInfo);
    customerRepository.save(customer);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Executing the code above results in the following JSON document stored in MongoDB.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">{ "_id" : ObjectId( "4d9e8b6e3c55287f87d4b79e" ),
  "_entity_id" : 1,
  "_entity_class" : "org.springframework.data.mongodb.examples.custsvc.domain.Customer",
  "_entity_field_name" : "surveyInfo",
  "questionsAndAnswers" : { "married" : "Yes",
    "age" : "22",
    "citizenship" : "Norwegian" },
  "_entity_field_class" : "org.springframework.data.mongodb.examples.custsvc.domain.SurveyInfo" }</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mongo.logging">Logging support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>An appender for Log4j is provided in the maven module "spring-data-mongodb-log4j". Note, there is no dependency on other Spring Mongo modules, only the MongoDB driver.</p>
</div>
<div class="sect2">
<h3 id="mongodb:logging-configuration">MongoDB Log4j Configuration</h3>
<div class="paragraph">
<p>Here is an example configuration</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code>log4j.rootCategory=INFO, stdout

log4j.appender.stdout=org.springframework.data.document.mongodb.log4j.MongoLog4jAppender
log4j.appender.stdout.layout=org.apache.log4j.PatternLayout
log4j.appender.stdout.layout.ConversionPattern=%d %p [%c] - &lt;%m&gt;%n
log4j.appender.stdout.host = localhost
log4j.appender.stdout.port = 27017
log4j.appender.stdout.database = logs
log4j.appender.stdout.collectionPattern = %X{year}%X{month}
log4j.appender.stdout.applicationId = my.application
log4j.appender.stdout.warnOrHigherWriteConcern = FSYNC_SAFE

log4j.category.org.apache.activemq=ERROR
log4j.category.org.springframework.batch=DEBUG
log4j.category.org.springframework.data.document.mongodb=DEBUG
log4j.category.org.springframework.transaction=INFO</code></pre>
</div>
</div>
<div class="paragraph">
<p>The important configuration to look at aside from host and port is the database and collectionPattern. The variables year, month, day and hour are available for you to use in forming a collection name. This is to support the common convention of grouping log information in a collection that corresponds to a specific time period, for example a collection per day.</p>
</div>
<div class="paragraph">
<p>There is also an applicationId which is put into the stored message. The document stored from logging as the following keys: level, name, applicationId, timestamp, properties, traceback, and message.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mongo.jmx">JMX support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The JMX support for MongoDB exposes the results of executing the <em>serverStatus</em> command on the admin database for a single MongoDB server instance. It also exposes an administrative MBean, MongoAdmin which will let you perform administrative operations such as drop or create a database. The JMX features build upon the JMX feature set available in the Spring Framework. See <a href="http://docs.spring.io/spring/docs/3.2.x/spring-framework-reference/html/jmx.html">here </a> for more details.</p>
</div>
<div class="sect2">
<h3 id="mongodb:jmx-configuration">MongoDB JMX Configuration</h3>
<div class="paragraph">
<p>Spring&#8217;s Mongo namespace enables you to easily enable JMX functionality</p>
</div>
<div class="sect3">
<h4 id="xml_schema_to_configure_mongodb">XML schema to configure MongoDB</h4>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
        &lt;beans xmlns="http://www.springframework.org/schema/beans"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:context="http://www.springframework.org/schema/context"
        xmlns:mongo="http://www.springframework.org/schema/data/mongo"
        xsi:schemaLocation=
        "http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context-3.0.xsd
        http://www.springframework.org/schema/data/mongo
        http://www.springframework.org/schema/data/mongo/spring-mongo-1.0.xsd
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd"&gt;

&lt;beans&gt;

    &lt;!-- Default bean name is 'mongo' --&gt;
    &lt;mongo:mongo host="localhost" port="27017"/&gt;

    &lt;!-- by default look for a Mongo object named 'mongo' --&gt;
    &lt;mongo:jmx/&gt;

    &lt;context:mbean-export/&gt;

    &lt;!-- To translate any MongoExceptions thrown in @Repository annotated classes --&gt;
    &lt;context:annotation-config/&gt;

    &lt;bean id="registry" class="org.springframework.remoting.rmi.RmiRegistryFactoryBean" p:port="1099" /&gt;

    &lt;!-- Expose JMX over RMI --&gt;
    &lt;bean id="serverConnector" class="org.springframework.jmx.support.ConnectorServerFactoryBean"
        depends-on="registry"
        p:objectName="connector:name=rmi"
        p:serviceUrl="service:jmx:rmi://localhost/jndi/rmi://localhost:1099/myconnector" /&gt;

&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will expose several MBeans</p>
</div>
<div class="ulist">
<ul>
<li>
<p>AssertMetrics</p>
</li>
<li>
<p>BackgroundFlushingMetrics</p>
</li>
<li>
<p>BtreeIndexCounters</p>
</li>
<li>
<p>ConnectionMetrics</p>
</li>
<li>
<p>GlobalLoclMetrics</p>
</li>
<li>
<p>MemoryMetrics</p>
</li>
<li>
<p>OperationCounters</p>
</li>
<li>
<p>ServerInfo</p>
</li>
<li>
<p>MongoAdmin</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is shown below in a screenshot from JConsole</p>
</div>
<div class="imageblock">
<div class="content">
<img src="jconsole.png" alt="jconsole">
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix">Appendix</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="populator.namespace-reference">Appendix A: Namespace reference</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="populator.namespace-dao-config">The <code>&lt;repositories /&gt;</code> element</h3>
<div class="paragraph">
<p>The <code>&lt;repositories /&gt;</code> element triggers the setup of the Spring Data repository infrastructure. The most important attribute is <code>base-package</code> which defines the package to scan for Spring Data repository interfaces.<span class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnote_3" title="View footnote.">3</a>]</span></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 100%;">
<caption class="title">Table 3. Attributes</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>base-package</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the package to be used to be scanned for repository interfaces extending *Repository (actual interface is determined by specific Spring Data module) in auto detection mode. All packages below the configured package will be scanned, too. Wildcards are allowed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>repository-impl-postfix</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the postfix to autodetect custom repository implementations. Classes whose names end with the configured postfix will be considered as candidates. Defaults to <code>Impl</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>query-lookup-strategy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Determines the strategy to be used to create finder queries. See <a href="#repositories.query-methods.query-lookup-strategies">Query lookup strategies</a> for details. Defaults to <code>create-if-not-found</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>named-queries-location</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the location to look for a Properties file containing externally defined queries.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>consider-nested-repositories</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Controls whether nested repository interface definitions should be considered. Defaults to <code>false</code>.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="repository-query-keywords">Appendix B: Repository query keywords</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="supported_query_keywords">Supported query keywords</h3>
<div class="paragraph">
<p>The following table lists the keywords generally supported by the Spring Data repository query derivation mechanism. However, consult the store-specific documentation for the exact list of supported keywords, because some listed here might not be supported in a particular store.</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 100%;">
<caption class="title">Table 4. Query keywords</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Logical keyword</th>
<th class="tableblock halign-left valign-top">Keyword expressions</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AND</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>And</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OR</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Or</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AFTER</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>After</code>, <code>IsAfter</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BEFORE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Before</code>, <code>IsBefore</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CONTAINING</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Containing</code>, <code>IsContaining</code>, <code>Contains</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BETWEEN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Between</code>, <code>IsBetween</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ENDING_WITH</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>EndingWith</code>, <code>IsEndingWith</code>, <code>EndsWith</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>EXISTS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Exists</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FALSE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>False</code>, <code>IsFalse</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GREATER_THAN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GreaterThan</code>, <code>IsGreaterThan</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GREATER_THAN_EQUALS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GreaterThanEqual</code>, <code>IsGreaterThanEqual</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>In</code>, <code>IsIn</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Is</code>, <code>Equals</code>, (or no keyword)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IS_NOT_NULL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NotNull</code>, <code>IsNotNull</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IS_NULL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Null</code>, <code>IsNull</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LESS_THAN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LessThan</code>, <code>IsLessThan</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LESS_THAN_EQUAL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LessThanEqual</code>, <code>IsLessThanEqual</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LIKE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Like</code>, <code>IsLike</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NEAR</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Near</code>, <code>IsNear</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NOT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Not</code>, <code>IsNot</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NOT_IN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NotIn</code>, <code>IsNotIn</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NOT_LIKE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NotLike</code>, <code>IsNotLike</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>REGEX</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Regex</code>, <code>MatchesRegex</code>, <code>Matches</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>STARTING_WITH</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StartingWith</code>, <code>IsStartingWith</code>, <code>StartsWith</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TRUE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>True</code>, <code>IsTrue</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>WITHIN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Within</code>, <code>IsWithin</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnote_1">
<a href="#_footnoteref_1">1</a>. JavaConfig in the Spring reference documentation - <a href="{spring-framework-docs}/beans.html#beans-java">{spring-framework-docs}/beans.html#beans-java</a>
</div>
<div class="footnote" id="_footnote_2">
<a href="#_footnoteref_2">2</a>. Spring HATEOAS - <a href="https://github.com/SpringSource/spring-hateoas"><a href="https://github.com/SpringSource/spring-hateoas">https://github.com/SpringSource/spring-hateoas</a></a>
</div>
<div class="footnote" id="_footnote_3">
<a href="#_footnoteref_3">3</a>. see <a href="#repositories.create-instances.spring">XML configuration</a>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2014-08-04 14:48:07 CDT
</div>
</div>
</body>
</html>